# æœ¬åœ°å¼€å‘ç¯å¢ƒå¯åŠ¨ - é—®é¢˜æŠ¥å‘Š

**æ‰§è¡Œæ—¥æœŸ**ï¼š2025-10-30
**æ‰§è¡Œè€…**ï¼šè€ç‹ï¼ˆCodeBuddy Deploy Skillï¼‰
**ä»»åŠ¡å¡**ï¼š[ä»»åŠ¡å¡-æœ¬åœ°å¼€å‘ç¯å¢ƒå¯åŠ¨.md](./ä»»åŠ¡å¡-æœ¬åœ°å¼€å‘ç¯å¢ƒå¯åŠ¨.md)

---

## ğŸ“Š æ‰§è¡Œç»“æœæ€»è§ˆ

| é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Dockerå®¹å™¨å¯åŠ¨ | âœ… æˆåŠŸ | MySQLã€Redisã€MinIOå…¨éƒ¨healthy |
| åç«¯æœåŠ¡å¯åŠ¨ | âŒ å¤±è´¥ | ç¼ºå°‘shortidä¾èµ–åŒ… |
| å‰ç«¯æœåŠ¡å¯åŠ¨ | âš ï¸ é…ç½®ä¸å®Œæ•´ | .env.localç¼ºå°‘3ä¸ªå¿…éœ€å˜é‡ |

---

## ğŸ› å‘ç°çš„é—®é¢˜æ¸…å•

### âš ï¸ P0çº§é—®é¢˜ï¼ˆé˜»å¡å¯åŠ¨ï¼‰

#### é—®é¢˜1ï¼šåç«¯ç¼ºå°‘ shortid ä¾èµ–åŒ…

**é—®é¢˜æè¿°**ï¼š
- æ–‡ä»¶ï¼š[backend/src/services/distribution.service.js:3](../backend/src/services/distribution.service.js#L3)
- é”™è¯¯ï¼š`Error: Cannot find module 'shortid'`
- åç«¯æœåŠ¡å¯åŠ¨æ—¶å´©æºƒ

**é”™è¯¯æ—¥å¿—**ï¼š
```
Error: Cannot find module 'shortid'
Require stack:
- backend\src\services\distribution.service.js
- backend\src\controllers\distribution.controller.js
- backend\src\routes\distribution.routes.js
- backend\src\app.js
- backend\src\server.js
```

**æ ¹æœ¬åŸå› **ï¼š
- `distribution.service.js` ç¬¬3è¡Œå¼•å…¥äº† `const shortid = require('shortid');`
- ä½† `package.json` çš„ dependencies é‡Œæ²¡æœ‰ `shortid`
- å®é™…ä»£ç ç¬¬13-27è¡Œè‡ªå·±å®ç°äº†ç”Ÿæˆé‚€è¯·ç çš„é€»è¾‘ï¼Œæ ¹æœ¬ä¸éœ€è¦shortid

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ–¹æ¡ˆ1ï¼šåˆ é™¤å†—ä½™çš„importï¼ˆæ¨èï¼‰
# åˆ é™¤ backend/src/services/distribution.service.js ç¬¬3è¡Œçš„ shortid å¼•å…¥

# æ–¹æ¡ˆ2ï¼šå®‰è£…ä¾èµ–åŒ…ï¼ˆä¸æ¨èï¼Œå› ä¸ºä»£ç é‡Œæ²¡ç”¨åˆ°ï¼‰
cd backend && npm install shortid
```

**è´£ä»»æŠ€èƒ½åŒ…**ï¼š`backend_dev_skill`
**ä¼˜å…ˆçº§**ï¼šP0ï¼ˆæœ€é«˜ï¼Œé˜»å¡å¯åŠ¨ï¼‰

---

#### é—®é¢˜2ï¼šå‰ç«¯ .env.local é…ç½®ä¸å®Œæ•´

**é—®é¢˜æè¿°**ï¼š
- æ–‡ä»¶ï¼š[frontend/.env.local](../frontend/.env.local)
- ä»»åŠ¡å¡è¦æ±‚é…ç½®4ä¸ªç¯å¢ƒå˜é‡ï¼Œå®é™…åªé…ç½®äº†1ä¸ª
- ç¼ºå°‘3ä¸ªå¿…éœ€çš„ç¯å¢ƒå˜é‡

**å½“å‰é…ç½®**ï¼ˆä»…1ä¸ªï¼‰ï¼š
```bash
NEXT_PUBLIC_API_URL=http://localhost:3000/api
```

**ä»»åŠ¡å¡è¦æ±‚é…ç½®**ï¼ˆ4ä¸ªï¼‰ï¼š
```bash
NEXT_PUBLIC_API_URL=http://localhost:3000/api
NEXT_PUBLIC_COS_BUCKET=ai-photo-dev
NEXT_PUBLIC_COS_REGION=local
NEXT_PUBLIC_COS_IMAGE_DOMAIN=http://localhost:9000
```

**å½±å“èŒƒå›´**ï¼š
- å‰ç«¯æ— æ³•æ­£ç¡®è®¿é—®MinIOå¯¹è±¡å­˜å‚¨
- å›¾ç‰‡ä¸Šä¼ å’Œæ˜¾ç¤ºåŠŸèƒ½å¯èƒ½å¤±è´¥
- ç”¨æˆ·ä½“éªŒå—å½±å“

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
cd frontend
cat > .env.local << 'EOF'
# æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®
NEXT_PUBLIC_API_URL=http://localhost:3000/api
NEXT_PUBLIC_COS_BUCKET=ai-photo-dev
NEXT_PUBLIC_COS_REGION=local
NEXT_PUBLIC_COS_IMAGE_DOMAIN=http://localhost:9000
EOF
```

**è´£ä»»æŠ€èƒ½åŒ…**ï¼š`frontend_dev_skill`
**ä¼˜å…ˆçº§**ï¼šP0ï¼ˆé«˜ï¼Œå½±å“åŠŸèƒ½ï¼‰

---

### âœ… æˆåŠŸçš„éƒ¨åˆ†

#### Dockerå®¹å™¨çŠ¶æ€ï¼ˆå…¨éƒ¨healthyï¼‰

```bash
NAMES                STATUS                    PORTS
ai-photo-minio-dev   Up (healthy)              0.0.0.0:9000-9001->9000-9001/tcp
ai-photo-mysql-dev   Up 22 hours (healthy)     0.0.0.0:3306->3306/tcp
ai-photo-redis-dev   Up 22 hours (healthy)     0.0.0.0:6379->6379/tcp
```

#### æ•°æ®åº“è¿ç§»çŠ¶æ€

```bash
âœ… æ•°æ®åº“è¿ç§»å·²å®Œæˆï¼ˆAlready up to dateï¼‰
âœ… æ‰€æœ‰å¿…éœ€çš„è¡¨ç»“æ„å·²åˆ›å»º
âœ… MySQLè¿æ¥æ­£å¸¸
```

#### åç«¯ç¯å¢ƒå˜é‡é…ç½®

```bash
âœ… .env æ–‡ä»¶å·²æ­£ç¡®é…ç½®
âœ… æ•°æ®åº“è¿æ¥é…ç½®æ­£ç¡®
âœ… Redisè¿æ¥é…ç½®æ­£ç¡®
âœ… MinIOé…ç½®æ­£ç¡®
```

---

## ğŸ“ ä»»åŠ¡å¡é—®é¢˜åˆ†æ

### é—®é¢˜3ï¼šä»»åŠ¡å¡ä¸å®é™…æƒ…å†µä¸ç¬¦

**ä¸ç¬¦åˆç‚¹1ï¼šMinIOå®¹å™¨æœªè‡ªåŠ¨å¯åŠ¨**
- ä»»åŠ¡å¡æè¿°ï¼šæ‰§è¡Œ `docker-compose -f docker-compose.dev.yml up -d` ä¼šå¯åŠ¨å…¨éƒ¨3ä¸ªå®¹å™¨
- å®é™…æƒ…å†µï¼šåªå¯åŠ¨äº†MySQLå’ŒRedisï¼ŒMinIOéœ€è¦å•ç‹¬å¯åŠ¨
- å¯èƒ½åŸå› ï¼šMinIOé•œåƒæœªæå‰æ‹‰å–ï¼Œæˆ–é¦–æ¬¡å¯åŠ¨å¤±è´¥

**ä¸ç¬¦åˆç‚¹2ï¼šå‰ç«¯.env.localé…ç½®ä¸å®Œæ•´**
- ä»»åŠ¡å¡æ­¥éª¤8è¦æ±‚åˆ›å»ºåŒ…å«4ä¸ªå˜é‡çš„.env.local
- å®é™…æ–‡ä»¶åªæœ‰1ä¸ªå˜é‡
- å¯èƒ½åŸå› ï¼šä¹‹å‰æ‰‹åŠ¨åˆ›å»ºæ—¶æ¼äº†3ä¸ªå˜é‡

**å»ºè®®æ”¹è¿›**ï¼š
1. åœ¨docker-compose.dev.ymlä¸­æ·»åŠ å®¹å™¨ä¾èµ–å…³ç³»ï¼Œç¡®ä¿MinIOéšMySQLå’ŒRedisä¸€èµ·å¯åŠ¨
2. æä¾›ä¸€é”®è„šæœ¬è‡ªåŠ¨åˆ›å»ºæ­£ç¡®çš„.env.localæ–‡ä»¶
3. æ·»åŠ ç¯å¢ƒå˜é‡éªŒè¯è„šæœ¬ï¼Œå¯åŠ¨å‰æ£€æŸ¥é…ç½®å®Œæ•´æ€§

---

## ğŸ› ï¸ å¿«é€Ÿä¿®å¤æŒ‡å—

### ä¿®å¤æ­¥éª¤ï¼ˆé¡ºåºæ‰§è¡Œï¼‰

#### æ­¥éª¤1ï¼šä¿®å¤åç«¯shortidé—®é¢˜

```bash
# è¿›å…¥åç«¯ç›®å½•
cd backend

# ç¼–è¾‘æ–‡ä»¶åˆ é™¤ç¬¬3è¡Œçš„shortidå¼•å…¥
# åˆ é™¤è¿™è¡Œ: const shortid = require('shortid');
# æ–‡ä»¶è·¯å¾„: backend/src/services/distribution.service.js
```

#### æ­¥éª¤2ï¼šä¿®å¤å‰ç«¯ç¯å¢ƒå˜é‡

```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd frontend

# é‡æ–°åˆ›å»ºå®Œæ•´çš„.env.local
cat > .env.local << 'EOF'
# æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®
NEXT_PUBLIC_API_URL=http://localhost:3000/api
NEXT_PUBLIC_COS_BUCKET=ai-photo-dev
NEXT_PUBLIC_COS_REGION=local
NEXT_PUBLIC_COS_IMAGE_DOMAIN=http://localhost:9000
EOF
```

#### æ­¥éª¤3ï¼šé‡æ–°å¯åŠ¨æœåŠ¡

```bash
# ç»ˆç«¯1 - å¯åŠ¨åç«¯
cd backend
npm run dev

# ç»ˆç«¯2 - å¯åŠ¨å‰ç«¯
cd frontend
npm run dev
```

---

## ğŸ¯ éªŒæ”¶æµ‹è¯•å»ºè®®

ä¿®å¤åï¼Œå»ºè®®æ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### 1. åç«¯å¥åº·æ£€æŸ¥
```bash
curl http://localhost:3000/api/health
# é¢„æœŸï¼šè¿”å› {"status":"ok",...}
```

### 2. å‰ç«¯é¡µé¢è®¿é—®
```bash
# æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:3001
# é¢„æœŸï¼šé¡µé¢æ­£å¸¸åŠ è½½ï¼Œæ— æ§åˆ¶å°é”™è¯¯
```

### 3. ç¯å¢ƒå˜é‡éªŒè¯
```bash
# æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:3001
# æ‰“å¼€å¼€å‘è€…å·¥å…· > Console
# è¾“å…¥ï¼šconsole.log(process.env)
# æ£€æŸ¥ NEXT_PUBLIC_COS_BUCKET ç­‰å˜é‡æ˜¯å¦å­˜åœ¨
```

### 4. MinIOè¿æ¥æµ‹è¯•
```bash
# æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:9001
# ç”¨æˆ·åï¼šminioadmin
# å¯†ç ï¼šminioadmin123
# é¢„æœŸï¼šèƒ½ç™»å½•MinIOæ§åˆ¶å°
```

---

## ğŸ“‹ è´£ä»»åˆ†é…

| é—®é¢˜ | è´Ÿè´£æŠ€èƒ½åŒ… | ä¼˜å…ˆçº§ | é¢„è®¡ä¿®å¤æ—¶é—´ |
|------|-----------|--------|------------|
| é—®é¢˜1ï¼šåç«¯shortidä¾èµ– | `backend_dev_skill` | P0 | 5åˆ†é’Ÿ |
| é—®é¢˜2ï¼šå‰ç«¯ç¯å¢ƒå˜é‡ | `frontend_dev_skill` | P0 | 3åˆ†é’Ÿ |
| é—®é¢˜3ï¼šä»»åŠ¡å¡æ›´æ–° | `codebuddy_deploy_skill` | P1 | 10åˆ†é’Ÿ |

---

## ğŸ”„ åç»­æ”¹è¿›å»ºè®®

### 1. æ·»åŠ å¯åŠ¨å‰æ£€æŸ¥è„šæœ¬

åˆ›å»º `scripts/check-env.sh`ï¼š
```bash
#!/bin/bash
echo "ğŸ” æ£€æŸ¥å¼€å‘ç¯å¢ƒ..."

# æ£€æŸ¥Docker
docker ps > /dev/null 2>&1 || { echo "âŒ Dockeræœªå¯åŠ¨"; exit 1; }

# æ£€æŸ¥å®¹å™¨
docker ps | grep -q ai-photo-mysql-dev || { echo "âŒ MySQLå®¹å™¨æœªå¯åŠ¨"; exit 1; }
docker ps | grep -q ai-photo-redis-dev || { echo "âŒ Rediså®¹å™¨æœªå¯åŠ¨"; exit 1; }
docker ps | grep -q ai-photo-minio-dev || { echo "âŒ MinIOå®¹å™¨æœªå¯åŠ¨"; exit 1; }

# æ£€æŸ¥åç«¯ç¯å¢ƒå˜é‡
[ -f backend/.env ] || { echo "âŒ backend/.envä¸å­˜åœ¨"; exit 1; }

# æ£€æŸ¥å‰ç«¯ç¯å¢ƒå˜é‡
[ -f frontend/.env.local ] || { echo "âŒ frontend/.env.localä¸å­˜åœ¨"; exit 1; }
grep -q "NEXT_PUBLIC_COS_BUCKET" frontend/.env.local || { echo "âŒ å‰ç«¯ç¯å¢ƒå˜é‡ä¸å®Œæ•´"; exit 1; }

echo "âœ… ç¯å¢ƒæ£€æŸ¥é€šè¿‡ï¼"
```

### 2. æ·»åŠ ä¸€é”®å¯åŠ¨è„šæœ¬

åˆ›å»º `scripts/dev-start.sh`ï¼š
```bash
#!/bin/bash
set -e

echo "ğŸš€ å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ..."

# 1. å¯åŠ¨Dockerå®¹å™¨
echo "ğŸ“¦ å¯åŠ¨Dockerå®¹å™¨..."
docker-compose -f docker-compose.dev.yml up -d
sleep 5

# 2. ç­‰å¾…MySQLå¥åº·
echo "â³ ç­‰å¾…MySQLå¯åŠ¨..."
while ! docker exec ai-photo-mysql-dev mysqladmin ping -h localhost -uroot -pdev_password_123 --silent; do
    sleep 1
done

# 3. æ‰§è¡Œæ•°æ®åº“è¿ç§»
echo "ğŸ“Š æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
cd backend && npm run db:migrate

# 4. å¯åŠ¨æœåŠ¡
echo "âœ¨ ç¯å¢ƒå°±ç»ªï¼è¯·åœ¨ä¸¤ä¸ªç»ˆç«¯åˆ†åˆ«æ‰§è¡Œï¼š"
echo "ç»ˆç«¯1: cd backend && npm run dev"
echo "ç»ˆç«¯2: cd frontend && npm run dev"
```

### 3. å®Œå–„package.jsonè„šæœ¬

åœ¨ `backend/package.json` æ·»åŠ ï¼š
```json
{
  "scripts": {
    "env:check": "node scripts/check-env.js",
    "dev:safe": "npm run env:check && npm run dev"
  }
}
```

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¯¹åº”æŠ€èƒ½åŒ…ï¼š

| æŠ€èƒ½åŒ… | è´Ÿè´£é¢†åŸŸ | è”ç³»æ–¹å¼ |
|-------|---------|---------|
| `backend_dev_skill` | åç«¯ä»£ç é—®é¢˜ | @backend_dev_skill |
| `frontend_dev_skill` | å‰ç«¯é…ç½®é—®é¢˜ | @frontend_dev_skill |
| `codebuddy_deploy_skill` | ç¯å¢ƒéƒ¨ç½²é—®é¢˜ | @codebuddy_deploy_skillï¼ˆè€ç‹æˆ‘ï¼‰ |

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-10-30 15:45
**æ‰§è¡Œè€…**ï¼šè€ç‹ï¼ˆCodeBuddy Deploy Skillï¼‰
**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šç­‰å¾…åç«¯å’Œå‰ç«¯æŠ€èƒ½åŒ…ä¿®å¤é—®é¢˜åé‡æ–°å¯åŠ¨
