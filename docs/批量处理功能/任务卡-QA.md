# 任务卡:QA测试 - 批量处理功能

> **负责技能**:qa_acceptance_skill
> **功能模块**:批量处理功能
> **任务类型**:质量保证测试
> **优先级**:P0

---

## 任务目标

执行批量处理功能的完整测试,包括功能测试、性能测试、安全测试、兼容性测试,确保功能稳定上线。

---

## 测试范围

### ✅ 必须测试
- 批量上传功能
- 批量任务创建和处理
- 批量下载ZIP
- 重试失败项
- 配额扣减/返还
- 限流策略
- 前后端集成

### ❌ 不测试
- 单张任务功能(已有测试)
- 代码质量(Reviewer负责)

---

## 测试环境

### 环境配置
- 开发环境: `https://dev.yourapp.com`
- 测试账号: `test@example.com` / `Test123456`
- 初始配额: 100配额

### 准备工作
- [ ] 重置测试账号配额为100
- [ ] 清空测试账号历史任务
- [ ] 准备测试图片(JPG/PNG/GIF各10张)
- [ ] 准备大图片(>10MB)和超大图片(>20MB)

---

## 测试用例清单

### 一、功能测试(P0)

#### 测试用例1.1:批量上传-正常场景
**测试步骤**:
1. 登录测试账号
2. 进入"服装清理增强"功能页
3. 切换到"批量模式"
4. 拖拽10张JPG图片到上传区域
5. 观察上传进度

**预期结果**:
- ✅ 显示10张图片缩略图
- ✅ 每张图片显示上传进度条
- ✅ 上传完成后进度条消失
- ✅ 配额消耗显示"10张 × 1配额 = 10配额"

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.2:批量上传-格式验证
**测试步骤**:
1. 切换到批量模式
2. 上传1张GIF图片

**预期结果**:
- ✅ 显示红色提示"不支持GIF格式"
- ✅ 该图片自动从列表移除
- ✅ 配额消耗不增加

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.3:批量上传-数量限制
**测试步骤**:
1. 切换到批量模式
2. 上传51张JPG图片

**预期结果**:
- ✅ 显示提示"最多支持50张"
- ✅ 自动保留前50张
- ✅ 第51张被移除

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.4:批量上传-文件大小限制
**测试步骤**:
1. 切换到批量模式
2. 上传1张20MB的图片

**预期结果**:
- ✅ 前端拦截,显示"图片不能超过10MB"
- ✅ 该图片不上传到COS

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.5:批量任务创建-正常场景
**测试步骤**:
1. 批量上传10张图片
2. 点击"生成(消耗10配额)"按钮
3. 确认弹窗中点击"确认生成"

**预期结果**:
- ✅ 显示确认弹窗,包含"本次将消耗10配额,剩余90配额"
- ✅ 提交成功,跳转到批量任务详情页
- ✅ 配额从100扣减到90

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.6:批量任务创建-配额不足
**测试步骤**:
1. 将测试账号配额设为5
2. 批量上传10张图片
3. 点击"生成"按钮

**预期结果**:
- ✅ 显示错误提示"配额不足,还需5配额"
- ✅ 显示"续费"按钮
- ✅ 任务未创建

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.7:批量任务处理-全部成功
**测试步骤**:
1. 提交10张正常图片的批量任务
2. 进入批量任务详情页
3. 每隔3秒刷新页面,观察进度

**预期结果**:
- ✅ 进度条从0%逐步增加到100%
- ✅ 显示"✅ 成功:10张 ❌ 失败:0张"
- ✅ 任务状态变为"success"
- ✅ 所有子任务状态为"success",有output_url

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.8:批量任务处理-部分失败
**测试步骤**:
1. 提交10张图片,其中5张是格式错误的图片
2. 观察批量任务处理过程

**预期结果**:
- ✅ 5张成功,5张失败
- ✅ 显示"✅ 成功:5张 ❌ 失败:5张"
- ✅ 任务状态为"partial_success"
- ✅ 失败项显示错误原因
- ✅ 配额返还5配额(剩余95配额)

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.9:批量下载ZIP-全部成功
**测试步骤**:
1. 批量任务10张图全部成功
2. 点击"全部下载ZIP"按钮
3. 等待下载完成,解压ZIP文件

**预期结果**:
- ✅ ZIP文件名为`batch_任务ID.zip`
- ✅ ZIP包含10张图片
- ✅ 图片命名为`result_1.jpg`, `result_2.jpg`, ...
- ✅ 所有图片可正常打开

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.10:批量下载ZIP-部分成功
**测试步骤**:
1. 批量任务5张成功,5张失败
2. 点击"只下载成功"按钮
3. 解压ZIP文件

**预期结果**:
- ✅ ZIP只包含5张成功的图片
- ✅ 失败的图片不在ZIP中

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.11:重试失败项-正常场景
**测试步骤**:
1. 批量任务5张成功,5张失败
2. 点击"重试失败项"按钮
3. 确认弹窗中点击"确认"

**预期结果**:
- ✅ 显示"将扣减5配额,确认重试?"
- ✅ 配额从95扣减到90
- ✅ 5张失败项重新处理
- ✅ 重新处理成功后,`batch_success`从5更新到10

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例1.12:任务列表-批量角标
**测试步骤**:
1. 创建1个批量任务
2. 返回任务列表页(/workspace)
3. 观察批量任务卡片

**预期结果**:
- ✅ 批量任务显示"批量"蓝色角标
- ✅ 显示进度"5/10 (50%)"
- ✅ 点击展开,显示子任务列表

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

### 二、性能测试(P0)

#### 测试用例2.1:批量上传性能
**测试步骤**:
1. 批量上传50张图片(每张2MB)
2. 记录总耗时

**预期结果**:
- ✅ 总耗时<5秒

**实际结果**: 耗时[X]秒

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例2.2:批量任务创建性能
**测试步骤**:
1. 提交50张图的批量任务
2. 记录从点击"生成"到跳转详情页的耗时

**预期结果**:
- ✅ 耗时<2秒

**实际结果**: 耗时[X]秒

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例2.3:批量任务处理性能
**测试步骤**:
1. 提交50张图的批量任务
2. 记录从提交到全部完成的总耗时

**预期结果**:
- ✅ 总耗时<5分钟

**实际结果**: 耗时[X]分钟

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例2.4:ZIP打包性能
**测试步骤**:
1. 批量任务50张图全部成功
2. 点击"全部下载ZIP"
3. 记录从点击到文件开始下载的耗时

**预期结果**:
- ✅ 耗时<10秒

**实际结果**: 耗时[X]秒

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

### 三、安全测试(P0)

#### 测试用例3.1:配额并发安全
**测试步骤**:
1. 使用Postman/JMeter发起10个并发请求
2. 每个请求提交10张图的批量任务
3. 检查配额扣减

**预期结果**:
- ✅ 配额准确扣减100配额(10个任务×10配额)
- ✅ 不会超扣或少扣

**实际结果**: 配额从100变为[X]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例3.2:重复返还防护
**测试步骤**:
1. 批量任务10张全部失败
2. 使用Postman手动调用2次配额返还接口

**预期结果**:
- ✅ 第一次返还成功,配额+10
- ✅ 第二次返回"已返还过配额"
- ✅ 配额不重复增加

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例3.3:权限校验
**测试步骤**:
1. 用户A创建批量任务,获取taskId
2. 用户B调用`GET /api/tasks/:taskId`

**预期结果**:
- ✅ 返回403错误"无权访问该任务"

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

### 四、兼容性测试(P1)

#### 测试用例4.1:单张模式兼容性
**测试步骤**:
1. 切换到"单张模式"
2. 上传1张图片
3. 提交任务

**预期结果**:
- ✅ 单张模式正常工作
- ✅ 创建的是单张任务(is_batch=false)
- ✅ 批量功能不影响单张模式

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例4.2:历史任务兼容性
**测试步骤**:
1. 查询历史的单张任务
2. 检查任务详情显示

**预期结果**:
- ✅ 历史单张任务正常显示
- ✅ 不显示批量相关字段

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

#### 测试用例4.3:素材库保存
**测试步骤**:
1. 批量任务10张图成功
2. 检查素材库

**预期结果**:
- ✅ 10张成功图片自动保存到素材库

**实际结果**: [测试时填写]

**测试结果**: [ ] ✅通过 [ ] ❌失败

---

## Bug报告模板

```markdown
### Bug ID: BUG-批量处理-001
**优先级**: P0/P1/P2
**标题**: [简短描述]

**复现步骤**:
1. xxx
2. xxx
3. xxx

**预期结果**:
xxx

**实际结果**:
xxx

**环境**:
- 浏览器: Chrome 120
- 账号: test@example.com
- 时间: 2025-10-30 14:30

**截图/日志**:
[附件]

**影响范围**:
[核心功能/边界场景/UI问题]
```

---

## 测试报告模板

```markdown
# 批量处理功能 - QA测试报告

## 测试概况
- 测试日期: 2025-10-XX
- 测试环境: 开发环境
- 测试人员: [QA姓名]

## 测试统计
- 总用例数: 23
- 通过数: 20
- 失败数: 3
- 通过率: 87%

## P0用例结果
- 功能测试: 10/12通过
- 性能测试: 4/4通过
- 安全测试: 3/3通过

## 发现Bug清单
| Bug ID | 优先级 | 标题 | 状态 |
|--------|--------|------|------|
| BUG-001 | P0 | 批量上传51张图未拦截 | 待修复 |
| BUG-002 | P1 | ZIP文件名乱码 | 待修复 |

## 测试结论
- [ ] ✅ 可以上线 - 无P0/P1 Bug
- [ ] ⚠️ 修复后上线 - 有P0/P1 Bug需修复
- [ ] ❌ 不可上线 - 有严重问题

## QA签字
QA: [签名]
日期: 2025-10-XX
```

---

## 预计工作量

**预计时间**:2天

**细分**:
- 功能测试:1天
- 性能/安全测试:0.5天
- Bug验证和回归测试:0.5天

---

**任务卡结束**
