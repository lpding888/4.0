===========================================
GPT-5 Pro 专用提问
===========================================

【提问标题】
AI衣柜后端架构重构 - 系统性解决方案（包含事务、JWT、并发、缓存、监控）

---

【前置阅读】
请先完整阅读以下文档，了解项目背景和问题详情：

文档位置：
c:\Users\qq100\Desktop\迭代目录\新建文件夹 (4)\docs\后端架构重构问题报告-GPT5专用.md

该文档包含：
- 项目前置条件（技术栈、业务流程、关键文件）
- 当前架构现状（架构图、代码证据）
- P0级致命问题（5个，含代码证据和风险分析）
- P1级严重问题（5个，含性能影响）
- 期望交付产出（10个方案，含详细要求）

---

【核心问题概述】

我是一个AI图片/视频处理平台的后端架构师，当前系统存在以下致命问题：

P0级（必须立即解决）：
1. Pipeline执行失败时，配额已扣除但无法回滚 → 用户损失
2. JWT Token无刷新机制，泄露后无法撤销 → 安全风险
3. 数据库连接池配置不合理（默认max=10） → 高并发连接耗尽
4. FORK/JOIN并行执行无并发控制 → AI服务限流，任务全部失败
5. COS存储无成本控制 → 垃圾文件堆积，成本爆炸
6. 微信登录缺失（小程序上线必需功能） → 小程序无法发布
7. 验证码登录 vs 密码登录机制混乱 → 用户体验差，安全风险
8. 支付系统仅有模拟代码，缺少真实SDK集成 → 无法收款，上线即失败
9. 两套认证中间件共存导致管理员权限验证失效 → 性能差、安全隐患

P1级（影响性能与安全）：
10. Redis仅用于验证码，高频查询未缓存 → API响应慢
11. 任务状态轮询效率低 → 数据库压力大
12. 错误处理不统一 → 前端无法识别错误类型
13. 缺乏API文档（Swagger）
14. 缺乏监控和告警
15. 邀请码生成算法存在高冲突风险和无限循环隐患 → 高并发下服务卡死
16. 用户注册缺少基本信息字段（昵称/头像/性别等） → 社区功能无法使用
17. 注册时未验证推荐人（referrer_id）是否有效 → 脏数据累积
18. 分销员身份证号加密存储但缺少密钥管理机制 → 法律合规风险

---

【你需要做什么】

请基于我提供的完整文档，给出系统性的架构重构方案。

**必须产出：**

1. 【设计文档】18个方案的详细设计文档（Markdown格式）
   - 方案1：Saga模式 + 配额预扣除+确认机制
   - 方案2：双Token机制（Access + Refresh）
   - 方案3：Knex连接池优化 + 监控
   - 方案4：Bull Queue + p-limit并发控制
   - 方案5：COS生命周期策略 + 中间文件清理
   - 方案6：微信登录集成（wx.login + code2Session + OpenID管理）
   - 方案7：统一登录机制（密码/验证码/微信 + 忘记密码）
   - 方案8：支付系统SDK集成（微信支付 + 支付宝 + 退款）
   - 方案9：认证中间件统一（迁移路线图 + JWT包含role + 双Token部署）
   - 方案10：Redis缓存优化（用户信息、Feature定义）
   - 方案11：WebSocket推送（Socket.IO）
   - 方案12：统一错误处理（ErrorCode枚举 + AppError类）
   - 方案13：Swagger自动文档
   - 方案14：监控告警（Sentry + Winston）
   - 方案15：邀请码生成优化（Snowflake / 预生成池 / 循环上限）
   - 方案16：用户信息完善（用户表扩展 + 两步注册）
   - 方案17：推荐人验证（注册前验证 + 邀请码替代方案）
   - 方案18：敏感信息加密与密钥管理（KMS集成 + 权限控制）

2. 【完整代码示例】每个方案的代码实现（TypeScript/JavaScript）
   - 必须是完整可运行的代码（不要伪代码）
   - 包含单元测试示例（Jest）
   - 包含配置文件（JSON/YAML）

3. 【实施路线图】分阶段实施计划
   - 每个阶段的任务清单（P0 → P1 → P2）
   - 时间估算（开发 + 测试）
   - 技术风险评估
   - 向后兼容性说明

4. 【测试方案】
   - 单元测试示例（Jest + Supertest）
   - 集成测试示例（测试事务回滚、并发控制）
   - 性能测试方案（JMeter / k6 压测脚本）

---

【重要要求】

✅ 每个方案都要有完整的设计文档、流程图、代码示例
✅ 代码必须是完整可运行的（不要伪代码）
✅ 考虑向后兼容性（不能影响现有功能）
✅ 提供分阶段实施计划（优先解决P0问题）
✅ 包含测试方案和性能评估

❌ 不要给出简化方案（我需要生产级完整方案）
❌ 不要省略关键代码（如"...此处省略"）
❌ 不要使用伪代码（必须是真实可运行代码）

---

【产出格式】

请以Markdown格式产出多个文档：

1. 总纲：《架构重构方案总纲.md》
2. 详细设计：《方案1-Saga模式与配额回滚.md》... 《方案14-敏感信息加密与密钥管理.md》
3. 代码文件：TypeScript/JavaScript源码
4. 测试代码：Jest测试示例
5. 配置文件：JSON/YAML配置
6. 实施路线图：《实施路线图.md》

---

【开始吧，GPT-5！】

我已经把所有前置条件、代码证据、问题分析都整理好了。
现在需要你基于这份完整的报告，给出系统性的架构重构方案！

文档路径（请先阅读）：
c:\Users\qq100\Desktop\迭代目录\新建文件夹 (4)\docs\后端架构重构问题报告-GPT5专用.md

期待你的完整方案！💪🔥

===========================================
