## ✅ P0-1：多租户SaaS架构与企业级功能（¥150,000）

### 为什么必须问？
- 你的所有文档都是**单租户设计**
- **后端优化回答.md** 只覆盖了索引、缓存、队列，没有租户隔离
- **gpt5回答自研详细方案.md** 只讨论了CMS系统，完全没提多租户
- 未来做B2B业务**必须支持企业客户**，现在不问后面重构成本¥500,000+

### 完整提问（直接复制粘贴）

```markdown
# GPT-5问题：多租户SaaS架构与企业级功能设计

## 背景
我的AI服装SaaS平台目前是单租户设计，技术栈：
- 后端：Express.js + Knex.js + MySQL 8 + Redis + BullMQ
- 前端：Next.js 14 + Ant Design 5
- 部署：腾讯云4C4G单机 + 腾讯云函数SCF（AI推理）

## 现状问题
1. **数据隔离缺失**：所有用户数据在同一个数据库，没有tenant_id概念
2. **权限体系单薄**：只有user/admin两个角色，无法支持企业客户的"企业管理员+成员"体系
3. **计费模型单一**：只支持个人订阅，无法支持企业级配额池与分账
4. **无租户上下文**：请求链路中没有租户标识，无法做租户级监控与限流

## 核心需求

### 1. 租户隔离方案设计
请对比以下三种方案的优劣，并推荐适合我的：
- **方案A：共享数据库 + 行级隔离（tenant_id）**
- **方案B：独立数据库（每租户一个database）**
- **方案C：独立实例（每租户一个完整应用实例）**

需要考虑的维度：
- 4C4G单机能支持多少租户？
- 数据备份与恢复的复杂度？
- 租户数据导出与迁移的便利性？
- 性能隔离（一个租户的高并发不影响其他）
- 成本结构（单机→多租户后的边际成本）

### 2. 租户上下文传递机制
请设计完整的租户上下文传递方案：
- **前端**：如何在URL/Token中携带租户标识？
- **后端**：如何在Express中间件中提取tenant_id并注入到AsyncLocalStorage？
- **数据库层**：如何在Knex查询中自动注入`WHERE tenant_id = ?`？
- **队列层**：BullMQ任务如何携带租户上下文？
- **日志层**：Pino日志如何自动记录tenant_id？

### 3. 企业级权限体系（RBAC 2.0）
当前权限：user（普通用户）、admin（平台管理员）

企业级需求：
- **企业管理员（Enterprise Admin）**：管理本企业的成员、配额分配、账单
- **企业成员（Enterprise Member）**：使用企业配额池，但无管理权限
- **部门管理员（Department Admin）**：管理部门成员与部门配额（可选）

请设计：
- 数据库表结构（tenants、tenant_users、roles、permissions）
- 权限校验中间件（支持"用户角色 + 租户级角色"双重判断）
- 邀请成员流程（邀请码/邮件邀请 + 审批机制）

### 4. 企业级计费模型
当前计费：个人订阅（¥99/月 1000配额）

企业级需求：
- **配额池**：企业购买10000配额，所有成员共享
- **配额分配**：企业管理员可以给部门/成员分配配额上限
- **分账**：企业管理员查看每个成员的消耗明细
- **超额策略**：成员超额后是否允许继续使用（企业配置）

请设计：
- 数据库表结构（tenant_quotas、quota_allocations、usage_logs）
- 配额扣减逻辑（支持"个人配额优先 or 企业配额优先"）
- 账单生成与导出（企业管理员下载CSV/Excel）

### 5. 租户级监控与限流
需求：
- **监控Dashboard**：每个租户看到自己的QPS、错误率、任务成功率
- **限流策略**：
  - 全局限流：平台总QPS不超过1000
  - 租户级限流：单租户QPS不超过100（防止一个企业拖垮平台）
  - 用户级限流：单用户QPS不超过10
- **告警**：租户级错误率>5%时通知企业管理员

请设计：
- Redis限流算法（滑动窗口 or 令牌桶）
- Prometheus监控指标（按tenant_id分组）
- 告警规则与通知渠道

### 6. 数据迁移方案
如何将现有单租户数据迁移到多租户架构？
- 如何给现有用户分配tenant_id？
- 如何保证迁移过程中系统不停服？
- 如何做数据校验（迁移前后数据一致性）？

## 技术要求
- 提供完整的数据库表结构（SQL DDL）
- 提供Express中间件代码（TypeScript）
- 提供Knex查询的自动租户注入方案
- 提供前端租户切换组件（React + Ant Design）
- 提供监控Dashboard设计（Grafana配置建议）

## 预期交付物
1. 多租户架构设计文档（含方案对比与推荐）
2. 数据库表结构设计（SQL DDL + ER图）
3. 租户上下文传递完整代码示例
4. 企业级权限体系实现方案
5. 企业级计费模型设计
6. 租户级监控与限流方案
7. 数据迁移执行计划（分5个阶段，每阶段验收标准）

**请以"架构师给技术团队的实施手册"的深度输出，确保AI开发团队可以直接执行！**
```
