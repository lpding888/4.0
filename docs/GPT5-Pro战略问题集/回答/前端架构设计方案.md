ä¸‹é¢æ˜¯ä¸€æ•´å¥—**ä»¥ Next.js 14 App Router + TypeScript + Ant Design 5 + Zustand + axios** ä¸ºæ ¸å¿ƒçš„å‰ç«¯æ¶æ„ä¸å®ç°æ–¹æ¡ˆã€‚æ¯ä¸€é¢˜éƒ½åŒ…å«æ¶æ„æ€è·¯ã€å¯è¿è¡Œ/å¯ç›´æ¥è½åœ°çš„æ ¸å¿ƒä»£ç ç‰‡æ®µï¼ˆTypeScript/TSXï¼‰ã€æœ€ä½³å®è·µä¸å¸¸è§å‘ã€‚

> ä¸ºä¾¿äºç†è§£ï¼Œç¤ºä¾‹ä»£ç ä¸­çš„è·¯å¾„å…¨éƒ¨åŸºäºæœ¬æ–‡æä¾›çš„ç›®å½•ç»“æ„ï¼›ä½ å¯ä»¥é€æ­¥å¼•å…¥ï¼Œè€Œä¸å¿…ä¸€æ¬¡æ€§æ›¿æ¢æ•´ä¸ªé¡¹ç›®ã€‚

---

## ğŸ“Œ é—®é¢˜1ï¼šæ•´ä½“æ¶æ„è®¾è®¡

### 1) ç›®å½•ç»“æ„ï¼ˆæ ‘å½¢å›¾ + èŒè´£ï¼‰

> å€Ÿé‰´ â€œåˆ†å±‚ + æŒ‰åŸŸæ‹†åˆ† + å¤ç”¨å±‚æŠ½è±¡ï¼ˆshared/ui/lib/modelï¼‰â€ çš„æ€è·¯ï¼ˆæ¥è¿‘ FSDï¼Œä½†æ›´è´´åˆ Next App Routerï¼‰ã€‚

```
src/
â”œâ”€ app/                              # Next App Routerï¼ˆä»…æ”¾è·¯ç”±ã€å¸ƒå±€ã€å…¥å£ï¼Œå°½é‡å°‘é€»è¾‘ï¼‰
â”‚  â”œâ”€ (public)/                      # å…¬å…±ä¸éœ€è¦ç™»å½•çš„åŒº
â”‚  â”‚  â”œâ”€ login/page.tsx
â”‚  â”‚  â””â”€ pricing/page.tsx
â”‚  â”œâ”€ (user)/                        # éœ€ç™»å½•çš„ç”¨æˆ·åŒºï¼ˆå·¥ä½œå°ã€ç´ æåº“ç­‰ï¼‰
â”‚  â”‚  â”œâ”€ layout.tsx                  # ç”¨æˆ·åŒºå¸ƒå±€ï¼ˆå«å¯¼èˆªã€æƒé™åŒ…è£…ï¼‰
â”‚  â”‚  â”œâ”€ workbench/page.tsx
â”‚  â”‚  â”œâ”€ library/page.tsx
â”‚  â”‚  â””â”€ reseller/page.tsx
â”‚  â”œâ”€ (admin)/                       # ç®¡ç†åå°
â”‚  â”‚  â”œâ”€ layout.tsx
â”‚  â”‚  â”œâ”€ users/page.tsx
â”‚  â”‚  â”œâ”€ orders/page.tsx
â”‚  â”‚  â””â”€ features/page.tsx
â”‚  â”œâ”€ api/                           # å¯é€‰ï¼šæœ¬åœ°è¾¹ç¼˜ä»£ç†ï¼ˆè½¬å‘åç«¯ï¼Œéšè—ç§˜é’¥/è·¨åŸŸï¼‰
â”‚  â”‚  â””â”€ proxy/[...path]/route.ts
â”‚  â”œâ”€ layout.tsx                     # æ ¹å¸ƒå±€ï¼ˆå…¨å±€ Provider æ³¨å†Œï¼‰
â”‚  â””â”€ page.tsx                       # é¦–é¡µ
â”‚
â”œâ”€ entities/                         # é¢†åŸŸå®ä½“ï¼ˆçº¯ç±»å‹ã€æœ€å°é€»è¾‘ï¼‰
â”‚  â”œâ”€ user/
â”‚  â”‚  â”œâ”€ types.ts
â”‚  â”‚  â””â”€ model.ts
â”‚  â”œâ”€ feature/
â”‚  â”‚  â”œâ”€ types.ts
â”‚  â”‚  â””â”€ model.ts
â”‚  â””â”€ billing/
â”‚     â”œâ”€ types.ts
â”‚     â””â”€ model.ts
â”‚
â”œâ”€ features/                         # å¯å¤ç”¨çš„â€œåŠŸèƒ½å•å…ƒâ€ï¼ˆUI + ä¸šåŠ¡åä½œï¼‰
â”‚  â”œâ”€ auth/
â”‚  â”‚  â”œâ”€ ui/LoginForm.tsx
â”‚  â”‚  â”œâ”€ model/auth.store.ts         # Zustand slice
â”‚  â”‚  â”œâ”€ model/auth.api.ts
â”‚  â”‚  â””â”€ lib/jwt.ts
â”‚  â”œâ”€ permissions/
â”‚  â”‚  â”œâ”€ model/permission.ts         # RBAC å®šä¹‰ä¸åˆ¤æ–­
â”‚  â”‚  â””â”€ ui/PermissionGuard.tsx
â”‚  â”œâ”€ workbench/
â”‚  â”‚  â”œâ”€ ui/FeatureCard.tsx
â”‚  â”‚  â”œâ”€ ui/FeatureGrid.tsx
â”‚  â”‚  â”œâ”€ model/feature.store.ts
â”‚  â”‚  â””â”€ model/feature.api.ts
â”‚  â””â”€ forms/
â”‚     â”œâ”€ ui/DynamicForm.tsx
â”‚     â”œâ”€ model/schema.ts
â”‚     â””â”€ lib/rules.ts
â”‚
â”œâ”€ widgets/                          # é¡µé¢çº§å¯ç»„åˆçš„åŒºå—ï¼ˆå¯¼èˆªã€é¡µå¤´ã€è¿‡æ»¤æ¡ï¼‰
â”‚  â”œâ”€ Navigation/
â”‚  â”‚  â”œâ”€ SideNav.tsx
â”‚  â”‚  â””â”€ menu.config.ts
â”‚  â”œâ”€ PageHeader/
â”‚  â”‚  â””â”€ PageHeader.tsx
â”‚  â””â”€ Tables/
â”‚     â”œâ”€ DataTable.tsx
â”‚     â””â”€ FilterBar.tsx
â”‚
â”œâ”€ shared/
â”‚  â”œâ”€ api/
â”‚  â”‚  â”œâ”€ axios.ts                    # axios å®ä¾‹ã€æ‹¦æˆªå™¨
â”‚  â”‚  â””â”€ useRequest.ts               # é€šç”¨è¯·æ±‚ Hookï¼ˆæ”¯æŒé‡è¯•/å–æ¶ˆ/ç¼“å­˜ï¼‰
â”‚  â”œâ”€ hooks/
â”‚  â”‚  â”œâ”€ usePagination.ts
â”‚  â”‚  â”œâ”€ useTableData.ts
â”‚  â”‚  â””â”€ useTableFilter.ts
â”‚  â”œâ”€ lib/
â”‚  â”‚  â”œâ”€ icons.tsx                   # AntD å›¾æ ‡åŠ¨æ€æ˜ å°„
â”‚  â”‚  â”œâ”€ cache.ts                    # ç®€æ˜“ç¼“å­˜/å»é‡
â”‚  â”‚  â”œâ”€ types.ts                    # åŸºç¡€é€šç”¨ç±»å‹ï¼ˆApiResponseã€Paginatedç­‰ï¼‰
â”‚  â”‚  â””â”€ utils.ts
â”‚  â”œâ”€ store/
â”‚  â”‚  â””â”€ store.ts                    # createStore + slices ç»„åˆ
â”‚  â”œâ”€ ui/                            # è®¾è®¡ç³»ç»Ÿå°è£…ï¼ˆAntD åŸå­å°è£…/ä¸»é¢˜ï¼‰
â”‚  â”‚  â”œâ”€ AppThemeProvider.tsx
â”‚  â”‚  â””â”€ form-controls/              # äºŒæ¬¡å°è£…çš„é€šç”¨æ§ä»¶
â”‚  â””â”€ styles/
â”‚     â”œâ”€ globals.css
â”‚     â””â”€ tokens.ts                   # è®¾è®¡ä»¤ç‰Œã€ä¸»é¢˜é…ç½®
â”‚
â”œâ”€ middleware.ts                     # è·¯ç”±å®ˆå«ï¼ˆApp Routerï¼‰
â”œâ”€ env.d.ts                          # ç¯å¢ƒå˜é‡ç±»å‹
â””â”€ types.d.ts                        # å…¨å±€ç±»å‹è¡¥å……
```

**å±‚æ¬¡èŒè´£è¦ç‚¹ï¼š**

* **app/** åªè´Ÿè´£é¡µé¢ç»„åˆä¸è·¯ç”±ï¼Œä¸å†™åšé‡ä¸šåŠ¡é€»è¾‘ã€‚
* **entities/** æ”¾â€œçº¯â€é¢†åŸŸç±»å‹ä¸æœ€å°çº¯å‡½æ•°ï¼ˆä¾¿äºå¤ç”¨ä¸å•æµ‹ï¼‰ã€‚
* **features/** ä¸€ä¸ªåŠŸèƒ½ = UI + model + api + å°‘é‡ä¸šåŠ¡ glueã€‚
* **widgets/** é¡µé¢çº§å¤åˆç»„ä»¶ï¼ˆå¯¼èˆªã€é¡µå¤´ã€è¿‡æ»¤æ¡ã€è¡¨æ ¼ï¼‰ã€‚
* **shared/** æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆè¯·æ±‚ã€hooksã€ç¼“å­˜ã€è®¾è®¡ç³»ç»Ÿã€icons åŠ¨æ€æ˜ å°„ï¼‰ã€‚
* **middleware.ts** ç»Ÿä¸€è·¯ç”±å®ˆå«ï¼ˆç™»å½• + è§’è‰²ï¼‰ã€‚

---

### 2) ç»„ä»¶åˆ†å±‚ç­–ç•¥

* **å±•ç¤ºç»„ä»¶ï¼ˆPresentationalï¼‰**ï¼šçº¯ UIï¼ˆä» props æ¥æ”¶æ•°æ®ä¸å›è°ƒï¼Œå‡ ä¹æ— çŠ¶æ€ï¼‰ï¼Œå¦‚ `FeatureCard`ã€‚
* **å®¹å™¨ç»„ä»¶ï¼ˆContainerï¼‰**ï¼šæ‰¿è½½æ•°æ®åŠ è½½ã€çŠ¶æ€æ§åˆ¶ï¼ˆå¯æ”¾åœ¨ `features/*/ui` å†…ï¼Œä»¥ `*View.tsx` å‘½åï¼‰ã€‚
* **é¡µé¢ï¼ˆPageï¼‰**ï¼šç»„åˆå®¹å™¨ä¸å±•ç¤ºç»„ä»¶ï¼Œå°½é‡ä¿æŒâ€œè–„â€ã€‚

---

### 3) çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼ˆZustandï¼‰

* **å…¨å±€çŠ¶æ€**ï¼š`auth`ï¼ˆç”¨æˆ·/ä»¤ç‰Œ/è§’è‰²ï¼‰ã€`ui`ï¼ˆä¸»é¢˜/æŠ˜å èœå•/å…¨å±€ loadingï¼‰ã€å°‘é‡è·¨åŸŸçš„åªè¯»â€œé…ç½®â€ï¼ˆå¦‚ features åˆ—è¡¨ç¼“å­˜ï¼‰ã€‚
* **å±€éƒ¨çŠ¶æ€**ï¼šè¡¨å•ã€æŸä¸ªé¡µé¢å†…çš„ç­›é€‰/åˆ†é¡µç­‰ï¼Œç”¨ hooks + ç»„ä»¶å†…éƒ¨ state ç®¡ç†ã€‚
* **åˆ‡ç‰‡åŒ–**ï¼š`authSlice`ã€`featureSlice` ç­‰ï¼Œä½¿ç”¨ `zustand/middleware` çš„ `persist` ä¸ `immer`ã€‚

**ç¤ºä¾‹ï¼šç»„åˆ storeï¼ˆshared/store/store.tsï¼‰**

```ts
import { create } from 'zustand';
import { devtools, persist } from 'zustand/middleware';

type AuthState = {
  user?: { id: string; email: string; roles: string[] };
  accessToken?: string;
  setAuth: (p: AuthState) => void;
  clear: () => void;
};

type UIState = {
  collapsed: boolean;
  setCollapsed: (v: boolean) => void;
};

type RootState = AuthState & UIState;

export const useRootStore = create<RootState>()(
  devtools(
    persist(
      (set) => ({
        // auth slice
        user: undefined,
        accessToken: undefined,
        setAuth: (p) => set(p),
        clear: () => set({ user: undefined, accessToken: undefined }),
        // ui slice
        collapsed: false,
        setCollapsed: (v) => set({ collapsed: v }),
      }),
      { name: 'app-store' }
    )
  )
);
```

---

### 4) è·¯ç”±ä¸æƒé™ç®¡ç†ï¼ˆmiddleware + Guardï¼‰

**middleware.tsï¼ˆç»Ÿä¸€å®ˆå«ï¼‰**

```ts
// src/middleware.ts
import { NextRequest, NextResponse } from 'next/server';

const PROTECTED_PREFIXES = ['/workbench', '/library', '/reseller', '/admin'];

export function middleware(req: NextRequest) {
  const { pathname } = req.nextUrl;

  // ä»…ä¿æŠ¤ç‰¹å®šå‰ç¼€
  if (!PROTECTED_PREFIXES.some((p) => pathname.startsWith(p))) {
    return NextResponse.next();
  }

  const token = req.cookies.get('access_token')?.value;
  const roles = req.cookies.get('roles')?.value?.split(',') ?? [];

  if (!token) {
    const url = req.nextUrl.clone();
    url.pathname = '/login';
    url.searchParams.set('redirect', pathname);
    return NextResponse.redirect(url);
  }

  // /admin éœ€è¦ç®¡ç†å‘˜
  if (pathname.startsWith('/admin') && !roles.includes('admin')) {
    const url = req.nextUrl.clone();
    url.pathname = '/403';
    return NextResponse.rewrite(url);
  }

  return NextResponse.next();
}

export const config = {
  matcher: ['/workbench/:path*', '/library/:path*', '/reseller/:path*', '/admin/:path*'],
};
```

**PermissionGuardï¼ˆfeatures/permissions/ui/PermissionGuard.tsxï¼‰**

```tsx
'use client';
import React from 'react';
import { Result } from 'antd';
import { useRootStore } from '@/shared/store/store';

type Props = {
  allow: ('user' | 'reseller' | 'admin')[];
  children: React.ReactNode;
};

export function PermissionGuard({ allow, children }: Props) {
  const roles = useRootStore((s) => s.user?.roles ?? []);
  const ok = allow.some((r) => roles.includes(r));

  if (!ok) return <Result status="403" title="403" subTitle="æ— è®¿é—®æƒé™" />;
  return <>{children}</>;
}
```

é¡µé¢ä½¿ç”¨ï¼ˆapp/(admin)/layout.tsxï¼‰ï¼š

```tsx
import { PermissionGuard } from '@/features/permissions/ui/PermissionGuard';

export default function AdminLayout({ children }: { children: React.ReactNode }) {
  return <PermissionGuard allow={['admin']}>{children}</PermissionGuard>;
}
```

---

### 5) ç±»å‹ç³»ç»Ÿè®¾è®¡

* **ä¸¥æ ¼æ¨¡å¼**ï¼š`"strict": true`ï¼Œå¼€å¯ `"noUncheckedIndexedAccess": true`ã€`"exactOptionalPropertyTypes": true`ã€‚
* **æ ¸å¿ƒé€šç”¨ç±»å‹ï¼ˆshared/lib/types.tsï¼‰**

```ts
export type ApiResponse<T> = { code: number; message: string; data: T };
export type Paginated<T> = { items: T[]; total: number; page: number; pageSize: number };

export type Role = 'user' | 'reseller' | 'admin';

export type FeatureDefinition = {
  feature_id: string;
  name: string;
  description?: string;
  icon?: string;            // å¦‚ "ScissorOutlined"
  quota_cost: number;
  status: 'online' | 'offline' | 'beta';
  category?: string;
  order?: number;
  tags?: string[];
};
```

---

### 6) æ ·å¼ä¸è®¾è®¡ç³»ç»Ÿï¼ˆAntD 5ï¼‰

* ç»Ÿä¸€åœ¨ `AppThemeProvider` ä¸­é…ç½®ä¸»é¢˜ tokenã€ä¸­æ–‡æœ¬åœ°åŒ–ã€App çº§åˆ« Contextã€‚
* åœ¨ `shared/ui/` å°è£…é€šç”¨æ§ä»¶ï¼ˆé¿å…é¡µé¢ç›´æ¥ä½¿ç”¨å¤æ‚çš„ AntD APIï¼Œé™ä½é‡å¤ï¼‰ã€‚

**ç¤ºä¾‹ï¼šAppThemeProviderï¼ˆshared/ui/AppThemeProvider.tsxï¼‰**

```tsx
'use client';
import { App as AntdApp, ConfigProvider, theme as antdTheme } from 'antd';
import zhCN from 'antd/locale/zh_CN';
import React from 'react';

export function AppThemeProvider({ children }: { children: React.ReactNode }) {
  return (
    <ConfigProvider
      locale={zhCN}
      theme={{
        algorithm: antdTheme.defaultAlgorithm,
        token: {
          colorPrimary: '#1677ff',
          borderRadius: 8,
        },
      }}
    >
      <AntdApp>{children}</AntdApp>
    </ConfigProvider>
  );
}
```

æ ¹å¸ƒå±€æ³¨å†Œï¼ˆapp/layout.tsxï¼‰ï¼š

```tsx
import './globals.css';
import { AppThemeProvider } from '@/shared/ui/AppThemeProvider';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="zh-CN">
      <body><AppThemeProvider>{children}</AppThemeProvider></body>
    </html>
  );
}
```

---

### âœ… æœ¬é¢˜å…³é”®ä»£ç ç¤ºä¾‹ï¼ˆâ‰¥3ï¼‰

1. `middleware.ts`ï¼ˆç»Ÿä¸€ç™»å½•/è§’è‰²å®ˆå«ï¼‰âœ”
2. `PermissionGuard`ï¼ˆç»„ä»¶çº§åˆ«æƒé™æ ¡éªŒï¼‰âœ”
3. `AppThemeProvider`ï¼ˆç»Ÿä¸€è®¾è®¡ç³»ç»Ÿï¼‰âœ”
4. `useRootStore`ï¼ˆZustand ç»„åˆ storeï¼‰âœ”

---

### âœ… æœ€ä½³å®è·µ

* é¡µé¢â€œç˜¦èº«â€ï¼šé¡µé¢ä»…ç»„è£… UIï¼Œæ•°æ®åŠ è½½ä¸ä¸šåŠ¡é€»è¾‘æ”¾å…¥ features çš„ model/api/hookã€‚
* ç±»å‹ä» **entities** å®šä¹‰å‡ºå‘ï¼Œ**shared/lib/types** æç‚¼é€šç”¨ï¼Œé¿å…å¾ªç¯ä¾èµ–ã€‚
* UI åŸå­å°è£…ï¼šå¸¸ç”¨è¡¨å•æ§ä»¶ç»Ÿä¸€äºŒæ¬¡å°è£…ï¼Œå‡å°‘é‡å¤å±æ€§ä¸æ ·å¼ã€‚
* æ˜ç¡®â€œå…¨å±€ vs å±€éƒ¨â€çŠ¶æ€çš„è¾¹ç•Œï¼›è·¨é¡µé¢æ‰æ”¾å…¨å±€ã€‚

### âš ï¸ å¸¸è§å‘

* åœ¨ **middleware** é‡Œæ— æ³•è®¿é—® localStorageï¼Œåªèƒ½è¯» **Cookies**ã€‚
* AntD 5 ä¸»é¢˜éœ€æ”¾åœ¨ `ConfigProvider`ï¼Œé¿å…å¤šå¤„é‡å¤é…ç½®ã€‚
* Zustand çš„ `persist` é»˜è®¤ä½¿ç”¨ localStorageï¼Œä¸è¦åœ¨ SSR ç¯å¢ƒç›´æ¥è¯»å–ï¼ˆåœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨ï¼‰ã€‚

---

## ğŸ“Œ é—®é¢˜2ï¼šåŠŸèƒ½é…ç½®ç®¡ç†ï¼ˆé¿å…ç¡¬ç¼–ç ï¼‰

### 1) æ•°æ®ç»“æ„ä¸ API åŠ è½½/ç¼“å­˜

**FeatureDefinition ç±»å‹** å·²åœ¨ä¸Šæ–‡ç»™å‡ºã€‚å¢åŠ ä¸€ä¸ªå¸¦ç¼“å­˜çš„ storeï¼š

```ts
// features/workbench/model/feature.store.ts
'use client';
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';
import { FeatureDefinition } from '@/shared/lib/types';
import { getFeatures } from './feature.api';

type State = {
  list: FeatureDefinition[];
  loadedAt?: number;
  loading: boolean;
  error?: string;
  fetch: (force?: boolean) => Promise<void>;
};

const TTL = 60 * 1000; // 1 åˆ†é’Ÿç¼“å­˜

export const useFeatureStore = create<State>()(
  devtools((set, get) => ({
    list: [],
    loading: false,
    async fetch(force) {
      const now = Date.now();
      if (!force && get().loadedAt && now - get().loadedAt < TTL) return;
      try {
        set({ loading: true, error: undefined });
        const data = await getFeatures();
        set({ list: data, loading: false, loadedAt: now });
      } catch (e: any) {
        set({ error: e?.message ?? 'åŠ è½½å¤±è´¥', loading: false });
      }
    },
  }))
);
```

```ts
// features/workbench/model/feature.api.ts
import { api } from '@/shared/api/axios';
import { FeatureDefinition } from '@/shared/lib/types';

export async function getFeatures(): Promise<FeatureDefinition[]> {
  const res = await api.get<{ data: FeatureDefinition[] }>('/features');
  return res.data.data;
}
```

### 2) åŠ¨æ€å›¾æ ‡æ¸²æŸ“æ–¹æ¡ˆ

```tsx
// shared/lib/icons.tsx
import * as AntdIcons from '@ant-design/icons';
import React from 'react';

export type IconName = keyof typeof AntdIcons;

export function DynamicIcon({ name }: { name?: string }) {
  if (!name) return null;
  const Comp = (AntdIcons as any)[name];
  return Comp ? <Comp /> : <AntdIcons.AppstoreOutlined />;
}
```

### 3) é€šç”¨ FeatureCard / FeatureGrid

```tsx
// features/workbench/ui/FeatureCard.tsx
'use client';
import { Card, Tag, Tooltip } from 'antd';
import { DynamicIcon } from '@/shared/lib/icons';
import { FeatureDefinition } from '@/shared/lib/types';

type Props = {
  item: FeatureDefinition;
  onClick?: (f: FeatureDefinition) => void;
};

export function FeatureCard({ item, onClick }: Props) {
  const meta = (
    <div className="flex items-center gap-2">
      <DynamicIcon name={item.icon} />
      <span>{item.name}</span>
      {item.status !== 'online' && <Tag color="orange">{item.status}</Tag>}
    </div>
  );
  return (
    <Card hoverable onClick={() => onClick?.(item)} title={meta}>
      <Tooltip title={item.description}>{item.description}</Tooltip>
      <div className="mt-2 text-xs text-gray-500">é…é¢æ¶ˆè€—ï¼š{item.quota_cost}</div>
      {item.tags?.length ? <div className="mt-2">{item.tags.map(t => <Tag key={t}>{t}</Tag>)}</div> : null}
    </Card>
  );
}
```

```tsx
// features/workbench/ui/FeatureGrid.tsx
'use client';
import { Input, Select, Segmented, Empty, Skeleton } from 'antd';
import React, { useMemo, useState } from 'react';
import { useFeatureStore } from '../model/feature.store';
import { FeatureCard } from './FeatureCard';
import styles from './grid.module.css';

type SortKey = 'order' | 'name' | 'quota_cost';
type Props = { onEnterFeature?: (id: string) => void };

export function FeatureGrid({ onEnterFeature }: Props) {
  const { list, loading } = useFeatureStore();
  const [q, setQ] = useState('');
  const [category, setCategory] = useState<string | undefined>(undefined);
  const [sortKey, setSortKey] = useState<SortKey>('order');

  const categories = useMemo(() => Array.from(new Set(list.map(i => i.category).filter(Boolean))) as string[], [list]);

  const data = useMemo(() => {
    let r = list;
    if (q) r = r.filter(i => i.name.includes(q) || i.tags?.some(t => t.includes(q)));
    if (category) r = r.filter(i => i.category === category);
    r = [...r].sort((a, b) => {
      if (sortKey === 'name') return a.name.localeCompare(b.name);
      if (sortKey === 'quota_cost') return a.quota_cost - b.quota_cost;
      return (a.order ?? 0) - (b.order ?? 0);
    });
    return r;
  }, [list, q, category, sortKey]);

  if (loading) return <Skeleton active paragraph={{ rows: 8 }} />;

  return (
    <div>
      <div className={styles.toolbar}>
        <Input.Search allowClear placeholder="æœç´¢åç§°/æ ‡ç­¾â€¦" onChange={(e) => setQ(e.target.value)} style={{ width: 240 }} />
        <Select
          allowClear
          placeholder="æŒ‰åˆ†ç±»"
          style={{ width: 160 }}
          options={categories.map(c => ({ value: c, label: c }))}
          onChange={setCategory}
        />
        <Segmented
          options={[
            { label: 'é»˜è®¤', value: 'order' },
            { label: 'åç§°', value: 'name' },
            { label: 'é…é¢', value: 'quota_cost' },
          ]}
          value={sortKey}
          onChange={(v) => setSortKey(v as SortKey)}
        />
      </div>

      {data.length === 0 ? <Empty /> : (
        <div className={styles.grid}>
          {data.map(f => (
            <FeatureCard key={f.feature_id} item={f} onClick={(it) => onEnterFeature?.(it.feature_id)} />
          ))}
        </div>
      )}
    </div>
  );
}
```

> `grid.module.css`ï¼šå®šä¹‰ `.toolbar{display:flex;gap:12px;margin-bottom:12px}`ã€`.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}`

é¡µé¢ä½¿ç”¨ï¼ˆapp/(user)/workbench/page.tsxï¼‰ï¼š

```tsx
'use client';
import { useEffect } from 'react';
import { useFeatureStore } from '@/features/workbench/model/feature.store';
import { FeatureGrid } from '@/features/workbench/ui/FeatureGrid';
import { useRouter } from 'next/navigation';

export default function WorkbenchPage() {
  const fetch = useFeatureStore(s => s.fetch);
  const router = useRouter();
  useEffect(() => { fetch(); }, [fetch]);

  return <FeatureGrid onEnterFeature={(id) => router.push(`/workbench/${id}`)} />;
}
```

---

### âœ… æœ¬é¢˜å…³é”®ä»£ç ç¤ºä¾‹ï¼ˆâ‰¥3ï¼‰

1. `feature.store.ts`ï¼ˆåŠ è½½ + TTL ç¼“å­˜ï¼‰âœ”
2. `DynamicIcon`ï¼ˆå­—ç¬¦ä¸²ååŠ¨æ€æ¸²æŸ“ AntD å›¾æ ‡ï¼‰âœ”
3. `FeatureCard` / `FeatureGrid`ï¼ˆåˆ†ç±»/ç­›é€‰/æ’åº/è¿›å…¥åŠŸèƒ½ï¼‰âœ”
4. `feature.api.ts`ï¼ˆaxios æ‹‰å–ï¼‰âœ”

### âœ… æœ€ä½³å®è·µ

* **åç«¯ç›´å‡ºâ€œåˆ†ç±»/æ’åºæƒé‡â€** å­—æ®µï¼Œå‰ç«¯ä»…åšç»„åˆï¼›é¿å…åœ¨å‰ç«¯ç»´æŒå¤æ‚è§„åˆ™ã€‚
* åˆ—è¡¨ç¼“å­˜åŠ  TTLï¼Œé¿å…æ¯æ¬¡è¿›å…¥éƒ½å‘è¯·æ±‚ï¼›ç»™ `force` åˆ·æ–°å£å­ã€‚
* å›¾æ ‡åç»Ÿä¸€åç«¯å­˜å‚¨ä¸º **AntD Icon ç»„ä»¶å**ï¼Œå‰ç«¯ä¸€å¤„æ˜ å°„ã€‚

### âš ï¸ å¸¸è§å‘

* å›¾æ ‡åå¤§å°å†™å¿…é¡»ä¸ `@ant-design/icons` å¯¼å‡ºä¸€è‡´ã€‚
* è¿‡æ»¤/æ’åºè¦åš **çº¯å‡½æ•°**ï¼Œé¿å…åœ¨æ¸²æŸ“æœŸé—´ä¿®æ”¹æºæ•°ç»„ï¼ˆä½¿ç”¨æ‹·è´ï¼‰ã€‚

---

## ğŸ“Œ é—®é¢˜3ï¼šåŠ¨æ€è¡¨å•ç³»ç»Ÿ

### 1) æ¶æ„æ€è·¯

* åç«¯å­˜ **è½»é‡ JSON é…ç½®**ï¼ˆä½ æä¾›çš„æ ¼å¼å³å¯ï¼‰ï¼Œå‰ç«¯åš**å­—æ®µç±»å‹åˆ° AntD ç»„ä»¶æ˜ å°„è¡¨**ã€‚
* åŠ¨æ€ç”Ÿæˆ AntD `rules`ï¼ˆå¿…å¡«ã€èŒƒå›´ã€patternï¼‰ã€‚
* ç»Ÿä¸€ `onFinish`ï¼šå°†å€¼è¿›è¡Œ **normalize**ï¼ˆå¦‚ Upload è½¬ URLï¼‰åäº¤ç»™ä¸Šå±‚ã€‚

### 2) ç±»å‹ä¸å­—æ®µæ˜ å°„

```ts
// features/forms/model/schema.ts
export type FieldType = 'text' | 'number' | 'image_upload' | 'enum' | 'date' | 'switch';

export type FieldSchema = {
  name: string;
  type: FieldType;
  label: string;
  required?: boolean;
  placeholder?: string;
  min?: number;
  max?: number;
  options?: string[]; // enum
  pattern?: string;   // æ­£åˆ™
};

export type FormSchema = { fields: FieldSchema[] };
```

```ts
// features/forms/lib/rules.ts
import { Rule } from 'antd/es/form';
import { FieldSchema } from '../model/schema';

export function buildRules(f: FieldSchema): Rule[] {
  const rules: Rule[] = [];
  if (f.required) rules.push({ required: true, message: `${f.label}ä¸ºå¿…å¡«é¡¹` });
  if (typeof f.min === 'number' || typeof f.max === 'number') {
    if (f.type === 'number') rules.push({ type: 'number', min: f.min, max: f.max });
  }
  if (f.pattern) rules.push({ pattern: new RegExp(f.pattern), message: `${f.label}æ ¼å¼ä¸æ­£ç¡®` });
  return rules;
}
```

### 3) åŠ¨æ€è¡¨å•ç»„ä»¶

```tsx
// features/forms/ui/DynamicForm.tsx
'use client';
import React from 'react';
import { Form, Input, InputNumber, Upload, Select, DatePicker, Switch, Button, message } from 'antd';
import type { UploadFile } from 'antd/es/upload/interface';
import { FieldSchema, FormSchema } from '../model/schema';
import { buildRules } from '../lib/rules';

type Props<T extends object = Record<string, any>> = {
  schema: FormSchema;
  initialValues?: Partial<T>;
  onSubmit: (values: T) => Promise<void> | void;
  submittingText?: string;
};

function renderField(f: FieldSchema) {
  const common = { placeholder: f.placeholder ?? `è¯·è¾“å…¥${f.label}` };
  switch (f.type) {
    case 'text': return <Input {...common} />;
    case 'number': return <InputNumber style={{ width: '100%' }} {...{ min: f.min, max: f.max }} />;
    case 'enum': return <Select options={f.options?.map(o => ({ value: o, label: o }))} />;
    case 'date': return <DatePicker style={{ width: '100%' }} />;
    case 'switch': return <Switch />;
    case 'image_upload':
      return (
        <Upload listType="picture-card" maxCount={1} beforeUpload={() => false}>
          <div>ä¸Šä¼ </div>
        </Upload>
      );
    default:
      return <Input {...common} />;
  }
}

function normalize(values: any, schema: FormSchema) {
  // å°† Upload FileList è½¬æ¢ä¸ºåç«¯éœ€è¦çš„å€¼ï¼ˆä¾‹å¦‚ï¼šä»…å–æ–‡ä»¶å¯¹è±¡æˆ–å·²ä¸Šä¼  URLï¼‰
  const v = { ...values };
  schema.fields.forEach((f) => {
    if (f.type === 'image_upload') {
      const files = (v[f.name] as UploadFile[]) ?? [];
      v[f.name] = files[0]?.originFileObj ?? files[0]?.url ?? null;
    }
  });
  return v;
}

export function DynamicForm<T extends object = Record<string, any>>({
  schema,
  initialValues,
  onSubmit,
  submittingText = 'æäº¤ä¸­â€¦',
}: Props<T>) {
  const [form] = Form.useForm<T>();
  const [submitting, setSubmitting] = React.useState(false);

  async function handleFinish(values: T) {
    setSubmitting(true);
    try {
      const normalized = normalize(values, schema);
      await onSubmit(normalized);
      message.success('æäº¤æˆåŠŸ');
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <Form<T> form={form} layout="vertical" initialValues={initialValues as any} onFinish={handleFinish}>
      {schema.fields.map((f) => (
        <Form.Item key={f.name} name={f.name as any} label={f.label} valuePropName={f.type === 'switch' ? 'checked' : undefined} rules={buildRules(f)}>
          {renderField(f)}
        </Form.Item>
      ))}
      <Button type="primary" htmlType="submit" loading={submitting}>{submittingText}</Button>
    </Form>
  );
}
```

é¡µé¢ä½¿ç”¨ï¼ˆç®¡ç†åå°ä¸ºæŸåŠŸèƒ½é…ç½®è¡¨å•ï¼‰ï¼š

```tsx
'use client';
import { DynamicForm } from '@/features/forms/ui/DynamicForm';
import type { FormSchema } from '@/features/forms/model/schema';

const schema: FormSchema = {
  fields: [
    { name: 'image', type: 'image_upload', label: 'ä¸Šä¼ å›¾ç‰‡', required: true },
    { name: 'style', type: 'enum', label: 'æœè£…é£æ ¼', options: ['å•†åŠ¡', 'ä¼‘é—²'], required: true },
    { name: 'intensity', type: 'number', label: 'æ•ˆæœå¼ºåº¦', min: 0, max: 100 },
  ],
};

export default function FeatureConfigPage() {
  return (
    <DynamicForm
      schema={schema}
      onSubmit={async (values) => {
        // è°ƒç”¨åç«¯ä¿å­˜
        console.log('submit', values);
      }}
    />
  );
}
```

### âœ… æœ¬é¢˜å…³é”®ä»£ç ç¤ºä¾‹ï¼ˆâ‰¥3ï¼‰

1. `schema.ts`ï¼ˆåŠ¨æ€è¡¨å•ç±»å‹å®šä¹‰ï¼‰âœ”
2. `rules.ts`ï¼ˆéªŒè¯è§„åˆ™ç”Ÿæˆå™¨ï¼‰âœ”
3. `DynamicForm.tsx`ï¼ˆé€šç”¨åŠ¨æ€æ¸²æŸ“ + normalize + æäº¤ï¼‰âœ”

### âœ… æœ€ä½³å®è·µ

* å­—æ®µæ˜ å°„ä¸€å¤„ç»´æŠ¤ï¼Œé¿å…æ•£è½åœ¨å„ä¸ªé¡µé¢ã€‚
* å¤æ‚æ§ä»¶ï¼ˆUploadï¼‰ç»Ÿä¸€è§„èŒƒ **value çš„ normalize**ã€‚
* è¡¨å•æ ¡éªŒå°½é‡æ¥è‡ª schemaï¼Œé¡µé¢åªå…³å¿ƒæäº¤ã€‚

### âš ï¸ å¸¸è§å‘

* Upload é»˜è®¤ä¼šè‡ªåŠ¨ä¸Šä¼ ï¼›ä½¿ç”¨ `beforeUpload={() => false}` å…³é—­ï¼Œäº¤ç”±ç»Ÿä¸€æäº¤å¤„ç†ã€‚
* `Switch` éœ€è¦ `valuePropName="checked"`ã€‚

---

## ğŸ“Œ é—®é¢˜4ï¼šåˆ†é¡µåˆ—è¡¨ä¸æ•°æ®è¡¨æ ¼ï¼ˆé€šç”¨åŒ–ï¼‰

### 1) usePagination

```ts
// shared/hooks/usePagination.ts
import { useCallback, useMemo, useState } from 'react';

export function usePagination(initial = { page: 1, pageSize: 10 }) {
  const [page, setPage] = useState<number>(initial.page);
  const [pageSize, setPageSize] = useState<number>(initial.pageSize);
  const onChange = useCallback((p: number, ps?: number) => {
    setPage(p);
    if (ps && ps !== pageSize) setPageSize(ps);
  }, [pageSize]);

  return useMemo(() => ({ page, pageSize, setPage, setPageSize, onChange }), [page, pageSize, onChange]);
}
```

### 2) useTableFilter

```ts
// shared/hooks/useTableFilter.ts
import { useState, useMemo } from 'react';

export function useTableFilter<T extends Record<string, any>>(initial?: T) {
  const [filters, setFilters] = useState<T>(initial ?? ({} as T));
  const reset = () => setFilters(initial ?? ({} as T));
  return useMemo(() => ({ filters, setFilters, reset }), [filters]);
}
```

### 3) useTableDataï¼ˆåŠ è½½ + è½®è¯¢ + å–æ¶ˆï¼‰

```ts
// shared/hooks/useTableData.ts
import { useEffect, useMemo, useRef, useState } from 'react';

type Fn<T> = (params: Record<string, any>, signal?: AbortSignal) => Promise<{ items: T[]; total: number }>;

export function useTableData<T>(fetcher: Fn<T>, params: Record<string, any>, options?: { pollMs?: number }) {
  const [data, setData] = useState<T[]>([]);
  const [total, setTotal] = useState(0);
  const [loading, setLoading] = useState(false);
  const ctrlRef = useRef<AbortController | null>(null);

  async function load() {
    ctrlRef.current?.abort();
    const ctrl = new AbortController();
    ctrlRef.current = ctrl;
    setLoading(true);
    try {
      const res = await fetcher(params, ctrl.signal);
      setData(res.items);
      setTotal(res.total);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => { load(); /* eslint-disable-next-line */ }, [JSON.stringify(params)]);

  useEffect(() => {
    if (!options?.pollMs) return;
    const t = setInterval(load, options.pollMs);
    return () => clearInterval(t);
  }, [JSON.stringify(params), options?.pollMs]); // eslint-disable-line

  return { data, total, loading, reload: load };
}
```

### 4) é€šç”¨ DataTable & FilterBar

```tsx
// widgets/Tables/DataTable.tsx
'use client';
import { Table } from 'antd';
import type { TableProps } from 'antd';

export function DataTable<T extends { id: string | number }>(props: TableProps<T>) {
  return <Table<T> rowKey="id" {...props} />;
}
```

```tsx
// widgets/Tables/FilterBar.tsx
'use client';
import { Button, Input, Select, Space } from 'antd';

type Props = {
  onSearch: () => void;
  onReset: () => void;
  children?: React.ReactNode; // å¯æ’é¢å¤–è¿‡æ»¤æ§ä»¶
  keywordState: [string, (v: string) => void];
  roleState?: [string | undefined, (v?: string) => void];
};

export function FilterBar({ onSearch, onReset, children, keywordState, roleState }: Props) {
  const [kw, setKw] = keywordState;
  const [role, setRole] = roleState ?? [];
  return (
    <Space style={{ marginBottom: 12 }} wrap>
      <Input placeholder="æœç´¢å…³é”®å­—" style={{ width: 240 }} value={kw} onChange={(e) => setKw(e.target.value)} />
      {roleState && (
        <Select
          allowClear
          placeholder="è§’è‰²"
          style={{ width: 160 }}
          value={role}
          onChange={setRole as any}
          options={[
            { value: 'user', label: 'ç”¨æˆ·' },
            { value: 'reseller', label: 'åˆ†é”€' },
            { value: 'admin', label: 'ç®¡ç†å‘˜' },
          ]}
        />
      )}
      {children}
      <Button type="primary" onClick={onSearch}>æŸ¥è¯¢</Button>
      <Button onClick={onReset}>é‡ç½®</Button>
    </Space>
  );
}
```

### 5) ç¤ºä¾‹ï¼šç”¨æˆ·ç®¡ç†é¡µï¼ˆåˆ†é¡µ/ç­›é€‰/è½®è¯¢ï¼‰

```tsx
// app/(admin)/users/page.tsx
'use client';
import { DataTable } from '@/widgets/Tables/DataTable';
import { FilterBar } from '@/widgets/Tables/FilterBar';
import { usePagination } from '@/shared/hooks/usePagination';
import { useTableFilter } from '@/shared/hooks/useTableFilter';
import { useTableData } from '@/shared/hooks/useTableData';
import { api } from '@/shared/api/axios';
import type { ColumnsType } from 'antd/es/table';
import { Tag } from 'antd';

type User = { id: number; email: string; nickname?: string; roles: string[]; created_at: string };

async function fetchUsers(params: Record<string, any>) {
  const res = await api.get<{ data: { items: User[]; total: number } }>('/admin/users', { params });
  return res.data.data;
}

export default function AdminUsersPage() {
  const { page, pageSize, onChange } = usePagination({ page: 1, pageSize: 10 });
  const { filters, setFilters, reset } = useTableFilter<{ kw?: string; role?: string }>({});

  const params = { page, pageSize, ...filters };
  const { data, total, loading, reload } = useTableData<User>(fetchUsers, params, { pollMs: 0 });

  const columns: ColumnsType<User> = [
    { title: 'ID', dataIndex: 'id' },
    { title: 'é‚®ç®±', dataIndex: 'email' },
    { title: 'æ˜µç§°', dataIndex: 'nickname' },
    { title: 'è§’è‰²', dataIndex: 'roles', render: (r: string[]) => r.map(x => <Tag key={x}>{x}</Tag>) },
    { title: 'åˆ›å»ºæ—¶é—´', dataIndex: 'created_at' },
  ];

  return (
    <>
      <FilterBar
        keywordState={[filters.kw ?? '', (v) => setFilters((p) => ({ ...p, kw: v }))]}
        roleState={[filters.role, (v?: string) => setFilters((p) => ({ ...p, role: v }))]}
        onSearch={reload}
        onReset={() => { reset(); reload(); }}
      />
      <DataTable<User>
        loading={loading}
        columns={columns}
        dataSource={data}
        pagination={{ current: page, pageSize, total, onChange }}
      />
    </>
  );
}
```

### âœ… æœ¬é¢˜å…³é”®ä»£ç ç¤ºä¾‹ï¼ˆâ‰¥3ï¼‰

1. `usePagination` âœ”
2. `useTableFilter` âœ”
3. `useTableData`ï¼ˆå«å–æ¶ˆ/è½®è¯¢ï¼‰âœ”
4. `DataTable` / `FilterBar` + å®Œæ•´é¡µé¢ç¤ºä¾‹ âœ”

### âœ… æœ€ä½³å®è·µ

* `useTableData` å‚æ•°ä½¿ç”¨ `JSON.stringify(params)` è§¦å‘ä¾èµ–å˜æ›´ï¼Œç®€å•å¯é ã€‚
* è½®è¯¢åªåœ¨ç¡®æœ‰éœ€è¦ï¼ˆä»»åŠ¡ç›‘æ§ï¼‰å¼€å¯ï¼Œé¿å…æ— æ„ä¹‰è¯·æ±‚ã€‚
* `DataTable` ç»Ÿä¸€ `rowKey` çº¦å®šï¼Œåˆ—æ¸²æŸ“ä¿æŒâ€œçº¯â€ã€‚

### âš ï¸ å¸¸è§å‘

* ä¾èµ–é¡¹å¯¹è±¡å¼•ç”¨å˜åŒ–å¯¼è‡´æ— é™è¯·æ±‚ï¼šç”¨å­—ç¬¦ä¸²åŒ–æˆ– `use-deep-compare`ã€‚
* åˆ†é¡µå˜åŒ–/è¿‡æ»¤å˜åŒ–éœ€è¦åˆå¹¶å‚æ•°ï¼ˆç¤ºä¾‹å·²åˆå¹¶ï¼‰ã€‚

---

## ğŸ“Œ é—®é¢˜5ï¼šæƒé™ç®¡ç†ä¸è·¯ç”±å®ˆå«ï¼ˆRBACï¼‰

### 1) æƒé™æ•°æ®ç»“æ„

```ts
// features/permissions/model/permission.ts
export type Role = 'user' | 'reseller' | 'admin';
export type Resource = 'workbench' | 'library' | 'reseller_center' | 'admin_panel';
export type Action = 'view' | 'manage';

export type Permission = { resource: Resource; action: Action };

export const ROLE_PERMISSIONS: Record<Role, Permission[]> = {
  user: [
    { resource: 'workbench', action: 'view' },
    { resource: 'library', action: 'view' },
  ],
  reseller: [
    { resource: 'workbench', action: 'view' },
    { resource: 'library', action: 'view' },
    { resource: 'reseller_center', action: 'manage' },
  ],
  admin: [
    { resource: 'workbench', action: 'view' },
    { resource: 'library', action: 'view' },
    { resource: 'admin_panel', action: 'manage' },
  ],
};

export function can(roleList: Role[], resource: Resource, action: Action) {
  return roleList.some(r => ROLE_PERMISSIONS[r]?.some(p => p.resource === resource && p.action === action));
}
```

### 2) Next.js App Router ä¸­çš„è·¯ç”±å®ˆå«

* **middleware.ts** ä¸Šé¢˜å·²ç»™ï¼ˆæŒ‰è·¯å¾„å‰ç¼€ + Cookie è§’è‰²åšé¦–å±‚æ‹¦æˆªï¼‰ã€‚
* é¡µé¢/å¸ƒå±€å±‚å†ç”¨ `PermissionGuard` ç»†åŒ–ã€‚

### 3) `<PermissionGuard>` ç»„ä»¶

å·²ç»™å‡ºï¼ˆæœ¬é¢˜1çš„ä»£ç ï¼‰ï¼Œå¯æŒ‰èµ„æº/åŠ¨ä½œå°è£…ä¸€ä¸ªå˜ä½“ï¼š

```tsx
export function PermissionBy({ resource, action, children }: { resource: Resource; action: Action; children: React.ReactNode }) {
  const roles = useRootStore(s => s.user?.roles ?? []);
  return can(roles as Role[], resource, action) ? <>{children}</> : <Result status="403" title="æ— è®¿é—®æƒé™" />;
}
```

### 4) åŠ¨æ€å¯¼èˆªèœå•ï¼ˆæ ¹æ®æƒé™è¿‡æ»¤ï¼‰

```ts
// widgets/Navigation/menu.config.ts
import type { ItemType } from 'antd/es/menu/hooks/useItems';
import { Role, can } from '@/features/permissions/model/permission';

export type NavItem = { key: string; label: string; href: string; resource?: 'workbench'|'library'|'reseller_center'|'admin_panel'; action?: 'view'|'manage' };

const ALL: NavItem[] = [
  { key: 'workbench', label: 'å·¥ä½œå°', href: '/workbench', resource: 'workbench', action: 'view' },
  { key: 'library', label: 'ç´ æåº“', href: '/library', resource: 'library', action: 'view' },
  { key: 'reseller', label: 'åˆ†é”€ä¸­å¿ƒ', href: '/reseller', resource: 'reseller_center', action: 'manage' },
  { key: 'admin', label: 'ç®¡ç†åå°', href: '/admin', resource: 'admin_panel', action: 'manage' },
];

export function buildMenu(roles: Role[]): ItemType[] {
  return ALL.filter(i => !i.resource || can(roles, i.resource, i.action ?? 'view'))
    .map(i => ({ key: i.key, label: i.label, onClick: () => location.assign(i.href) }));
}
```

ä¾§è¾¹æ ä½¿ç”¨ï¼š

```tsx
'use client';
import { Menu } from 'antd';
import { buildMenu } from './menu.config';
import { useRootStore } from '@/shared/store/store';

export function SideNav() {
  const roles = useRootStore(s => (s.user?.roles ?? []) as any);
  const items = buildMenu(roles);
  return <Menu mode="inline" items={items} />;
}
```

### âœ… æœ¬é¢˜å…³é”®ä»£ç ç¤ºä¾‹ï¼ˆâ‰¥3ï¼‰

1. `permission.ts`ï¼ˆRBAC ç»“æ„ä¸ `can`ï¼‰âœ”
2. `middleware.ts`ï¼ˆè·¯å¾„å®ˆå«ï¼‰âœ”
3. `PermissionGuard` / `PermissionBy` âœ”
4. åŠ¨æ€èœå•ç”Ÿæˆ `buildMenu` âœ”

### âœ… æœ€ä½³å®è·µ

* **èµ„æº/åŠ¨ä½œ** ç»Ÿä¸€æšä¸¾ï¼Œé¿å…åˆ°å¤„å†™å­—ç¬¦ä¸²ã€‚
* èœå•ä»…åšæ˜¾ç¤ºè¿‡æ»¤ï¼Œ**çœŸæ­£çš„æƒé™åˆ¤å®š** ç”± Guard å’Œåç«¯æ¥å£åŒé‡æ ¡éªŒã€‚
* ä¸­é—´ä»¶è´Ÿè´£â€œæ˜¯å¦ç™»å½• + ç²—ç²’åº¦è·¯å¾„â€ï¼›é¡µé¢è´Ÿè´£â€œç»†ç²’åº¦èµ„æºæƒé™â€ã€‚

### âš ï¸ å¸¸è§å‘

* åªåšå‰ç«¯èœå•è¿‡æ»¤æ˜¯ä¸å¤Ÿçš„ï¼›æ¥å£å¿…é¡»æ ¡éªŒè§’è‰²/æƒé™ã€‚
* ä¸­é—´ä»¶æ˜¯åœ¨ **è¾¹ç¼˜è¿è¡Œ**ï¼Œä¸è¦å¼•ç”¨ Node ä¸“å± APIã€‚

---

## ğŸ“Œ é—®é¢˜6ï¼šAPI è¯·æ±‚ä¸é”™è¯¯å¤„ç†ï¼ˆaxios å·¥ä¸šçº§å°è£…ï¼‰

### 1) axios å®ä¾‹ä¸æ‹¦æˆªå™¨ï¼ˆtoken/åˆ·æ–°/é”™è¯¯ç»Ÿä¸€ï¼‰

```ts
// shared/api/axios.ts
import axios, { AxiosError } from 'axios';
import { getRequestCache, setRequestCache, getInflight, setInflight, deleteInflight } from '@/shared/lib/cache';

export const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_BASE_URL,
  timeout: 15_000,
  withCredentials: true,
});

// è¯·æ±‚æ‹¦æˆªï¼šè‡ªåŠ¨é™„å¸¦ tokenï¼ˆä» cookie æˆ– storeï¼‰
api.interceptors.request.use((config) => {
  // è‹¥éœ€è¦ä» Zustand è¯»ï¼Œè¯·åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ï¼›æœåŠ¡ç«¯ç”¨ cookie
  // è¿™é‡Œåªç¤ºä¾‹ä» cookieï¼ˆç”±åç«¯è®¾ç½® httpOnlyï¼‰è‡ªåŠ¨æºå¸¦ withCredentials å³å¯
  // å»é‡/ç¼“å­˜é”®
  const key = `${config.method}|${config.url}|${JSON.stringify(config.params)}|${JSON.stringify(config.data)}`;
  (config as any).__cacheKey = key;

  // ç®€å• GET ç¼“å­˜å‘½ä¸­ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
  if (config.method === 'get') {
    const cached = getRequestCache(key);
    if (cached) {
      // é€šè¿‡è‡ªå®šä¹‰ adapter è¿”å›ç¼“å­˜ï¼ˆè·³è¿‡çœŸæ­£è¯·æ±‚ï¼‰
      config.adapter = async () => ({ data: cached, status: 200, statusText: 'OK', headers: {}, config });
      return config;
    }
  }

  // è¯·æ±‚åˆå¹¶ï¼ˆåŒä¸€ key çš„å¹¶å‘åªå‘ä¸€æ¬¡ï¼‰
  if (getInflight(key)) {
    config.cancelToken = new axios.CancelToken((c) => c('DUPLICATED_REQUEST'));
  } else {
    setInflight(key);
  }
  return config;
});

// å“åº”æ‹¦æˆªï¼šç¼“å­˜ã€ç»Ÿä¸€é”™è¯¯ã€401 è‡ªåŠ¨åˆ·æ–°
api.interceptors.response.use(
  (res) => {
    const key = (res.config as any).__cacheKey as string;
    if (res.config.method === 'get') setRequestCache(key, res.data, 30_000); // 30s TTL
    deleteInflight(key);
    return res;
  },
  async (error: AxiosError) => {
    const config: any = error.config ?? {};
    const key = config.__cacheKey;
    deleteInflight(key);

    // è¢«åˆå¹¶/å–æ¶ˆçš„è¯·æ±‚ç›´æ¥è¿”å›ï¼ˆç”±é¦–ä¸ªè¯·æ±‚ç»“æœæ›´æ–° UIï¼‰
    if (axios.isCancel(error) && error.message === 'DUPLICATED_REQUEST') return Promise.reject(error);

    // 401ï¼šå°è¯•åˆ·æ–°
    if (error.response?.status === 401 && !config.__retried) {
      config.__retried = true;
      try {
        await axios.post(`${process.env.NEXT_PUBLIC_API_BASE_URL}/auth/refresh`, {}, { withCredentials: true });
        return api.request(config);
      } catch {
        // åˆ·æ–°å¤±è´¥ -> è·³ç™»å½•
        if (typeof window !== 'undefined') location.assign(`/login?redirect=${encodeURIComponent(location.pathname)}`);
      }
    }

    // ç»Ÿä¸€é”™è¯¯
    const msg = (error.response?.data as any)?.message ?? error.message ?? 'ç½‘ç»œé”™è¯¯';
    return Promise.reject(new Error(msg));
  }
);
```

**ç®€æ˜“ç¼“å­˜/å»é‡ï¼ˆshared/lib/cache.tsï¼‰**

```ts
const cache = new Map<string, { exp: number; data: any }>();
const inflight = new Set<string>();

export function setRequestCache(key: string, data: any, ttlMs: number) {
  cache.set(key, { exp: Date.now() + ttlMs, data });
}
export function getRequestCache(key: string) {
  const v = cache.get(key);
  if (!v) return null;
  if (Date.now() > v.exp) { cache.delete(key); return null; }
  return v.data;
}

export const getInflight = (key: string) => inflight.has(key);
export const setInflight = (key: string) => inflight.add(key);
export const deleteInflight = (key: string) => inflight.delete(key);
```

### 2) useRequest Hookï¼ˆloading/error/dataã€é‡è¯•ã€å–æ¶ˆï¼‰

```ts
// shared/api/useRequest.ts
import { useCallback, useEffect, useRef, useState } from 'react';

type Options<TParams> = {
  manual?: boolean;
  defaultParams?: TParams;
  retry?: number;
  retryDelayMs?: number;
};

export function useRequest<TData, TParams extends any[] | Record<string, any> = Record<string, any>>(
  service: (params: TParams, signal?: AbortSignal) => Promise<TData>,
  options?: Options<TParams>
) {
  const { manual, defaultParams, retry = 0, retryDelayMs = 500 } = options ?? {};
  const [data, setData] = useState<TData | undefined>();
  const [error, setError] = useState<Error | undefined>();
  const [loading, setLoading] = useState(false);
  const ctrlRef = useRef<AbortController | null>(null);

  const run = useCallback(async (params?: TParams) => {
    ctrlRef.current?.abort();
    const ctrl = new AbortController();
    ctrlRef.current = ctrl;

    setLoading(true); setError(undefined);
    let attempts = 0;
    while (true) {
      try {
        const d = await service((params ?? defaultParams!) as TParams, ctrl.signal);
        setData(d); return d;
      } catch (e: any) {
        if (ctrl.signal.aborted) throw e;
        if (attempts < retry) {
          attempts++; await new Promise(r => setTimeout(r, retryDelayMs * attempts));
          continue;
        }
        setError(e); throw e;
      } finally {
        setLoading(false);
      }
    }
  }, [service, defaultParams, retry, retryDelayMs]);

  const cancel = useCallback(() => { ctrlRef.current?.abort(); }, []);

  useEffect(() => {
    if (!manual && defaultParams) run(defaultParams);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return { data, error, loading, run, cancel };
}
```

**ç±»å‹æ¨æ–­**ï¼šé€šè¿‡æ³›å‹ `TData/TParams` è‡ªåŠ¨ä» `service` ä¼ å…¥çš„è¿”å›å€¼ä¸å‚æ•°ç±»å‹æ¨æ–­ã€‚

### 3) é¡µé¢ä½¿ç”¨ç¤ºä¾‹ï¼ˆè‡ªåŠ¨/æ‰‹åŠ¨ã€é‡è¯•ã€å–æ¶ˆï¼‰

```tsx
'use client';
import { api } from '@/shared/api/axios';
import { useRequest } from '@/shared/api/useRequest';
import { Button, Alert, Spin } from 'antd';

type Profile = { id: number; email: string; nickname?: string };

async function fetchProfile(_: void, signal?: AbortSignal): Promise<Profile> {
  const res = await api.get<{ data: Profile }>('/me', { signal });
  return res.data.data;
}

export default function ProfileCard() {
  const { data, error, loading, run, cancel } = useRequest<Profile, void>(fetchProfile, { manual: false, defaultParams: undefined, retry: 2 });

  if (loading && !data) return <Spin />;
  if (error) return <Alert type="error" message={error.message} />;

  return (
    <div>
      <div>é‚®ç®±ï¼š{data?.email}</div>
      <Button onClick={() => run(undefined)}>åˆ·æ–°</Button>
      <Button onClick={cancel}>å–æ¶ˆ</Button>
    </div>
  );
}
```

### 4) è¯·æ±‚/å“åº”ç±»å‹æ¨æ–­

* é€šè¿‡ `service` å‡½æ•°è¿”å›å€¼ `Promise<TData>` ä¸ `useRequest<TData, TParams>` æ³›å‹ï¼Œç»„ä»¶è‡ªåŠ¨è·å¾—ç±»å‹å®‰å…¨çš„ `data`ã€`run(params)`ã€‚

### âœ… æœ¬é¢˜å…³é”®ä»£ç ç¤ºä¾‹ï¼ˆâ‰¥3ï¼‰

1. `axios.ts`ï¼ˆæ‹¦æˆªå™¨ + ç¼“å­˜ + å»é‡ + åˆ·æ–°ï¼‰âœ”
2. `cache.ts`ï¼ˆç®€å•å†…å­˜ç¼“å­˜ä¸å¹¶å‘å»é‡ï¼‰âœ”
3. `useRequest.ts`ï¼ˆé‡è¯•/å–æ¶ˆ/æ‰‹åŠ¨è§¦å‘ï¼‰âœ”
4. é¡µé¢ `ProfileCard` ä½¿ç”¨ç¤ºä¾‹ âœ”

### âœ… æœ€ä½³å®è·µ

* GET çš„ **çŸ­ TTL ç¼“å­˜** + **å¹¶å‘è¯·æ±‚å»é‡**ï¼Œæå¤§é™ä½ç›¸åŒåˆ—è¡¨çš„é‡å¤è¯·æ±‚ã€‚
* é”™è¯¯ç»Ÿä¸€è½¬æ¢ä¸º `Error`ï¼ŒUI åªå¤„ç† `error.message`ã€‚
* 401 åˆ·æ–°ä»…å°è¯•ä¸€æ¬¡ï¼Œå¤±è´¥åˆ™è·³è½¬ç™»å½•ï¼ˆä¿ç•™ redirectï¼‰ã€‚

### âš ï¸ å¸¸è§å‘

* å†…å­˜ç¼“å­˜ä»…åœ¨å½“å‰æ ‡ç­¾é¡µæœ‰æ•ˆï¼›è·¨é¡µéœ€è¦ `zustand persist` æˆ– SWR/React Queryï¼ˆå¯åç»­å¼•å…¥ï¼‰ã€‚
* axios çš„å–æ¶ˆéœ€è¦ç”¨ `AbortController` æˆ– `CancelToken`ï¼ˆç¤ºä¾‹å·²ç”¨ `AbortController`ï¼‰ã€‚

---

## âœ… æ€»ç»“æ¸…å•ï¼ˆè¦†ç›– 6 é¢˜è¦æ±‚ï¼‰

* **ç›®å½•ç»“æ„**ï¼šåˆ†å±‚æ¸…æ™°ï¼ˆapp/entities/features/widgets/sharedï¼‰ï¼ŒèŒè´£æ˜ç¡®ã€‚
* **ç»„ä»¶åˆ†å±‚**ï¼šå±•ç¤º/å®¹å™¨/é¡µé¢åˆ†å·¥ï¼Œé¡µé¢å°½é‡è–„ã€‚
* **çŠ¶æ€ç®¡ç†**ï¼šZustand åˆ‡ç‰‡åŒ– + persistï¼Œæ˜ç¡®å…¨å±€/å±€éƒ¨è¾¹ç•Œã€‚
* **è·¯ç”±ä¸æƒé™**ï¼š`middleware.ts` ç²—ç²’åº¦å®ˆå« + `PermissionGuard` ç²¾ç»†åŒ–ï¼›RBAC ç±»å‹ä¸ `can`ã€‚
* **ç±»å‹ç³»ç»Ÿ**ï¼šä¸¥æ ¼ TS é…ç½® + é€šç”¨ç±»å‹é›†ä¸­ç®¡ç†ã€‚
* **æ ·å¼ä¸è®¾è®¡ç³»ç»Ÿ**ï¼šç»Ÿä¸€ `AppThemeProvider` + äºŒæ¬¡å°è£…æ§ä»¶ã€‚
* **åŠŸèƒ½é…ç½®**ï¼šFeatureCard/Grid + åŠ¨æ€å›¾æ ‡ + TTL ç¼“å­˜ã€‚
* **åŠ¨æ€è¡¨å•**ï¼šå­—æ®µæ˜ å°„/è§„åˆ™ç”Ÿæˆ/normalize/ç»Ÿä¸€æäº¤ã€‚
* **è¡¨æ ¼é€šç”¨åŒ–**ï¼šusePagination/useTableFilter/useTableData + DataTable/FilterBar + ç¤ºä¾‹é¡µã€‚
* **è¯·æ±‚ä¸é”™è¯¯å¤„ç†**ï¼šaxios å·¥ä¸šåŒ–å°è£…ï¼ˆtoken/åˆ·æ–°/ç¼“å­˜/å»é‡/é‡è¯•/å–æ¶ˆï¼‰+ `useRequest`ã€‚

å¦‚æœä½ å¸Œæœ›ï¼Œæˆ‘å¯ä»¥æŠŠè¿™äº›æ–‡ä»¶æŒ‰æ¨¡å—æ‰“åŒ…æˆä¸€ä¸ªæœ€å°å¯è¿è¡Œæ¨¡æ¿ï¼ˆå« `package.json` çš„ä¾èµ–ä¸è„šæ‰‹æ¶è¯´æ˜ï¼‰ï¼Œä¾¿äºç›´æ¥è½åœ°å¯¹æ¯”é‡æ„å‰åçš„ä»£ç å¤æ‚åº¦ä¸é‡å¤ç‡ã€‚
