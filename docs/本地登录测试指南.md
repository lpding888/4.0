# 本地登录测试指南

**创建时间**：2025-10-30
**创建者**：老王（CodeBuddy Deploy Skill）

---

## 🎯 登录流程说明

本系统使用**手机号+验证码**登录方式，流程如下：

1. 用户输入手机号
2. 点击"发送验证码"
3. 系统发送6位数字验证码（开发环境只打印在后端日志）
4. 用户输入收到的验证码
5. 点击"登录"完成认证

---

## 📱 开发环境登录方式

### 方式1：使用任意手机号+查看后端日志获取验证码（推荐）

#### 步骤1：访问登录页面

打开浏览器访问：http://localhost:3001/login

#### 步骤2：输入手机号

可以使用任意合法的手机号，例如：
- `13800138000`
- `13912345678`
- `15900000000`

#### 步骤3：点击"发送验证码"

前端会调用后端API：`POST /api/auth/send-code`

#### 步骤4：查看后端日志获取验证码

**重要**：在开发环境下，验证码不会真正发送短信，而是打印在后端控制台日志中！

查看后端终端输出，找到类似这样的日志：
```
info: [SMS] 发送验证码到 13800138000: 258741
info: 验证码已发送: phone=13800138000, ip=::1
```

其中 `258741` 就是验证码！

#### 步骤5：输入验证码并登录

在前端页面输入刚才日志中看到的验证码，点击"登录"即可。

**验证码有效期**：5分钟

---

### 方式2：直接使用后端API测试（开发者）

#### 步骤1：发送验证码

```bash
# 发送验证码
curl -X POST http://localhost:3000/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'
```

**返回示例**：
```json
{
  "success": true,
  "data": {
    "expireIn": 300
  },
  "message": "验证码已发送"
}
```

#### 步骤2：查看后端日志获取验证码

在后端终端看到：
```
info: [SMS] 发送验证码到 13800138000: 123456
```

#### 步骤3：使用验证码登录

```bash
# 登录
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"123456"}'
```

**返回示例**：
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user_abc123",
      "phone": "13800138000",
      "role": "user",
      "isMember": false,
      "quota_remaining": 0,
      "quota_expireAt": null
    }
  }
}
```

---

## ⚠️ 注意事项

### 1. 验证码只在后端日志中

**开发环境不会真的发送短信**！验证码会打印在后端控制台，格式：
```
info: [SMS] 发送验证码到 <手机号>: <6位数字>
```

### 2. 验证码有效期

- 有效期：**5分钟**
- 过期后需要重新发送

### 3. 验证码使用次数

- 每个验证码只能使用**1次**
- 使用后会被标记为已使用

### 4. 防刷限制

为了防止恶意刷验证码，系统有以下限制：
- 同一手机号：1分钟内最多发送5次
- 同一IP地址：1小时内最多发送20次

### 5. 自动注册

如果手机号是第一次登录，系统会自动创建新用户：
- 默认角色：`user`
- 默认不是会员：`isMember = false`
- 默认配额：`quota_remaining = 0`

---

## 🧪 完整测试流程

### 测试场景1：首次注册登录

```bash
# 1. 发送验证码
curl -X POST http://localhost:3000/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"13900000001"}'

# 2. 查看后端日志获取验证码（假设是：234567）

# 3. 登录（自动注册新用户）
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13900000001","code":"234567"}'

# 4. 返回token和用户信息
```

### 测试场景2：老用户登录

```bash
# 1. 发送验证码
curl -X POST http://localhost:3000/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'

# 2. 查看后端日志获取验证码

# 3. 登录（使用已存在的用户）
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"<从日志获取>"}'
```

### 测试场景3：验证码错误

```bash
# 使用错误的验证码
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"000000"}'

# 返回错误
{
  "success": false,
  "error": {
    "code": 2002,
    "message": "验证码错误或已过期"
  }
}
```

### 测试场景4：验证码过期

```bash
# 1. 发送验证码
curl -X POST http://localhost:3000/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'

# 2. 等待超过5分钟

# 3. 尝试登录
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"<验证码>"}'

# 返回错误
{
  "success": false,
  "error": {
    "code": 2002,
    "message": "验证码错误或已过期"
  }
}
```

---

## 🔍 常见问题

### Q1：在哪里查看验证码？

**A**：在后端终端（运行 `npm run dev` 的那个窗口）查看日志，找到这行：
```
info: [SMS] 发送验证码到 <手机号>: <验证码>
```

### Q2：验证码在前端页面看不到？

**A**：对的！开发环境下验证码不会显示在前端，只会打印在后端日志。这是为了模拟真实环境（验证码通过短信发送）。

### Q3：可以使用固定的验证码吗（比如123456）？

**A**：不可以！每次发送验证码都会随机生成6位数字，必须查看后端日志获取实际的验证码。

### Q4：为什么我输入验证码后提示错误？

**可能原因**：
1. 验证码输入错误（检查日志中的验证码）
2. 验证码已过期（超过5分钟）
3. 验证码已被使用过
4. 手机号和验证码不匹配

**解决方案**：重新发送验证码，并立即使用

### Q5：后端日志在哪里？

**A**：在你启动后端的终端窗口中。如果找不到，重新运行：
```bash
cd backend
npm run dev
```
然后在这个终端窗口查看日志输出。

### Q6：生产环境怎么办？

**A**：生产环境会真正调用腾讯云短信服务发送验证码到用户手机，不会打印在日志中。

---

## 📋 验证码代码逻辑说明

### 发送验证码流程

```javascript
// backend/src/services/auth.service.js

async sendCode(phone, ip) {
  // 1. 防刷限制检查
  await this.checkRateLimit(phone, ip);

  // 2. 生成6位随机数字验证码
  const code = generateCode(6);
  const expireAt = new Date(Date.now() + 5 * 60 * 1000); // 5分钟有效期

  // 3. 保存验证码到数据库
  await db('verification_codes').insert({
    phone,
    code,
    ip,
    expireAt,
    used: false
  });

  // 4. 发送短信（开发环境只打印日志）
  await this.sendSMS(phone, code);

  return { expireIn: 300 };
}
```

### 验证码校验流程

```javascript
async verifyCode(phone, code) {
  // 从数据库查找
  const record = await db('verification_codes')
    .where('phone', phone)
    .where('code', code)
    .where('used', false)              // 未使用
    .where('expireAt', '>=', new Date())  // 未过期
    .orderBy('created_at', 'desc')
    .first();

  if (!record) {
    throw {
      statusCode: 401,
      errorCode: 2002,
      message: '验证码错误或已过期'
    };
  }
}
```

---

## 🎉 快速开始

**最简单的测试方法**：

1. 打开浏览器：http://localhost:3001/login
2. 输入手机号：`13800138000`
3. 点击"发送验证码"
4. 切换到后端终端，复制日志中的6位数字验证码
5. 回到浏览器，输入验证码
6. 点击"登录"

**就这么简单！** 🚀

---

**🤖 Generated by 老王（CodeBuddy Deploy Skill）**
**📅 时间：2025-10-30 16:20**
