# 任务卡：QA验收测试 - 活动营销系统

> **负责技能**：qa_acceptance_skill
> **优先级**：P0
> **预计工期**：0.5天

---

## 任务目标

对活动营销系统进行全面的功能验收测试，确保所有功能正常、数据准确、用户体验良好。

---

## 测试范围

### 用户端功能
1. 活动列表页展示
2. 领取优惠券
3. 我的优惠券页面
4. 使用优惠券购买会员
5. 支付流程

### 管理员端功能
1. 创建活动
2. 编辑活动
3. 查看活动详情
4. 下线活动
5. 查看数据统计

---

## 测试清单

### 功能测试

#### 场景1：用户领取和使用优惠券（完整流程）
1. [ ] 登录用户进入工作台，看到"优惠活动"入口卡片
2. [ ] 点击进入活动列表页 `/promotions`
3. [ ] 看到至少1个正在进行的活动
4. [ ] 点击"立即领取"按钮，领取成功
5. [ ] 页面toast提示"领取成功"
6. [ ] 按钮变为"已领取"灰色状态
7. [ ] 进入"我的优惠券"页面，看到刚领取的券
8. [ ] 进入会员购买页 `/membership/buy`
9. [ ] 看到"可用优惠券"区域
10. [ ] 选择刚才领取的券
11. [ ] 实时显示折后价（例如 ¥99 → ¥79）
12. [ ] 点击"支付 ¥79"
13. [ ] 跳转微信支付，金额为 ¥79
14. [ ] 支付成功后，配额增加100次
15. [ ] 优惠券状态变为"已使用"

**预期结果**：所有步骤顺利完成，数据准确

#### 场景2：重复领取同一券
1. [ ] 用户已领取活动A的券
2. [ ] 再次点击活动A的"立即领取"
3. [ ] 提示"您已领取过该券"
4. [ ] 按钮显示"已领取"

**预期结果**：不允许重复领取

#### 场景3：优惠券已抢光
1. [ ] 活动库存为0
2. [ ] 用户点击"立即领取"
3. [ ] 提示"优惠券已抢光"
4. [ ] 按钮显示"已抢光"

**预期结果**：正确提示

#### 场景4：优惠券已过期
1. [ ] 用户有一张已过期的券
2. [ ] 进入会员购买页
3. [ ] 该券不可选择，显示为灰色
4. [ ] Tooltip提示"已过期"

**预期结果**：无法使用过期券

#### 场景5：订单金额不满足使用条件
1. [ ] 优惠券条件：满¥199可用
2. [ ] 用户购买¥99套餐
3. [ ] 该券不可选择
4. [ ] Tooltip提示"订单金额不满足条件"

**预期结果**：无法使用不满足条件的券

#### 场景6：支付失败后券状态恢复
1. [ ] 用户选择优惠券创建订单
2. [ ] 跳转微信支付
3. [ ] 关闭支付页面（不支付）
4. [ ] 等待15分钟订单超时
5. [ ] 查看优惠券状态

**预期结果**：
- 订单状态变为"已取消"
- 优惠券状态从"锁定"恢复为"未使用"
- 用户可以再次使用该券

---

### 并发测试

#### 场景7：100并发领券
**测试工具**：使用ab或wrk工具

```bash
# 100并发领取同一活动
ab -n 100 -c 100 \
  -H "Authorization: Bearer TOKEN" \
  -p claim.json \
  http://localhost:3000/api/promotions/promo_123/claim
```

**验证点**：
- [ ] 最终`claimed_count`准确，不超过`total_quota`
- [ ] 没有超发现象
- [ ] 数据库数据一致

**预期结果**：并发安全，无超发

---

### 数据准确性测试

#### 测试1：优惠券库存一致性
```sql
SELECT
  p.claimed_count AS promotion_claimed,
  COUNT(uc.id) AS actual_claimed
FROM promotions p
LEFT JOIN user_coupons uc ON p.id = uc.promotion_id
WHERE p.id = 'promo_123'
GROUP BY p.id;
```

**预期结果**：`promotion_claimed` = `actual_claimed`

#### 测试2：折后价计算准确性
- [ ] 固定金额券：¥99 - ¥20 = ¥79 ✅
- [ ] 8折券：¥99 × 0.8 = ¥79.2 → ¥79 ✅
- [ ] 微信支付订单金额与计算结果一致 ✅

#### 测试3：GMV计算
```sql
SELECT SUM(final_amount) AS gmv
FROM orders
WHERE coupon_id IN (
  SELECT id FROM user_coupons WHERE promotion_id = 'promo_123'
) AND status = 'paid';
```

**预期结果**：GMV = 所有使用该券的订单实付之和

#### 测试4：核销率计算
```sql
SELECT
  COUNT(*) AS total_claimed,
  SUM(CASE WHEN status = 'used' THEN 1 ELSE 0 END) AS total_used,
  (SUM(CASE WHEN status = 'used' THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) AS usage_rate
FROM user_coupons
WHERE promotion_id = 'promo_123';
```

**预期结果**：核销率计算正确

---

### 管理员功能测试

#### 场景8：创建活动
1. [ ] 管理员登录
2. [ ] 进入活动管理页
3. [ ] 点击"创建活动"
4. [ ] 填写所有字段
5. [ ] 提交
6. [ ] 活动出现在列表中

**预期结果**：创建成功

#### 场景9：查看活动详情
1. [ ] 点击某个活动的"详情"
2. [ ] 看到完整的活动信息
3. [ ] 看到数据统计（已领取、已使用、核销率、GMV）
4. [ ] 看到领券记录
5. [ ] 看到核销记录

**预期结果**：数据完整准确

---

## 测试报告模板

```markdown
# 活动营销系统QA测试报告

## 测试时间
2025-10-XX

## 测试人
qa_acceptance_skill

## 测试环境
- 后端：develop分支
- 前端：develop分支
- 数据库：测试环境

## 测试结果总览
- ✅ 通过：XX 项
- ❌ 失败：XX 项
- 🟡 部分通过：XX 项

## 详细测试结果

### 用户端功能测试
- [x] 场景1：完整流程 ✅
- [x] 场景2：重复领取 ✅
- [x] 场景3：已抢光 ✅
- [x] 场景4：已过期 ✅
- [x] 场景5：金额不足 ✅
- [x] 场景6：支付失败恢复 ✅

### 并发测试
- [x] 场景7：100并发 ✅
- 结果：无超发，数据一致

### 数据准确性
- [x] 库存一致性 ✅
- [x] 折后价计算 ✅
- [x] GMV计算 ✅
- [x] 核销率计算 ✅

### 管理员功能
- [x] 场景8：创建活动 ✅
- [x] 场景9：查看详情 ✅

## 发现的Bug
无

## 最终判定
☑️ **测试通过**，可以上线

签字：____________
日期：____________
```

---

**预计工作量**：0.5天
