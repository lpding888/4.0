# 任务卡 - 总览 (用户积分系统)

> **系统**: 用户积分系统
> **版本**: v1.0
> **创建日期**: 2025-10-30
> **预计总工期**: 17天

---

## 📋 项目概述

用户积分系统是平台用户增长引擎的核心模块之一，通过积分机制激励用户日常活跃、完成任务、购买会员，提升用户留存率和活跃度，同时为平台带来更多转化。

**核心价值**：
- 提升用户日活跃度(DAU) 30%
- 提升用户7日留存率 20%
- 降低获客成本，提高付费转化率
- 为未来会员等级、用户勋章等功能打下基础

---

## 🎯 核心功能

### 1. 积分获取
- **注册奖励**: 新用户注册送100积分（一次性）
- **每日签到**: 连续签到积分递增（2→4→6→8→10积分）
- **任务系统**: 6种任务（完善资料、首次使用、分享作品、邀请好友、购买会员、评价结果）
- **购买会员**: 充值金额1:10比例赠送积分

### 2. 积分消费
- **兑换配额**: 100积分=1个处理配额（核心功能）
- **积分商城**: 兑换优惠券、会员时长、特权

### 3. 积分管理
- **积分过期**: 获得后365天过期，FIFO消费逻辑
- **积分冻结**: 管理员可冻结/解冻异常用户积分
- **手动调整**: 管理员可手动增减用户积分

### 4. 数据统计
- **统计大盘**: 总发放、总消费、过期积分、签到人次、兑换数据
- **趋势分析**: 每日积分发放和消费趋势图
- **分布分析**: 积分消费类型分布饼图

---

## 🗄️ 核心数据表

### 表1: points_accounts (积分账户表)
**字段**: user_id, total_points, available_points, frozen_points, used_points, expired_points

**核心逻辑**: `available_points = total_points - frozen_points - used_points - expired_points`

---

### 表2: points_records (积分记录流水表)
**字段**: id, user_id, change_type, change_amount, source_type, expire_at, is_expired

**用途**: 记录所有积分变动，实现FIFO消费逻辑

---

### 表3: points_consumptions (积分消费关联表)
**字段**: id, user_id, earn_record_id, consumed_amount

**用途**: 记录积分消费时具体从哪些earn记录扣减，实现FIFO逻辑

---

### 表4: checkin_records (签到记录表)
**字段**: id, user_id, checkin_date, consecutive_days, points_earned

**唯一约束**: (user_id, checkin_date) 防止重复签到

---

### 表5: task_completions (任务完成记录表)
**字段**: id, user_id, task_type, points_earned, completed_at

**用途**: 记录任务完成情况，校验每日/每月完成次数限制

---

### 表6: points_mall_items (积分商城商品表)
**字段**: id, item_type, item_name, points_required, stock, monthly_limit, status

**用途**: 存储商城商品信息

---

### 表7: points_redemptions (积分兑换记录表)
**字段**: id, user_id, item_type, points_cost, coupon_code, expire_at

**用途**: 记录所有兑换记录（配额+商城商品）

---

## 🔧 关键技术难点

### 难点1: FIFO积分消费逻辑

**问题**: 消费积分时，必须优先消耗即将过期的积分（先进先出）

**解决方案**:
1. 查询所有可用积分记录，按expire_at升序排列
2. 依次扣减，每次扣减都在points_consumptions表中记录关联关系
3. 扣减时需要计算该记录已被消费的积分（查询points_consumptions聚合）

**实现复杂度**: ⭐⭐⭐⭐⭐ (最高)

---

### 难点2: 并发安全性

**问题**: 多个用户同时兑换配额时，可能出现积分超扣问题

**解决方案**:
1. 使用数据库事务保证原子性
2. 使用行锁（forUpdate）防止并发读取
3. 扣除积分和增加配额必须在同一个事务中

**实现复杂度**: ⭐⭐⭐⭐ (高)

---

### 难点3: 积分过期清理

**问题**: 定时任务清理过期积分，逻辑复杂，影响用户权益

**解决方案**:
1. 每天凌晨3点执行定时任务
2. 查询所有已过期但未标记的记录（expire_at < 今天）
3. 按用户分组处理，更新账户和标记记录

**实现复杂度**: ⭐⭐⭐ (中)

---

## 📅 开发排期

| 任务 | 负责人 | 工期 | 状态 | 依赖 |
|------|--------|------|------|------|
| 数据库迁移 | DatabaseMigration Skill | 1天 | 待开始 | 无 |
| 后端开发 | Backend Dev Skill | 5天 | 待开始 | 数据库迁移 |
| 前端开发(用户端) | Frontend Dev Skill | 4天 | 待开始 | 后端开发 |
| 前端开发(管理端) | Admin Frontend Dev Skill | 3天 | 待开始 | 后端开发 |
| 财务安全审查 | BillingGuard Skill | 1天 | 待开始 | 后端开发 |
| QA测试验收 | QA Acceptance Skill | 2天 | 待开始 | 前端+后端+管理端 |
| 代码审查 | Reviewer Skill | 1天 | 待开始 | 前端+后端 |
| **总计** | | **17天** | | |

**开发顺序**:
1. 第1天: 数据库迁移
2. 第2-6天: 后端开发
3. 第7-10天: 前端开发(用户端)
4. 第7-9天: 前端开发(管理端，并行)
5. 第11天: 财务安全审查
6. 第12-13天: QA测试验收
7. 第14天: 代码审查
8. 第15-17天: 修复Bug和优化

---

## 🎨 页面列表

### 用户端 (4个页面)

1. **积分中心首页** (`/points`)
   - 积分账户卡片
   - 每日签到卡片
   - 任务中心卡片

2. **兑换配额页** (`/points/redeem-quota`)
   - 兑换表单
   - 兑换说明

3. **积分商城页** (`/points/mall`)
   - 商品列表（网格布局）
   - 兑换确认弹窗

4. **积分明细页** (`/points/records`)
   - 筛选标签
   - 积分记录列表
   - 分页器

---

### 管理端 (4个页面)

1. **积分统计大盘** (`/admin/points/dashboard`)
   - 核心指标卡片
   - 趋势图
   - 分布图

2. **用户积分管理** (`/admin/points/users`)
   - 用户列表
   - 搜索功能
   - 手动调整/冻结/解冻

3. **积分商城管理** (`/admin/points/mall`)
   - 商品列表
   - 新增/编辑/上下架

4. **积分设置页** (`/admin/points/settings`)
   - 基础设置
   - 签到设置
   - 任务设置

---

## 📡 API接口列表

### 用户端接口 (10个)

1. `GET /api/points/account` - 查询积分账户
2. `POST /api/points/checkin` - 每日签到
3. `POST /api/points/tasks/complete` - 完成任务
4. `POST /api/points/redeem/quota` - 兑换配额
5. `GET /api/points/mall/items` - 查询商城商品
6. `POST /api/points/mall/redeem` - 兑换商城商品
7. `GET /api/points/records` - 查询积分明细

---

### 管理端接口 (10个)

1. `GET /api/admin/points/statistics` - 查询统计数据
2. `GET /api/admin/points/users` - 查询用户积分列表
3. `POST /api/admin/points/adjust` - 手动调整积分
4. `POST /api/admin/points/freeze` - 冻结积分
5. `POST /api/admin/points/unfreeze` - 解冻积分
6. `GET /api/admin/points/mall/items` - 查询商城商品（管理端）
7. `POST /api/admin/points/mall/items` - 新增商品
8. `PUT /api/admin/points/mall/items/:id` - 编辑商品
9. `PUT /api/admin/points/mall/items/:id/status` - 上架/下架商品
10. `GET /api/admin/points/settings` - 查询积分设置
11. `PUT /api/admin/points/settings` - 更新积分设置

---

## 🛡️ 财务安全要点

### 1. 积分账户数据一致性
验证公式: `available_points = total_points - frozen_points - used_points - expired_points`

### 2. 防止积分超扣
使用事务+行锁（forUpdate）

### 3. 防止积分重复发放
- 注册奖励: 查询检查
- 签到: 唯一约束(user_id, checkin_date)
- 一次性任务: 查询检查
- 购买会员: 基于订单ID查询检查

### 4. FIFO积分消费逻辑
优先消耗即将过期的积分，记录消费关联

### 5. 积分过期清理
定时任务清理，标记is_expired=true

### 6. 冻结/解冻逻辑
正确转移积分（available_points ↔ frozen_points）

### 7. 退款扣除积分
查询已发放积分并扣除，处理积分不足情况

---

## 🧪 测试场景清单

- [ ] 用户注册获得奖励积分
- [ ] 每日签到获得积分（连续签到+中断重置）
- [ ] 完成任务获得积分（一次性+可重复）
- [ ] 购买会员赠送积分
- [ ] 兑换配额（并发测试）
- [ ] 兑换商城商品（优惠券+会员）
- [ ] 积分明细查询（筛选+分页）
- [ ] 积分过期清理
- [ ] 管理员手动调整积分
- [ ] 管理员冻结/解冻积分
- [ ] 管理员管理商城商品
- [ ] 管理员查看统计数据
- [ ] FIFO积分消费验证

---

## 📊 成功指标

| 指标 | 当前 | 目标 | 统计周期 |
|------|------|------|---------|
| 用户日活跃度(DAU) | 5,000 | 6,500 (+30%) | 上线后30天 |
| 用户7日留存率 | 35% | 42% (+20%) | 上线后30天 |
| 积分兑换配额使用率 | - | 40% | 上线后30天 |
| 积分兑换会员转化率 | - | 15% | 上线后30天 |
| 每日签到参与率 | - | 60% | 上线后30天 |

---

## 🚀 灰度发布计划

### 第一阶段 (10%用户)
- 开放每日签到功能
- 开放积分兑换配额功能
- 监控积分发放和消费数据

### 第二阶段 (50%用户)
- 开放任务系统
- 开放积分商城(优惠券+会员)
- 收集用户反馈，优化兑换比例

### 第三阶段 (100%用户)
- 全量开放所有功能
- 监控核心指标(DAU, 留存率, 转化率)

---

## 📚 文档列表

### 产品文档
- [PRD-用户积分系统.md](./PRD-用户积分系统.md) (1100行)

### 技术文档
- [任务卡-DatabaseMigration.md](./任务卡-DatabaseMigration.md) (700行)
- [任务卡-Backend.md](./任务卡-Backend.md) (650行)
- [任务卡-Frontend.md](./任务卡-Frontend.md) (450行)
- [任务卡-AdminFrontend.md](./任务卡-AdminFrontend.md) (350行)
- [任务卡-BillingGuard.md](./任务卡-BillingGuard.md) (500行)
- [任务卡-QA.md](./任务卡-QA.md) (550行)
- [任务卡-Reviewer.md](./任务卡-Reviewer.md) (600行)
- [任务卡-总览.md](./任务卡-总览.md) (本文档)

**文档总行数**: 约5,900行

---

## ⚠️ 风险和注意事项

### 技术风险

1. **FIFO逻辑复杂度高**
   - 风险: 实现错误导致积分消费不正确
   - 缓解: 充分测试+代码审查

2. **并发安全问题**
   - 风险: 积分超扣导致财务损失
   - 缓解: 使用行锁+事务+并发测试

3. **定时任务失败**
   - 风险: 过期积分未清理，影响数据准确性
   - 缓解: 监控定时任务+日志记录+手动补偿机制

---

### 业务风险

1. **积分兑换比例不合理**
   - 风险: 用户觉得积分不值钱或太难获得
   - 缓解: 灰度发布+数据监控+快速调整

2. **羊毛党刷积分**
   - 风险: 积分被恶意刷取，财务损失
   - 缓解: 防刷机制+异常监控+积分冻结

3. **用户投诉积分丢失**
   - 风险: 过期或冻结积分引发用户不满
   - 缓解: 明确规则+过期前提醒+人工补偿

---

## 🎯 验收标准

### 功能完整性
- [ ] 7张数据库表创建成功
- [ ] 20个API接口全部实现
- [ ] 8个页面全部开发完成
- [ ] 所有核心功能正常工作

### 数据准确性
- [ ] 积分账户数据一致性验证通过
- [ ] FIFO消费逻辑验证通过
- [ ] 防重复发放验证通过
- [ ] 积分过期清理验证通过

### 财务安全性
- [ ] 并发安全性测试通过
- [ ] 财务安全审查通过
- [ ] 所有防刷机制生效

### 性能和稳定性
- [ ] 接口响应时间达标(<300ms)
- [ ] 100并发测试通过
- [ ] 定时任务正常执行

### 代码质量
- [ ] 代码审查通过（综合评分≥80分）
- [ ] 无P0级别问题
- [ ] 单元测试覆盖率>70%

---

## 📞 联系人

- **产品负责人**: Product Planner
- **技术负责人**: Backend Dev Skill
- **QA负责人**: QA Acceptance Skill
- **财务审查**: BillingGuard Skill

---

## 📝 变更记录

| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2025-10-30 | v1.0 | 初始版本 | Product Planner |

---

**文档完成，开发团队可以开始开发了！💪**
