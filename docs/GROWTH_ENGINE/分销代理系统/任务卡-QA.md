# 任务卡:QA验收测试 - 分销代理系统

> **负责技能**:qa_acceptance_skill
> **优先级**:P0
> **预计工期**:1天

---

## 任务目标

对分销代理系统进行全面的功能验收测试,确保所有功能正常、数据准确、财务安全、用户体验良好。

---

## 测试范围

### 用户端功能
1. 申请成为分销员
2. 分销中心数据展示
3. 推荐关系绑定
4. 佣金计算和到账
5. 提现申请和记录

### 管理员端功能
1. 审核分销员申请
2. 查看分销员详情
3. 审核提现申请
4. 查看数据统计
5. 修改佣金设置

---

## 测试清单

### 功能测试

#### 场景1:用户申请成为分销员(完整流程)
1. [ ] 登录用户进入工作台,看到"分销中心"入口卡片
2. [ ] 点击进入分销申请页 `/distribution/apply`
3. [ ] 填写真实姓名、身份证号、联系方式、推广渠道
4. [ ] 提交申请,toast提示"申请已提交"
5. [ ] 管理员进入分销员管理页
6. [ ] 看到该用户的申请,状态为"待审核"
7. [ ] 点击"通过"按钮,审核通过
8. [ ] 用户进入分销中心,看到专属邀请码和推广链接
9. [ ] 分销员状态为"已激活"

**预期结果**:所有步骤顺利完成,数据准确

#### 场景2:推荐关系绑定和佣金计算(完整流程)
1. [ ] 分销员A获得推广链接(带ref参数)
2. [ ] 新用户B通过推广链接访问注册页
3. [ ] 新用户B完成注册
4. [ ] 数据库中推荐关系正确绑定
5. [ ] 分销员A在"我的推广"中看到用户B,状态为"未购买"
6. [ ] 用户B首次购买会员,订单金额¥99
7. [ ] 订单支付成功
8. [ ] 系统自动计算佣金:¥99 × 15% = ¥14.85
9. [ ] 佣金进入7天冻结期
10. [ ] 分销员A在"佣金明细"中看到该笔佣金,状态为"冻结中"
11. [ ] 7天后定时任务执行,佣金解冻
12. [ ] 佣金状态变为"已到账"
13. [ ] 分销员A可提现余额增加¥14.85
14. [ ] "我的推广"中用户B状态变为"已购买"

**预期结果**:推荐关系正确,佣金计算准确,状态流转正常

#### 场景3:用户B第二次购买不产生佣金
1. [ ] 用户B再次购买会员(续费)
2. [ ] 订单支付成功
3. [ ] 查询佣金记录表

**预期结果**:没有新的佣金记录产生(仅首单计佣)

#### 场景4:提现流程(完整流程)
1. [ ] 分销员A可提现余额为¥450
2. [ ] 进入"申请提现"页面
3. [ ] 输入提现金额¥450
4. [ ] 选择提现方式"微信零钱"
5. [ ] 填写微信账号和收款人姓名
6. [ ] 提交申请
7. [ ] toast提示"提现申请已提交"
8. [ ] 可提现余额立即扣除¥450
9. [ ] 管理员进入提现审核页
10. [ ] 看到该笔提现申请,状态为"待审核"
11. [ ] 点击"通过审核"
12. [ ] 提现状态变为"已通过"
13. [ ] 分销员A已提现金额增加¥450
14. [ ] 分销员A在"提现记录"中看到该笔记录

**预期结果**:提现流程完整,余额计算准确

#### 场景5:提现金额校验
1. [ ] 分销员A可提现余额为¥50
2. [ ] 尝试提现¥100
3. [ ] 提示"可提现余额不足"
4. [ ] 尝试提现¥80
5. [ ] 提示"提现金额不能低于¥100"

**预期结果**:提现金额校验正确

#### 场景6:提现审核拒绝(余额退还)
1. [ ] 分销员A申请提现¥100
2. [ ] 可提现余额扣除¥100
3. [ ] 管理员点击"拒绝"
4. [ ] 输入拒绝原因"账户信息不符"
5. [ ] 提现状态变为"已拒绝"
6. [ ] 可提现余额恢复增加¥100
7. [ ] 分销员A在提现记录中看到拒绝原因

**预期结果**:拒绝后余额正确退还

#### 场景7:推荐关系永久绑定,不可更改
1. [ ] 用户B已绑定分销员A
2. [ ] 用户B再次通过分销员C的推广链接访问
3. [ ] 查询推荐关系表

**预期结果**:推荐关系不变,仍然是分销员A

---

### 财务安全测试

#### 测试1:防止重复计佣
**步骤**:
1. 模拟订单支付成功回调多次触发
2. 查询佣金记录表

**预期结果**:同一订单只有1条佣金记录,唯一索引生效

#### 测试2:佣金基于实付金额计算
**步骤**:
1. 用户B使用¥20优惠券
2. 订单原价¥99,实付¥79
3. 查询佣金记录

**预期结果**:
- 佣金 = ¥79 × 15% = ¥11.85(不是¥99 × 15%)

#### 测试3:并发提现安全性
**步骤**:
1. 分销员A可提现余额¥100
2. 使用工具模拟2个并发提现请求,每次¥100
3. 查询提现记录和分销员余额

**预期结果**:
- 只有1次提现成功
- 另1次提示"余额不足"
- 分销员可提现余额为¥0

---

### 数据准确性测试

#### 测试1:累计佣金一致性
```sql
SELECT
  d.total_commission AS distributor_total,
  SUM(c.commission_amount) AS commission_sum
FROM distributors d
LEFT JOIN commissions c ON d.id = c.distributor_id
WHERE d.id = 'dist_abc123'
GROUP BY d.id;
```

**预期结果**:`distributor_total` = `commission_sum`

#### 测试2:可提现佣金准确性
```sql
SELECT
  d.total_commission,
  d.available_commission,
  d.withdrawn_commission,
  SUM(CASE WHEN c.status = 'frozen' THEN c.commission_amount ELSE 0 END) AS frozen_sum
FROM distributors d
LEFT JOIN commissions c ON d.id = c.distributor_id
WHERE d.id = 'dist_abc123'
GROUP BY d.id;
```

**预期结果**:
```
available_commission = total_commission - frozen_sum - withdrawn_commission
```

#### 测试3:推荐人数准确性
```sql
SELECT
  COUNT(*) AS referral_count
FROM referral_relationships
WHERE referrer_distributor_id = 'dist_abc123';
```

**预期结果**:推荐人数 = 推荐关系记录数

---

### 管理员功能测试

#### 场景8:审核分销员申请
1. [ ] 管理员登录
2. [ ] 进入分销员管理页
3. [ ] 筛选"待审核"状态
4. [ ] 看到所有待审核申请
5. [ ] 点击某个申请的"通过"按钮
6. [ ] 该申请状态变为"已激活"
7. [ ] 用户可进入分销中心

**预期结果**:审核功能正常

#### 场景9:查看分销员详情
1. [ ] 点击某个分销员的"详情"
2. [ ] 看到完整的分销员信息
3. [ ] 看到数据统计(推广人数、累计佣金、可提现、已提现)
4. [ ] 看到推广用户列表
5. [ ] 看到佣金记录列表

**预期结果**:数据完整准确

#### 场景10:查看分销数据统计
1. [ ] 进入分销数据统计页
2. [ ] 看到核心数据卡片(分销员总数、累计推广用户、累计佣金支出、待审核提现)
3. [ ] 看到推广趋势图
4. [ ] 看到佣金支出趋势图
5. [ ] 看到分销员排行榜

**预期结果**:数据统计准确,图表显示正常

#### 场景11:修改佣金设置
1. [ ] 进入佣金设置页
2. [ ] 修改默认佣金比例为20%
3. [ ] 修改最低提现金额为¥200
4. [ ] 保存设置
5. [ ] 新用户购买会员,观察佣金计算
6. [ ] 分销员申请提现¥150,观察是否提示"不能低于¥200"

**预期结果**:设置生效,新规则正确应用

---

## 测试报告模板

```markdown
# 分销代理系统QA测试报告

## 测试时间
2025-10-XX

## 测试人
qa_acceptance_skill

## 测试环境
- 后端:develop分支
- 前端:develop分支
- 数据库:测试环境

## 测试结果总览
- ✅ 通过:XX 项
- ❌ 失败:XX 项
- 🟡 部分通过:XX 项

## 详细测试结果

### 用户端功能测试
- [x] 场景1:申请成为分销员 ✅
- [x] 场景2:推荐关系和佣金计算 ✅
- [x] 场景3:第二次购买不计佣 ✅
- [x] 场景4:提现流程 ✅
- [x] 场景5:提现金额校验 ✅
- [x] 场景6:提现拒绝退还余额 ✅
- [x] 场景7:推荐关系永久绑定 ✅

### 财务安全测试
- [x] 测试1:防止重复计佣 ✅
- [x] 测试2:佣金基于实付 ✅
- [x] 测试3:并发提现安全 ✅

### 数据准确性
- [x] 测试1:累计佣金一致性 ✅
- [x] 测试2:可提现佣金准确性 ✅
- [x] 测试3:推荐人数准确性 ✅

### 管理员功能
- [x] 场景8:审核分销员 ✅
- [x] 场景9:查看详情 ✅
- [x] 场景10:数据统计 ✅
- [x] 场景11:修改设置 ✅

## 发现的Bug
无

## 性能测试
- 100并发注册绑定推荐关系:通过 ✅
- 50并发提现申请:通过 ✅
- 推荐关系查询响应时间:<10ms ✅
- 佣金明细查询响应时间:<20ms ✅

## 最终判定
☑️ **测试通过**,可以上线

签字:____________
日期:____________
```

---

**预计工作量**:1天
