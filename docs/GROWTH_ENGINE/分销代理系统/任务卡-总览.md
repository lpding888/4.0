# åˆ†é”€ä»£ç†ç³»ç»Ÿ - ä»»åŠ¡å¡æ€»è§ˆ

> **é¡¹ç›®ä»£å·**:Distribution System
> **åˆ›å»ºæ—¥æœŸ**:2025-10-29
> **çŠ¶æ€**:å¾…æ‰§è¡Œ

---

## ðŸ“‹ ä»»åŠ¡å¡æ¸…å•

### é˜¶æ®µ1:æ•°æ®åº“å’ŒåŽç«¯åŸºç¡€(é¢„è®¡4-5å¤©)
1. âœ… **[ä»»åŠ¡å¡-DatabaseMigration.md](./ä»»åŠ¡å¡-DatabaseMigration.md)** - æ•°æ®åº“è¿ç§»(0.5å¤©)
   - åˆ›å»º4ä¸ªæ ¸å¿ƒè¡¨:distributorsã€referral_relationshipsã€commissionsã€withdrawals
   - æ‰©å±•usersè¡¨å¢žåŠ referrer_idå­—æ®µ
   - è®¾ç½®æ‰€æœ‰ç´¢å¼•å’Œå”¯ä¸€çº¦æŸ

2. âœ… **[ä»»åŠ¡å¡-Backend.md](./ä»»åŠ¡å¡-Backend.md)** - åŽç«¯å¼€å‘(4-5å¤©)
   - ç”¨æˆ·ç«¯7ä¸ªæŽ¥å£:ç”³è¯·ã€çŠ¶æ€ã€æ•°æ®æ¦‚è§ˆã€æŽ¨å¹¿åˆ—è¡¨ã€ä½£é‡‘æ˜Žç»†ã€æçŽ°ç”³è¯·ã€æçŽ°è®°å½•
   - ç®¡ç†ç«¯9ä¸ªæŽ¥å£:åˆ†é”€å‘˜ç®¡ç†ã€æçŽ°å®¡æ ¸ã€æ•°æ®ç»Ÿè®¡ã€ä½£é‡‘è®¾ç½®
   - æ ¸å¿ƒserviceå±‚:æŽ¨èå…³ç³»ç»‘å®šã€ä½£é‡‘è®¡ç®—ã€æçŽ°ç®¡ç†
   - å®šæ—¶ä»»åŠ¡:ä½£é‡‘è§£å†»

### é˜¶æ®µ2:å‰ç«¯é¡µé¢å¼€å‘(é¢„è®¡4-5å¤©)
3. âœ… **[ä»»åŠ¡å¡-Frontend.md](./ä»»åŠ¡å¡-Frontend.md)** - å‰ç«¯ç”¨æˆ·ç«¯(2.5å¤©)
   - 7ä¸ªé¡µé¢:ç”³è¯·é¡µã€åˆ†é”€ä¸­å¿ƒã€æŽ¨å¹¿åˆ—è¡¨ã€ä½£é‡‘æ˜Žç»†ã€æçŽ°ç”³è¯·ã€æçŽ°è®°å½•ã€å·¥ä½œå°æ”¹é€ 
   - 4ä¸ªæ ¸å¿ƒç»„ä»¶:åˆ†é”€å‘˜å¡ç‰‡ã€æŽ¨å¹¿å¡ç‰‡ã€ä½£é‡‘å¡ç‰‡ã€æçŽ°å¡ç‰‡
   - å“ç‰Œé«˜å¥¢é£Žæ ¼:æ·±è‰²æ¸å˜ã€çŽ»ç’ƒå¡ç‰‡ã€éœ“è™¹é’è¾¹

4. âœ… **[ä»»åŠ¡å¡-AdminFrontend.md](./ä»»åŠ¡å¡-AdminFrontend.md)** - å‰ç«¯ç®¡ç†ç«¯(2å¤©)
   - 5ä¸ªé¡µé¢:åˆ†é”€å‘˜ç®¡ç†ã€åˆ†é”€å‘˜è¯¦æƒ…ã€æçŽ°å®¡æ ¸ã€æ•°æ®ç»Ÿè®¡ã€ä½£é‡‘è®¾ç½®
   - 3ä¸ªæ ¸å¿ƒç»„ä»¶:åˆ†é”€å‘˜è¡¨æ ¼ã€æçŽ°å®¡æ ¸å¡ç‰‡ã€æ•°æ®ç»Ÿè®¡å¡ç‰‡
   - ç®¡ç†åŽå°é£Žæ ¼:ç®€æ´ä¸“ä¸šã€æ•°æ®å±•ç¤º

### é˜¶æ®µ3:å®¡æŸ¥å’Œæµ‹è¯•(é¢„è®¡3-4å¤©)
5. âœ… **[ä»»åŠ¡å¡-BillingGuard.md](./ä»»åŠ¡å¡-BillingGuard.md)** - è´¢åŠ¡å®‰å…¨å®¡æŸ¥(1å¤©)
   - ä½£é‡‘è®¡ç®—å®‰å…¨æ€§å®¡æŸ¥(é¦–å•è®¡ä½£ã€åŸºäºŽå®žä»˜)
   - é˜²æ­¢é‡å¤è®¡ä½£å®¡æŸ¥(å”¯ä¸€ç´¢å¼•ã€å¹‚ç­‰æ€§)
   - æçŽ°é‡‘é¢å®‰å…¨æ€§å®¡æŸ¥(è¡Œé”ã€ä½™é¢æ ¡éªŒ)
   - æ•°æ®ä¸€è‡´æ€§å®¡æŸ¥(ç´¯è®¡ä½£é‡‘ã€å¯æçŽ°ä½£é‡‘)

6. âœ… **[ä»»åŠ¡å¡-QA.md](./ä»»åŠ¡å¡-QA.md)** - QAéªŒæ”¶æµ‹è¯•(1å¤©)
   - 11ä¸ªå®Œæ•´æµç¨‹æµ‹è¯•åœºæ™¯
   - 3ä¸ªè´¢åŠ¡å®‰å…¨æµ‹è¯•
   - 3ä¸ªæ•°æ®å‡†ç¡®æ€§æµ‹è¯•
   - 4ä¸ªç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•
   - å¹¶å‘æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•

7. âœ… **[ä»»åŠ¡å¡-Reviewer.md](./ä»»åŠ¡å¡-Reviewer.md)** - ä»£ç å®¡æŸ¥(1å¤©)
   - ä»£ç è´¨é‡å®¡æŸ¥(è§„èŒƒã€æ³¨é‡Šã€é”™è¯¯å¤„ç†)
   - å®‰å…¨æ€§å®¡æŸ¥(SQLæ³¨å…¥ã€XSSã€æ•æ„Ÿä¿¡æ¯)
   - æ€§èƒ½å®¡æŸ¥(N+1æŸ¥è¯¢ã€ç´¢å¼•ä½¿ç”¨)
   - æŽ¥å£å…¼å®¹æ€§å®¡æŸ¥
   - è´¢åŠ¡é€»è¾‘æ­£ç¡®æ€§å®¡æŸ¥(é‡ç‚¹)

---

## ðŸŽ¯ æ‰§è¡Œé¡ºåº

### ç¬¬1å‘¨:åŽç«¯å¼€å‘
**Day 1**:æ•°æ®åº“è¿ç§»(0.5å¤©) + åŽç«¯å¼€å§‹(0.5å¤©)
- åˆ›å»ºæ‰€æœ‰æ•°æ®åº“è¡¨
- å®žçŽ°æŽ¨èå…³ç³»ç»‘å®šé€»è¾‘

**Day 2-3**:åŽç«¯æ ¸å¿ƒåŠŸèƒ½(2å¤©)
- å®žçŽ°ä½£é‡‘è®¡ç®—å’Œç»“ç®—é€»è¾‘
- å®žçŽ°æçŽ°ç®¡ç†é€»è¾‘
- å®žçŽ°ç”¨æˆ·ç«¯7ä¸ªæŽ¥å£

**Day 4-5**:åŽç«¯ç®¡ç†åŠŸèƒ½(2å¤©)
- å®žçŽ°ç®¡ç†ç«¯9ä¸ªæŽ¥å£
- å®žçŽ°å®šæ—¶ä»»åŠ¡(ä½£é‡‘è§£å†»)
- åŽç«¯è‡ªæµ‹å’Œè°ƒè¯•

### ç¬¬2å‘¨:å‰ç«¯å¼€å‘
**Day 6-7**:å‰ç«¯ç”¨æˆ·ç«¯(2.5å¤©)
- å®žçŽ°åˆ†é”€ä¸­å¿ƒç›¸å…³é¡µé¢
- å®žçŽ°æŽ¨å¹¿å’Œä½£é‡‘ç›¸å…³é¡µé¢
- å®žçŽ°æçŽ°ç›¸å…³é¡µé¢

**Day 8-9**:å‰ç«¯ç®¡ç†ç«¯(2å¤©)
- å®žçŽ°åˆ†é”€å‘˜ç®¡ç†é¡µé¢
- å®žçŽ°æçŽ°å®¡æ ¸é¡µé¢
- å®žçŽ°æ•°æ®ç»Ÿè®¡å’Œè®¾ç½®é¡µé¢

### ç¬¬3å‘¨:å®¡æŸ¥æµ‹è¯•
**Day 10**:Billing Guardè´¢åŠ¡å®¡æŸ¥(1å¤©)
- å®¡æŸ¥æ‰€æœ‰è´¢åŠ¡ç›¸å…³é€»è¾‘
- å‡ºå…·è´¢åŠ¡å®‰å…¨å®¡æŸ¥æŠ¥å‘Š

**Day 11**:QAéªŒæ”¶æµ‹è¯•(1å¤©)
- æ‰§è¡Œå®Œæ•´æµ‹è¯•ç”¨ä¾‹
- éªŒè¯æ•°æ®å‡†ç¡®æ€§
- å‡ºå…·QAæµ‹è¯•æŠ¥å‘Š

**Day 12**:Code Review(1å¤©)
- å®¡æŸ¥ä»£ç è´¨é‡å’Œå®‰å…¨æ€§
- å®¡æŸ¥æ€§èƒ½å’Œå…¼å®¹æ€§
- å‡ºå…·ä»£ç å®¡æŸ¥æŠ¥å‘Š

---

## ðŸ“Š æ ¸å¿ƒæ•°æ®è¡¨

### 1. distributors(åˆ†é”€å‘˜è¡¨)
- **ä¸»é”®**:`id`
- **æ ¸å¿ƒå­—æ®µ**:`user_id`ã€`real_name`ã€`invite_code`ã€`status`ã€`total_commission`ã€`available_commission`ã€`withdrawn_commission`
- **ç´¢å¼•**:`idx_distributors_user`ã€`idx_distributors_invite_code`

### 2. referral_relationships(æŽ¨èå…³ç³»è¡¨)
- **ä¸»é”®**:`id`
- **æ ¸å¿ƒå­—æ®µ**:`referrer_user_id`ã€`referred_user_id`ã€`referrer_distributor_id`
- **å”¯ä¸€çº¦æŸ**:`uk_referred_user`(æ¯ä¸ªç”¨æˆ·åªèƒ½è¢«æŽ¨èä¸€æ¬¡)

### 3. commissions(ä½£é‡‘è®°å½•è¡¨)
- **ä¸»é”®**:`id`
- **æ ¸å¿ƒå­—æ®µ**:`distributor_id`ã€`order_id`ã€`commission_amount`ã€`status`ã€`freeze_until`
- **å”¯ä¸€çº¦æŸ**:`uk_order_distributor`(é˜²æ­¢åŒä¸€è®¢å•é‡å¤è®¡ä½£)

### 4. withdrawals(æçŽ°è®°å½•è¡¨)
- **ä¸»é”®**:`id`
- **æ ¸å¿ƒå­—æ®µ**:`distributor_id`ã€`amount`ã€`method`ã€`account_info`ã€`status`

---

## ðŸ”¥ å…³é”®æŠ€æœ¯è¦ç‚¹

### 1. æŽ¨èå…³ç³»ç»‘å®š(æ³¨å†Œæ—¶)
```javascript
// ç”¨æˆ·æ³¨å†Œæ—¶æ£€æµ‹URLå‚æ•°ref
const referrerId = req.query.ref;
if (referrerId) {
  await bindReferralRelationship(trx, referrerId, newUserId);
}
```

### 2. ä½£é‡‘è®¡ç®—(é¦–å•è®¡ä½£)
```javascript
// æ£€æŸ¥æ˜¯å¦æ˜¯é¦–å•
const orderCount = await trx('orders')
  .where({ user_id: userId, status: 'paid' })
  .count();

if (orderCount.count === 1) {
  // ä»…é¦–å•è®¡ä½£
  await createCommission(trx, orderId, amount);
}
```

### 3. é˜²æ­¢é‡å¤è®¡ä½£(å”¯ä¸€ç´¢å¼•)
```sql
UNIQUE KEY uk_order_distributor (order_id, distributor_id)
```

### 4. æçŽ°ç”³è¯·(è¡Œé”+äº‹åŠ¡)
```javascript
const distributor = await trx('distributors')
  .where({ user_id: userId })
  .forUpdate()  // è¡Œé”
  .first();

// æ ¡éªŒä½™é¢å¹¶æ‰£é™¤
if (distributor.available_commission >= amount) {
  await trx('distributors')
    .where({ id: distributorId })
    .decrement('available_commission', amount);
}
```

### 5. ä½£é‡‘è§£å†»(å®šæ—¶ä»»åŠ¡)
```javascript
// æ¯å°æ—¶æ‰§è¡Œ
setInterval(async () => {
  await db('commissions')
    .where({ status: 'frozen' })
    .where('freeze_until', '<=', new Date())
    .update({ status: 'available' });
}, 60 * 60 * 1000);
```

---

## âš ï¸ é£Žé™©æé†’

### é«˜é£Žé™©ç‚¹
1. **è‡ªæŽ¨è‡ªä¹°ä½œå¼Š**
   - é£Žé™©:åˆ†é”€å‘˜è‡ªå·±æ³¨å†Œå°å·è´­ä¹°ä¼šå‘˜èµšä½£é‡‘
   - åº”å¯¹:é™åˆ¶åŒä¸€è®¾å¤‡/IPçŸ­æœŸæ³¨å†Œå¤šè´¦å·,åŽå°ç›‘æŽ§å¼‚å¸¸è¡Œä¸º

2. **ä½£é‡‘é‡å¤è®¡ç®—**
   - é£Žé™©:è®¢å•å›žè°ƒé‡å¤è§¦å‘,ä½£é‡‘é‡å¤è®¡ç®—
   - åº”å¯¹:ä½¿ç”¨å”¯ä¸€ç´¢å¼•`uk_order_distributor`é˜²æ­¢é‡å¤æ’å…¥

3. **æçŽ°é‡‘é¢ä¼ªé€ **
   - é£Žé™©:å‰ç«¯ä¼ªé€ æçŽ°é‡‘é¢
   - åº”å¯¹:åŽç«¯ä¸¥æ ¼æ ¡éªŒæçŽ°é‡‘é¢â‰¤å¯æçŽ°ä½™é¢,ä½¿ç”¨è¡Œé”å’Œäº‹åŠ¡

### ä¸­é£Žé™©ç‚¹
1. **æŽ¨èå…³ç³»ä½œå¼Š**
   - é£Žé™©:æ¶æ„ä¿®æ”¹æŽ¨èå…³ç³»
   - åº”å¯¹:æŽ¨èå…³ç³»ä¸€æ—¦ç»‘å®šæ°¸ä¹…ä¸å¯æ›´æ”¹,ä½¿ç”¨å”¯ä¸€çº¦æŸ`uk_referred_user`

2. **ä½£é‡‘ä¸Žé…é¢æ··æ·†**
   - é£Žé™©:ä½£é‡‘è®¡ç®—å½±å“ç”¨æˆ·é…é¢
   - åº”å¯¹:ä½£é‡‘ç³»ç»Ÿå®Œå…¨ç‹¬ç«‹,ä¸ç¢°`quota_remaining`å­—æ®µ

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæˆæ ‡å‡†
- [ ] ç”¨æˆ·å¯ç”³è¯·æˆä¸ºåˆ†é”€å‘˜,ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡åŽèŽ·å¾—ä¸“å±žé‚€è¯·ç 
- [ ] æ–°ç”¨æˆ·é€šè¿‡æŽ¨å¹¿é“¾æŽ¥æ³¨å†Œ,æŽ¨èå…³ç³»æ­£ç¡®ç»‘å®š
- [ ] è¢«æŽ¨èç”¨æˆ·é¦–æ¬¡è´­ä¹°ä¼šå‘˜,ä½£é‡‘æ­£ç¡®è®¡ç®—(åŸºäºŽå®žä»˜)
- [ ] ä½£é‡‘è¿›å…¥7å¤©å†»ç»“æœŸ,7å¤©åŽè‡ªåŠ¨è½¬ä¸ºå¯æçŽ°
- [ ] åˆ†é”€å‘˜å¯ç”³è¯·æçŽ°,ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡åŽä½™é¢æ­£ç¡®æ‰£é™¤
- [ ] æçŽ°å®¡æ ¸æ‹’ç»åŽä½™é¢æ­£ç¡®é€€è¿˜

### è´¢åŠ¡æ•°æ®å‡†ç¡®æ ‡å‡†
- [ ] ä½£é‡‘ä»…åœ¨é¦–æ¬¡è´­ä¹°æ—¶è®¡ç®—,åŽç»­å¤è´­ä¸è®¡ä½£
- [ ] ä½£é‡‘åŸºäºŽè®¢å•å®žä»˜é‡‘é¢è€ŒéžåŽŸä»·
- [ ] åŒä¸€è®¢å•ä¸é‡å¤è®¡ä½£(å”¯ä¸€ç´¢å¼•ç”Ÿæ•ˆ)
- [ ] å¯æçŽ°ä½£é‡‘ = ç´¯è®¡ä½£é‡‘ - å†»ç»“ä½£é‡‘ - å·²æçŽ°ä½£é‡‘
- [ ] æŽ¨èäººæ•°ç»Ÿè®¡å‡†ç¡®

### æ€§èƒ½æ ‡å‡†
- [ ] æŽ¨èå…³ç³»æŸ¥è¯¢å“åº”æ—¶é—´<10ms
- [ ] ä½£é‡‘æ˜Žç»†æŸ¥è¯¢å“åº”æ—¶é—´<20ms
- [ ] 100å¹¶å‘æçŽ°ç”³è¯·æ— è¶…æ‰£çŽ°è±¡
- [ ] 50å¹¶å‘æ³¨å†Œç»‘å®šæŽ¨èå…³ç³»æ— é—æ¼

---

## ðŸ“ž ä»»åŠ¡é¢†å–æ–¹å¼

### åŽç«¯å¼€å‘å·¥ç¨‹å¸ˆ
1. é˜…è¯»[ä»»åŠ¡å¡-DatabaseMigration.md](./ä»»åŠ¡å¡-DatabaseMigration.md)
2. é˜…è¯»[ä»»åŠ¡å¡-Backend.md](./ä»»åŠ¡å¡-Backend.md)
3. æŒ‰é¡ºåºæ‰§è¡Œ:æ•°æ®åº“è¿ç§» â†’ æ ¸å¿ƒåŠŸèƒ½ â†’ ç®¡ç†åŠŸèƒ½

### å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ
1. é˜…è¯»[ä»»åŠ¡å¡-Frontend.md](./ä»»åŠ¡å¡-Frontend.md)
2. é˜…è¯»[ä»»åŠ¡å¡-AdminFrontend.md](./ä»»åŠ¡å¡-AdminFrontend.md)
3. æŒ‰é¡ºåºæ‰§è¡Œ:ç”¨æˆ·ç«¯é¡µé¢ â†’ ç®¡ç†ç«¯é¡µé¢

### è´¢åŠ¡å®¡æŸ¥å‘˜
1. é˜…è¯»[ä»»åŠ¡å¡-BillingGuard.md](./ä»»åŠ¡å¡-BillingGuard.md)
2. é€é¡¹å®¡æŸ¥è´¢åŠ¡ç›¸å…³é€»è¾‘
3. å‡ºå…·è´¢åŠ¡å®‰å…¨å®¡æŸ¥æŠ¥å‘Š

### QAæµ‹è¯•å·¥ç¨‹å¸ˆ
1. é˜…è¯»[ä»»åŠ¡å¡-QA.md](./ä»»åŠ¡å¡-QA.md)
2. æ‰§è¡Œå®Œæ•´æµ‹è¯•ç”¨ä¾‹
3. å‡ºå…·QAæµ‹è¯•æŠ¥å‘Š

### ä»£ç å®¡æŸ¥å‘˜
1. é˜…è¯»[ä»»åŠ¡å¡-Reviewer.md](./ä»»åŠ¡å¡-Reviewer.md)
2. å®¡æŸ¥ä»£ç è´¨é‡å’Œå®‰å…¨æ€§
3. å‡ºå…·ä»£ç å®¡æŸ¥æŠ¥å‘Š

---

## ðŸŽ‰ æ€»ç»“

åˆ†é”€ä»£ç†ç³»ç»ŸåŒ…å«**4ä¸ªæ ¸å¿ƒæ•°æ®è¡¨**ã€**16ä¸ªAPIæŽ¥å£**ã€**12ä¸ªå‰ç«¯é¡µé¢**,é¢„è®¡**11-14å¤©**å®Œæˆã€‚

å…³é”®æˆåŠŸå› ç´ :
1. **è´¢åŠ¡å®‰å…¨ç¬¬ä¸€**:ä½£é‡‘è®¡ç®—å¿…é¡»å‡†ç¡®,é˜²æ­¢ä½œå¼Š
2. **æŽ¨èå…³ç³»å‡†ç¡®**:URLå‚æ•°ä¼ é€’ã€ç»‘å®šé€»è¾‘å¿…é¡»å¯é 
3. **é˜²ä½œå¼Šæœºåˆ¶**:å¤šç»´åº¦é˜²æ­¢è‡ªæŽ¨è‡ªä¹°å’Œæ¶æ„å¥—åˆ©
4. **æ•°æ®ç»Ÿè®¡å‡†ç¡®**:ä¸ºè¿è¥å†³ç­–æä¾›å¯é æ•°æ®æ”¯æŒ

**ðŸš€ è®©æˆ‘ä»¬å¼€å§‹æ‰“é€ å¢žé•¿å¼•æ“Žå§ï¼**
