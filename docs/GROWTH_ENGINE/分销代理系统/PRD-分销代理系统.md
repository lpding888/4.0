# 产品需求文档：分销代理系统

> **Product Planner Skill 标准输出**
> **创建日期**：2025-10-29
> **版本**：v1.0
> **状态**：待开发

---

## 1. 需求背景 / 目标

### 这个功能为什么做
- **商业问题**：缺乏用户增长裂变机制，完全依赖自然流量和广告投放，获客成本高
- **用户痛点**：用户购买会员后无法获得额外收益，缺乏分享动力
- **市场竞争**：竞品普遍有推荐奖励、分销返佣机制，我们需要建立裂变增长体系

### 目标用户是谁
- **分销员**：愿意推广平台赚取佣金的用户（KOL、电商从业者、重度用户）
- **被推荐用户**：通过推荐链接/邀请码注册的新用户
- **平台运营**：需要管理分销员、设置佣金比例、审核提现

### 商业价值
- **降低获客成本**：通过分销员推广，CPA成本预计降低30-50%
- **提升用户留存**：分销员为了赚取佣金，会持续活跃和推广
- **建立增长飞轮**：老用户带新用户，新用户变老用户再带新用户
- **数据化运营**：通过分销数据分析，优化推广渠道和策略

---

## 2. 核心功能模块

### 模块1：推荐关系管理
- 用户可申请成为分销员（需审核）
- 分销员获得专属邀请码和推广链接
- 新用户通过邀请码/链接注册，自动绑定推荐关系
- 推荐关系永久有效，不可更改

### 模块2：佣金结算
- 被推荐用户首次购买会员，分销员获得佣金
- 佣金比例可配置（建议10-20%）
- 佣金实时计算并记录
- 支持佣金冻结期（防止退款作弊，建议7天）

### 模块3：提现管理
- 分销员可申请提现（最低金额限制，建议¥100）
- 提现方式：微信零钱、支付宝
- 提现申请需审核
- 提现成功后扣除可提现余额

### 模块4：分销数据统计
- 分销员查看：推广人数、订单数、累计佣金、可提现金额
- 管理员查看：分销员排行、佣金支出、推广效果分析

---

## 3. 用户完整使用流程

### 3.1 分销员申请流程
1. 用户登录后，在个人中心看到"成为分销员"入口
2. 点击进入申请页，填写资料（真实姓名、身份证、联系方式）
3. 提交申请
4. 管理员审核（1-3个工作日）
5. 审核通过后，用户获得分销员身份
6. 进入分销中心，看到专属邀请码和推广链接

### 3.2 推广赚佣流程
1. 分销员复制推广链接或邀请码
2. 分享到朋友圈/微信群/社群
3. 新用户点击链接进入注册页（URL自动带上推荐人ID）
4. 新用户完成注册登录
5. 系统自动绑定推荐关系
6. 新用户购买会员
7. 订单支付成功后，系统计算佣金（订单金额 × 佣金比例）
8. 佣金进入冻结期（7天）
9. 冻结期结束后，佣金转为可提现
10. 分销员在分销中心看到佣金到账

### 3.3 提现流程
1. 分销员进入分销中心
2. 点击"申请提现"
3. 选择提现方式（微信/支付宝）
4. 输入提现金额（≥¥100，≤可提现余额）
5. 填写收款账户信息
6. 提交申请
7. 管理员审核提现申请
8. 审核通过后，财务人工打款
9. 打款完成后，系统更新提现状态
10. 分销员收到提现到账通知

### 3.4 管理员流程
1. 登录管理后台
2. 进入"分销管理"模块
3. 可进行以下操作：
   - 审核分销员申请
   - 查看分销员列表和数据
   - 设置佣金比例
   - 审核提现申请
   - 查看分销数据报表

---

## 4. 页面级需求（交给 frontend_dev_skill）

### 4.1 用户端页面

#### 页面1：分销中心首页 `/distribution/dashboard`
- 顶部：分销员身份卡片（头像、昵称、邀请码、推广链接）
- 数据概览：
  - 推广人数
  - 累计订单
  - 累计佣金
  - 可提现金额
  - 已提现金额
- 快捷操作：复制邀请码、复制推广链接、申请提现
- 推广素材：推广海报生成（带邀请码二维码）

#### 页面2：我的推广 `/distribution/referrals`
- Tab切换：全部 / 已购买 / 未购买
- 推广用户列表：
  - 用户信息（头像、昵称、手机号后4位）
  - 注册时间
  - 购买状态
  - 佣金金额

#### 页面3：佣金明细 `/distribution/commissions`
- 佣金记录列表：
  - 订单号
  - 用户信息
  - 订单金额
  - 佣金金额
  - 状态（冻结中/已到账）
  - 时间

#### 页面4：提现记录 `/distribution/withdrawals`
- 提现记录列表：
  - 提现金额
  - 提现方式
  - 收款账户
  - 状态（待审核/审核通过/已打款/审核拒绝）
  - 申请时间
  - 完成时间

#### 页面5：申请提现 `/distribution/withdraw/new`
- 表单：
  - 可提现金额展示
  - 提现金额输入
  - 提现方式选择
  - 收款账户信息
- 提交按钮

#### 页面6：申请成为分销员 `/distribution/apply`
- 表单：
  - 真实姓名
  - 身份证号
  - 联系方式
  - 推广渠道说明
- 提交按钮

### 4.2 管理员端页面

#### 页面7：分销员管理 `/admin/distributors`
- 分销员列表：
  - 用户信息
  - 申请时间
  - 审核状态
  - 推广人数
  - 累计佣金
  - 操作（审核/禁用）

#### 页面8：提现审核 `/admin/withdrawals`
- 提现申请列表：
  - 分销员信息
  - 提现金额
  - 收款账户
  - 申请时间
  - 状态
  - 操作（通过/拒绝）

#### 页面9：分销数据报表 `/admin/distribution/stats`
- 数据统计卡片：
  - 分销员总数
  - 累计推广用户
  - 累计佣金支出
  - 待审核提现金额
- 图表：
  - 推广趋势
  - 佣金支出趋势
  - 分销员排行榜

#### 页面10：佣金设置 `/admin/distribution/settings`
- 表单：
  - 默认佣金比例（百分比）
  - 最低提现金额
  - 佣金冻结期（天数）
  - 自动审核开关

---

## 5. 后端接口需求（交给 backend_dev_skill）

### 5.1 用户端接口

```
POST /distribution/apply                    # 申请成为分销员
GET  /distribution/status                   # 查询分销员状态
GET  /distribution/dashboard                # 分销中心数据概览
GET  /distribution/referrals                # 推广用户列表
GET  /distribution/commissions              # 佣金明细
GET  /distribution/withdrawals              # 提现记录
POST /distribution/withdraw                 # 申请提现
```

### 5.2 管理员端接口

```
GET    /admin/distributors                  # 分销员列表
PATCH  /admin/distributors/:id/approve      # 审核分销员申请
PATCH  /admin/distributors/:id/disable      # 禁用分销员
GET    /admin/withdrawals                   # 提现申请列表
PATCH  /admin/withdrawals/:id/approve       # 审核通过提现
PATCH  /admin/withdrawals/:id/reject        # 拒绝提现
GET    /admin/distribution/stats            # 分销数据统计
GET    /admin/distribution/settings         # 获取佣金设置
PUT    /admin/distribution/settings         # 更新佣金设置
```

### 5.3 内部接口（订单回调时触发）

```
POST /internal/distribution/commission      # 计算并记录佣金（订单支付成功时调用）
```

---

## 6. 云函数/大文件处理需求（交给 scf_worker_skill）

### 是否需要SCF
**本轮不需要SCF Worker**

### 理由
- 所有功能都是轻量级数据库操作
- 佣金计算逻辑简单，毫秒级完成
- 无重处理任务

### Future Plan
如果未来需要以下功能，可能需要SCF Worker：
- **推广海报批量生成**：为每个分销员生成专属推广海报
- **分销数据分析报告**：定时生成复杂的数据分析报告
- **自动提现打款**：对接微信/支付宝自动打款API

---

## 7. 计费与配额策略（交给 billing_guard_skill）

### 7.1 佣金结算核心规则

#### 规则1：佣金来源
- **仅首单计佣**：被推荐用户首次购买会员时，分销员获得佣金
- **不重复计佣**：同一用户后续复购，不再产生佣金
- **仅限会员订单**：只有购买会员的订单才产生佣金，使用AI服务不产生佣金

#### 规则2：佣金计算
```
佣金金额 = 订单实付金额 × 佣金比例
```
- 如果订单使用了优惠券，佣金基于折后价计算
- 例如：订单原价¥99，使用¥20优惠券，实付¥79，佣金比例15%
  - 佣金 = ¥79 × 15% = ¥11.85

#### 规则3：佣金状态流转
```
订单支付成功 → 佣金冻结（7天）→ 佣金可提现 → 提现成功 → 已提现
```
- **冻结期**：防止用户退款作弊
- **冻结期内订单退款**：佣金自动取消
- **可提现**：冻结期结束后自动转为可提现
- **已提现**：提现成功后扣除可提现余额

### 7.2 重要风控点

#### 风控点1：防止自推自买
- **问题**：分销员自己注册小号购买会员，赚取佣金
- **方案**：
  - 限制同一设备/IP短期内注册多账号
  - 后台监控异常推广行为（同一IP多次购买）
  - 人工审核异常订单

#### 风控点2：防止佣金重复计算
- **问题**：订单回调重复触发，佣金重复计算
- **方案**：
  - 使用数据库唯一索引防止重复插入：
    ```sql
    UNIQUE KEY uk_order_distributor (order_id, distributor_id)
    ```
  - 插入前先查询是否已计佣

#### 风控点3：防止提现金额伪造
- **问题**：前端伪造提现金额
- **方案**：
  - 后端校验提现金额 ≤ 可提现余额
  - 使用数据库事务保证原子性
  - 提现成功后扣除余额

#### 风控点4：佣金与配额隔离
- **问题**：佣金计算影响用户配额
- **方案**：
  - 佣金系统完全独立，不碰 `quota_remaining`
  - 被推荐用户购买会员，正常获得100次配额
  - 分销员获得佣金，不影响任何配额

### 7.3 财务安全检查点

**Billing Guard Skill 必须审查：**
- ✅ 佣金计算是否基于订单实付金额（非原价）
- ✅ 是否有唯一索引防止重复计佣
- ✅ 是否有事务保证佣金和余额的原子性
- ✅ 订单退款时是否正确取消冻结佣金
- ✅ 提现金额是否严格校验
- ✅ 佣金系统是否与配额系统完全隔离

### 7.4 不允许的操作
- ❌ 不允许佣金基于订单原价计算（必须基于实付）
- ❌ 不允许同一订单多次计佣
- ❌ 不允许跳过佣金冻结期
- ❌ 不允许提现金额大于可提现余额
- ❌ 不允许佣金系统影响用户配额

---

## 8. 验收标准（交给 qa_acceptance_skill）

### 8.1 功能完成标准

#### 标准1：用户可以申请成为分销员
- [ ] 个人中心看到"成为分销员"入口
- [ ] 填写申请资料并提交
- [ ] 管理员审核通过后，获得分销员身份
- [ ] 可以看到专属邀请码和推广链接

#### 标准2：推荐关系正确绑定
- [ ] 新用户通过推广链接注册
- [ ] URL自动带上推荐人ID
- [ ] 注册成功后，推荐关系正确绑定
- [ ] 分销员在"我的推广"中看到该用户

#### 标准3：佣金正确计算和到账
- [ ] 被推荐用户首次购买会员
- [ ] 订单支付成功后，佣金正确计算
- [ ] 佣金进入7天冻结期
- [ ] 冻结期结束后，佣金转为可提现
- [ ] 分销员余额正确增加

#### 标准4：提现流程完整
- [ ] 分销员申请提现
- [ ] 管理员审核通过
- [ ] 可提现余额正确扣除
- [ ] 提现记录状态正确更新
- [ ] 分销员收到提现成功通知

#### 标准5：财务数据准确
- [ ] 佣金基于订单实付金额计算（非原价）
- [ ] 同一订单不重复计佣
- [ ] 可提现金额 = 累计佣金 - 冻结佣金 - 已提现佣金
- [ ] 管理后台累计佣金支出 = 所有已到账佣金之和

### 8.2 测试场景

#### 场景1：完整推广流程
1. 用户A申请成为分销员
2. 管理员审核通过
3. 用户A获得邀请码和推广链接
4. 用户B通过推广链接注册
5. 用户B购买会员（¥99）
6. 系统计算佣金（¥99 × 15% = ¥14.85）
7. 佣金进入7天冻结期
8. 7天后佣金转为可提现
9. 用户A申请提现
10. 管理员审核通过
11. 用户A提现成功

**预期结果**：所有步骤正确执行，佣金计算准确

#### 场景2：使用优惠券后的佣金计算
1. 用户B有一张¥20优惠券
2. 用户B购买会员，使用优惠券
3. 订单原价¥99，实付¥79
4. 系统计算佣金

**预期结果**：佣金 = ¥79 × 15% = ¥11.85（基于实付）

#### 场景3：订单退款后佣金取消
1. 用户B购买会员，产生佣金
2. 佣金处于冻结期
3. 用户B申请退款并成功
4. 观察佣金状态

**预期结果**：冻结佣金自动取消，分销员余额不增加

#### 场景4：防止重复计佣
1. 用户B首次购买会员，产生佣金
2. 用户B再次购买会员（续费）
3. 观察是否产生新佣金

**预期结果**：第二次购买不产生佣金

#### 场景5：提现金额校验
1. 分销员可提现余额为¥50
2. 尝试提现¥100

**预期结果**：提示"余额不足"，提现失败

---

## 9. 任务卡清单概述

由于分销系统较复杂，任务卡将拆分为独立文件：

1. **任务卡-DatabaseMigration-分销代理.md** - 数据库迁移
2. **任务卡-Backend-分销代理.md** - 后端接口开发
3. **任务卡-Frontend-分销代理.md** - 前端页面开发
4. **任务卡-BillingGuard-分销代理.md** - 财务安全审查
5. **任务卡-QA-分销代理.md** - 功能验收测试
6. **任务卡-Reviewer-分销代理.md** - 代码审查

详细任务卡内容见各独立文件。

---

## 10. 总结给老板

### 一句话总结
**构建完整的分销代理系统，支持推荐关系绑定、佣金结算、提现管理全流程，建立用户增长裂变机制。**

### 执行顺序

**阶段1：数据库和后端基础（预计4-5天）**
1. 数据库迁移 - 创建分销相关表
2. 后端 - 分销员管理和推荐关系
3. 后端 - 佣金计算和提现逻辑

**阶段2：前端页面开发（预计4-5天）**
4. 前端 - 用户端分销中心
5. 前端 - 管理员端分销管理

**阶段3：审查和测试（预计3-4天）**
6. Billing Guard - 财务安全审查
7. QA - 功能验收测试
8. Reviewer - 代码审查

**总预计时间：11-14天**

### 风险提醒

#### 风险1：自推自买作弊（高风险）
- **风险描述**：分销员自己注册小号购买会员赚佣金
- **应对方案**：
  - 限制同一设备/IP短期内注册多账号
  - 后台监控异常推广行为
  - 人工审核异常订单
  - 发现作弊立即禁用分销员资格

#### 风险2：佣金计算错误（高风险）
- **风险描述**：佣金重复计算或计算错误，导致财务损失
- **应对方案**：
  - 数据库唯一索引防止重复计佣
  - 佣金基于实付金额而非原价
  - 充分的单元测试和集成测试
  - Billing Guard严格审查

#### 风险3：提现审核压力（中风险）
- **风险描述**：大量提现申请，人工审核压力大
- **应对方案**：
  - 设置最低提现金额（¥100）减少申请频次
  - 后续可开发自动审核规则
  - 异常提现人工审核，正常提现自动审核

#### 风险4：推荐关系作弊（中风险）
- **风险描述**：恶意修改推荐关系
- **应对方案**：
  - 推荐关系一旦绑定永久不可更改
  - 前端不允许修改推荐人ID
  - 后端严格校验推荐关系

#### 风险5：与优惠券系统冲突（中风险）
- **风险描述**：用户同时使用优惠券和推荐链接，佣金计算复杂
- **应对方案**：
  - 明确规则：佣金基于订单实付金额
  - 优惠券和分销可以叠加使用
  - 分销员赚的佣金基于折后价

### 关键成功因素

1. **财务安全第一**：佣金计算必须准确，防止作弊
2. **推荐关系准确**：URL参数传递、绑定逻辑必须可靠
3. **用户体验良好**：分销中心数据清晰，提现流程顺畅
4. **防作弊机制**：多维度防止自推自买和恶意套利
5. **数据统计准确**：为运营决策提供可靠数据支持

---

**🎉 分销代理系统PRD完成！**
