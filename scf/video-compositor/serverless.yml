service: video-compositor

provider:
  name: tencentcloud
  runtime: Nodejs18.15  # 腾讯云最新版本
  region: ${env:TENCENT_REGION, 'ap-guangzhou'}
  memorySize: 3072
  timeout: 300
  environment:
    TENCENT_SECRET_ID: ${env:TENCENT_SECRET_ID}
    TENCENT_SECRET_KEY: ${env:TENCENT_SECRET_KEY}
    COS_BUCKET: ${env:COS_BUCKET}
    COS_REGION: ${env:COS_REGION, 'ap-guangzhou'}
    INTERNAL_CALLBACK_SECRET: ${env:INTERNAL_CALLBACK_SECRET}
    BACKEND_API_URL: ${env:BACKEND_API_URL}
    FFMPEG_PATH: /opt/bin/ffmpeg
    LOG_LEVEL: ${env:LOG_LEVEL, 'info'}

functions:
  compositor:
    handler: index.main_handler
    description: 视频合成云函数 - 多SKU合辑短片处理
    events:
      - apigw:
          name: video-compositor-api
          parameters:
            serviceId: ${env:APIGW_SERVICE_ID}
            environment: ${env:APIGW_ENVIRONMENT, 'release'}
            endpoints:
              - path: /video-compositor
                method: POST
                description: 视频合成接口

layers:
  - name: ffmpeg-layer
    version: ${env:FFMPEG_LAYER_VERSION, '1'}
    description: FFmpeg 可执行文件和依赖库
  - name: fonts-layer
    version: ${env:FONTS_LAYER_VERSION, '1'}
    description: 思源黑体等中文字体

plugins:
  - serverless-tencent-scf

custom:
  # 部署排除文件
  exclude:
    - .git/**
    - .gitignore
    - node_modules/**/.cache/**
    - README.md
    - test/**
