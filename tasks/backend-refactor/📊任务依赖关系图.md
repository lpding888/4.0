# 📊 后端重构任务依赖关系图

> **制定人**: 老王
> **制定日期**: 2025-11-02
> **用途**: 明确18个任务之间的依赖关系，避免错误的执行顺序

---

## 🎯 核心依赖链

### 依赖链1：认证系统（P0-002是核心）

```
P0-002 双Token JWT系统（8h）
  ├─→ P0-006 微信登录集成（8h）         [依赖P0-002的双Token机制]
  ├─→ P0-007 密码登录重构（6h）         [依赖P0-002的双Token机制]
  └─→ P0-009 统一认证中间件（6h）       [依赖P0-002的TokenPayload设计]
```

**说明**:
- P0-002必须最先完成，它是基础设施
- P0-002完成后，P0-006、P0-007、P0-009可以并行开发
- P0-009建议在P0-002完成后立即做，因为它会影响所有路由

**推荐顺序**: P0-002 → P0-009 → P0-006 / P0-007

---

### 依赖链2：配额管理（P0-001是核心）

```
P0-001 Saga模式配额管理（10h）
  └─→ P0-004 Pipeline并发控制（6h）    [依赖P0-001的配额管理机制]
```

**说明**:
- P0-001实现了配额的reserve/confirm/cancel机制
- P0-004的并发控制需要配合P0-001的配额管理
- P0-004会限制FORK/JOIN的并发数，避免触发AI服务限流

**推荐顺序**: P0-001 → P0-004

---

### 独立任务（无依赖，可随时开发）

```
P0-003 Knex连接池优化（4h）         [独立任务，最简单]
P0-005 COS成本控制（6h）            [独立任务]
P0-008 真实支付SDK集成（12h）       [独立任务，但复杂度高]

P1-010 Redis缓存服务（6h）          [独立任务]
P1-011 WebSocket任务推送（8h）      [独立任务]
P1-012 错误码枚举（4h）             [独立任务]
P1-013 Swagger API文档（6h）        [独立任务]
P1-014 Prometheus监控（8h）         [独立任务]
P1-015 邀请码优化（4h）             [独立任务]
P1-016 用户资料扩展（4h）           [独立任务]
P1-017 推荐人验证（4h）             [独立任务]
P1-018 KMS加密服务（6h）            [独立任务]
```

---

## 📅 按时间线的依赖关系

### Week 1（6个任务）

```
Day 1:
  P0-003 连接池优化（4h）           ← 独立，先做热身
  P0-002 双Token JWT（开始4h）      ← 依赖链1的基础

Day 2:
  P0-002 双Token JWT（完成4h）      ← 继续
  P0-009 统一认证中间件（4h）       ← 依赖P0-002 ✅

Day 3:
  P0-001 Saga配额管理（10h）        ← 依赖链2的基础

Day 4:
  P0-005 COS成本控制（6h）          ← 独立
```

**依赖检查**:
- ✅ Day 2的P0-009依赖Day 1-2的P0-002 → 正确
- ✅ Day 3的P0-001独立 → 正确
- ✅ Day 4的P0-005独立 → 正确

---

### Week 2（3个任务）

```
Day 1:
  P0-004 并发控制（6h）             ← 依赖P0-001（Week 1 Day 3完成）✅

Day 2:
  P0-006 微信登录（8h）             ← 依赖P0-002（Week 1 Day 1-2完成）✅

Day 3:
  P0-007 密码登录（6h）             ← 依赖P0-002（Week 1 Day 1-2完成）✅

Day 4-5:
  P0-008 支付SDK（12h）             ← 独立
```

**依赖检查**:
- ✅ Day 1的P0-004依赖Week 1的P0-001 → 正确
- ✅ Day 2的P0-006依赖Week 1的P0-002 → 正确
- ✅ Day 3的P0-007依赖Week 1的P0-002 → 正确
- ✅ Day 4-5的P0-008独立 → 正确

---

### Week 3-4（9个P1任务）

所有P1任务都是独立的，可以按任意顺序开发，无依赖关系。

---

## 🚫 错误的执行顺序示例

### 错误1：先做P0-006，再做P0-002

```
❌ 错误顺序：
P0-006 微信登录（8h）
  → 失败！因为P0-006需要P0-002的双Token机制

✅ 正确顺序：
P0-002 双Token JWT（8h）
  → P0-006 微信登录（8h）
```

### 错误2：先做P0-004，再做P0-001

```
❌ 错误顺序：
P0-004 并发控制（6h）
  → 失败！因为P0-004需要P0-001的配额管理机制

✅ 正确顺序：
P0-001 Saga配额管理（10h）
  → P0-004 并发控制（6h）
```

### 错误3：先做P0-009，再做P0-002

```
❌ 错误顺序：
P0-009 统一认证中间件（6h）
  → 失败！因为P0-009需要P0-002的TokenPayload设计

✅ 正确顺序：
P0-002 双Token JWT（8h）
  → P0-009 统一认证中间件（6h）
```

---

## 🎯 最优执行顺序（推荐）

### P0任务最优顺序

```
1. P0-003 连接池优化（4h）            ← 独立，最简单，先热身
2. P0-002 双Token JWT（8h）           ← 依赖链1基础
3. P0-009 统一认证中间件（6h）        ← 依赖P0-002，立即做
4. P0-001 Saga配额管理（10h）         ← 依赖链2基础
5. P0-005 COS成本控制（6h）           ← 独立
6. P0-004 并发控制（6h）              ← 依赖P0-001
7. P0-006 微信登录（8h）              ← 依赖P0-002
8. P0-007 密码登录（6h）              ← 依赖P0-002
9. P0-008 支付SDK（12h）              ← 独立，最复杂，最后做
```

**总工时**: 66小时

---

### P1任务最优顺序（建议）

```
10. P1-010 Redis缓存（6h）             ← 提升性能
11. P1-011 WebSocket推送（8h）         ← 改善用户体验
12. P1-012 错误码枚举（4h）            ← 快速完成
13. P1-015 邀请码优化（4h）            ← 快速完成
14. P1-016 用户资料扩展（4h）          ← 快速完成
15. P1-017 推荐人验证（4h）            ← 快速完成
16. P1-013 Swagger文档（6h）           ← 完善文档
17. P1-014 Prometheus监控（8h）        ← 生产环境必备
18. P1-018 KMS加密（6h）               ← 安全加固
```

**总工时**: 50小时

---

## 🔍 依赖检查清单

### 开发P0-002前检查

- [ ] 无依赖，可以直接开发

### 开发P0-006前检查

- [ ] P0-002已完成？（双Token机制）
- [ ] 已测试`/auth/refresh`接口？
- [ ] TokenPayload包含role字段？

### 开发P0-007前检查

- [ ] P0-002已完成？（双Token机制）
- [ ] 已测试`/auth/refresh`接口？

### 开发P0-009前检查

- [ ] P0-002已完成？（TokenPayload设计）
- [ ] TokenPayload包含role字段？
- [ ] 9个路由文件列表清楚了吗？

### 开发P0-004前检查

- [ ] P0-001已完成？（Saga配额管理）
- [ ] `QuotaService.reserve/confirm/cancel`已实现？
- [ ] `quota_transactions`表已创建？

---

## 📊 依赖矩阵

| 任务 | 依赖任务 | 说明 |
|------|---------|------|
| P0-001 | 无 | 独立任务 |
| P0-002 | 无 | 独立任务 |
| P0-003 | 无 | 独立任务 |
| P0-004 | P0-001 | 需要配额管理机制 |
| P0-005 | 无 | 独立任务 |
| P0-006 | P0-002 | 需要双Token机制 |
| P0-007 | P0-002 | 需要双Token机制 |
| P0-008 | 无 | 独立任务 |
| P0-009 | P0-002 | 需要TokenPayload设计 |
| P1-010~P1-018 | 无 | 全部独立 |

---

## 🚀 并行开发策略

### Week 1可以并行的任务

```
Team A: P0-002 双Token JWT（8h）
Team B: P0-003 连接池优化（4h）→ P0-005 COS成本（6h）

并行完成后：
Team A: P0-009 统一认证（6h）
Team B: P0-001 Saga配额（10h）
```

### Week 2可以并行的任务

```
Team A: P0-004 并发控制（6h）→ P0-006 微信登录（8h）
Team B: P0-007 密码登录（6h）→ P0-008 支付SDK（12h）
```

**注意**: 并行开发需要确保依赖任务已完成！

---

## ⚠️ 关键风险点

### 风险1：P0-002延迟

**影响**: P0-006、P0-007、P0-009都会延迟
**应对**:
- P0-002是关键路径，必须优先保证
- 预留1-2小时buffer时间
- 发现延迟立即调整Week 1计划

### 风险2：P0-001延迟

**影响**: P0-004会延迟
**应对**:
- P0-001独立性强，可以专注开发
- 参考完整技术方案，减少返工
- 多写测试用例，确保质量

### 风险3：P0-008复杂度高

**影响**: Week 2可能延期
**应对**:
- P0-008是Week 2最后的任务，有buffer空间
- 严格参考官方SDK文档
- 支付回调验签是重点，多测试

---

**总结**:
- 2条核心依赖链（认证系统、配额管理）
- 11个独立任务（可灵活安排）
- 最优顺序已规划好（按1-18顺序执行即可）
- 并行开发需谨慎（确保依赖已完成）

**制定人**: 老王
**审核人**: 待定
**生效日期**: 2025-11-02

艹！这个依赖关系图够清晰了吧？照着这个顺序干，绝对不会出错！💪
