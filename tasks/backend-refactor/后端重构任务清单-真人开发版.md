# 后端架构重构任务清单（真人开发版）

> **适用对象**: 后端开发工程师
> **任务总数**: 18个（9个P0 + 9个P1）
> **预估总工时**: 140-160小时
> **参考方案**: 详见 `docs/后端架构问题解决回答`（GPT-5完整技术方案）

---

## 📌 重要说明

### 参考资料位置
- **问题报告**: `docs/后端架构重构问题报告-GPT5专用.md`（18个问题详细分析）
- **技术方案**: `docs/后端架构问题解决回答`（949行完整代码方案）
- **方案评估**: `docs/GPT5后端方案质量评估-老王专业版.md`（质量评分90/100）

### 代码规范要求
- ✅ 所有代码使用TypeScript编写
- ✅ 遵循SOLID原则
- ✅ 统一使用AppError错误处理
- ✅ 单元测试覆盖率：P0任务≥80%，P1任务≥70%
- ✅ 所有PR必须经过Code Review

---

## P0级任务（9个，必须完成）

### P0-001: Saga模式配额管理
**问题**: Pipeline执行失败时，配额已扣除但无法回滚
**优先级**: P0
**工时**: 10小时
**依赖**: 无

**核心要求**:
1. 创建`quota_transactions`表（字段：id, task_id, user_id, amount, phase, idempotent_done）
2. 实现`QuotaService`三个方法：
   - `reserve(userId, taskId, amount)` - 预留配额（使用forUpdate锁）
   - `confirm(taskId)` - 确认扣减（幂等性）
   - `cancel(taskId)` - 退还配额（幂等性）
3. 修改`TaskService`：创建任务时调用`reserve()`
4. 修改`PipelineEngine`：成功调用`confirm()`，失败调用`cancel()`

**交付物**:
- `backend/src/db/migrations/20250102000001_create_quota_transactions.ts`
- `backend/src/services/quota.service.ts`（重构版）
- `backend/tests/services/quota.service.spec.ts`

**验收标准**:
- [ ] Pipeline执行失败时，配额能正确退还
- [ ] 重复confirm/cancel不会重复操作（幂等性）
- [ ] 单元测试覆盖率≥85%

**参考代码**: `docs/后端架构问题解决回答` 第4节（Saga模式实现）

---

### P0-002: 双Token JWT系统
**问题**: JWT无刷新机制，泄露后无法撤销
**优先级**: P0
**工时**: 8小时
**依赖**: 无

**核心要求**:
1. 实现双Token机制：
   - Access Token：15分钟有效期
   - Refresh Token：7天有效期，存储在Redis
2. Refresh Token包含唯一`jti`标识，存储在Redis（key: `refresh:{userId}`）
3. 实现`/auth/refresh`接口，支持Refresh Token Rotation
4. 实现`/auth/logout`接口，删除Redis中的jti实现登出
5. TokenPayload必须包含`role`字段（解决管理员验证需要查库的问题）

**交付物**:
- `backend/src/utils/jwt.ts`（Token生成工具）
- `backend/src/controllers/auth.controller.ts`（新增refresh/logout方法）
- `backend/tests/utils/jwt.spec.ts`

**验收标准**:
- [ ] 登录返回accessToken和refreshToken
- [ ] /auth/refresh能正确刷新Token
- [ ] 登出后Refresh Token无法使用
- [ ] 单元测试覆盖率≥80%

**参考代码**: `docs/后端架构问题解决回答` 第6节（双Token JWT）

---

### P0-003: Knex连接池优化
**问题**: 数据库连接池配置不合理，生产环境连接池耗尽
**优先级**: P0
**工时**: 4小时
**依赖**: 无

**核心要求**:
1. 修改`knexfile.ts`的pool配置：
   - min: 10（避免冷启动）
   - max: 100（支持高并发）
   - idleTimeoutMillis: 30000（30秒空闲回收）
   - acquireConnectionTimeout: 10000（10秒获取超时）
2. 添加健康检查：afterCreate执行`SELECT 1`
3. 添加连接池监控：每30秒输出pool.used/free/pending指标

**交付物**:
- `backend/knexfile.ts`（更新pool配置）
- `backend/src/db/index.ts`（添加监控）

**验收标准**:
- [ ] 连接池配置已更新
- [ ] 100并发请求不会耗尽连接池
- [ ] 监控日志正常输出

**参考代码**: `docs/后端架构问题解决回答` 第8节（连接池配置）

---

### P0-004: Pipeline Engine并发控制
**问题**: FORK/JOIN并行执行无并发限制，触发AI服务限流
**优先级**: P0
**工时**: 6小时
**依赖**: P0-001

**核心要求**:
1. 安装`p-limit`依赖
2. 修改`pipelineEngine.service.ts`：
   - 创建`limit = pLimit(5)`（最多5个并发）
   - FORK/JOIN执行时使用limit包裹子任务
3. 并发数可配置（环境变量`MAX_PIPELINE_CONCURRENCY`）

**交付物**:
- `backend/src/services/pipelineEngine.service.ts`（添加并发控制）
- `backend/tests/services/pipelineEngine.spec.ts`（并发测试）

**验收标准**:
- [ ] FORK/JOIN并发数不超过5
- [ ] 不会触发AI服务限流
- [ ] 单元测试覆盖率≥75%

**参考代码**: `docs/后端架构问题解决回答` 第5节（并发控制）

---

### P0-005: COS成本控制
**问题**: COS存储无成本控制，失败任务的文件不会删除
**优先级**: P0
**工时**: 6小时
**依赖**: 无

**核心要求**:
1. 配置COS生命周期策略：自动删除30天前的文件
2. 实现`COSService.batchDelete(keys)`：批量删除文件
3. 实现`cleanupOrphanedFiles()`：清理孤儿文件（失败任务的临时文件）
4. 定时任务：每天凌晨3点执行清理

**交付物**:
- `backend/src/services/cos.service.ts`（添加批量删除和清理）
- `backend/src/jobs/cleanup-orphaned-files.job.ts`（定时任务）

**验收标准**:
- [ ] COS生命周期策略已配置
- [ ] 清理脚本能正确识别和删除孤儿文件
- [ ] 每天自动执行清理任务

**参考代码**: `docs/后端架构问题解决回答` 第9节（COS成本控制）

---

### P0-006: 微信登录集成
**问题**: 缺少微信登录，小程序无法上线
**优先级**: P0
**工时**: 8小时
**依赖**: P0-002

**核心要求**:
1. 实现`/auth/wechat-login`接口：
   - 接收前端传递的code
   - 调用微信API `code2Session`获取openid和unionid
   - 查找或创建用户（首次登录自动注册）
   - 返回双Token（Access + Refresh）
2. users表新增字段：`wechat_openid`, `wechat_unionid`
3. 创建数据库迁移脚本

**交付物**:
- `backend/src/controllers/auth.controller.ts`（新增wechatLogin方法）
- `backend/src/db/migrations/20250103000001_add_wechat_fields_to_users.ts`
- `backend/tests/controllers/auth.controller.spec.ts`

**验收标准**:
- [ ] 微信登录接口正常工作
- [ ] 首次登录能自动创建用户
- [ ] 返回有效的Access Token和Refresh Token

**参考代码**: `docs/后端架构问题解决回答` 第10节（微信登录）

---

### P0-007: 密码登录重构
**问题**: 验证码登录和密码登录逻辑混乱
**优先级**: P0
**工时**: 6小时
**依赖**: P0-002

**核心要求**:
1. `/auth/login`接口支持两种登录方式：
   - 验证码登录：phone + code
   - 密码登录：phone + password
2. `/auth/register`接口：phone + password + referrer_id（可选）
3. 密码使用bcrypt加密（盐轮数≥10）
4. users表新增字段：`password`（可为NULL）

**交付物**:
- `backend/src/controllers/auth.controller.ts`（重构login和register方法）
- `backend/src/db/migrations/20250103000002_add_password_to_users.ts`
- `backend/tests/controllers/auth.controller.spec.ts`

**验收标准**:
- [ ] 验证码登录和密码登录都能正常工作
- [ ] 密码使用bcrypt加密
- [ ] 注册接口能正确创建用户

**参考代码**: `docs/后端架构问题解决回答` 第11节（密码登录）

---

### P0-008: 真实支付SDK集成
**问题**: 支付系统只有MOCK代码，无法真实收款
**优先级**: P0
**工时**: 12小时
**依赖**: 无

**核心要求**:
1. 安装依赖：
   - `wechatpay-node-v3`（微信支付）
   - `alipay-sdk`（支付宝）
2. 实现`PaymentService`：
   - `createWechatOrder()` - 微信Native支付
   - `createAlipayOrder()` - 支付宝预创建
   - `handleWechatNotify()` - 微信支付回调（验签+幂等性）
   - `handleAlipayNotify()` - 支付宝回调（验签+幂等性）
3. 支付回调逻辑：更新订单状态 + 开通会员 + 增加配额

**交付物**:
- `backend/src/services/payment.service.ts`（完整支付逻辑）
- `backend/src/controllers/payment.controller.ts`（支付回调接口）
- `backend/tests/services/payment.service.spec.ts`

**验收标准**:
- [ ] 微信支付和支付宝支付都能生成二维码
- [ ] 支付回调能正确验签
- [ ] 支付成功后能开通会员和增加配额
- [ ] 重复回调不会重复处理（幂等性）

**参考代码**: `docs/后端架构问题解决回答` 第11节（支付SDK集成）

---

### P0-009: 统一认证中间件
**问题**: 两个认证中间件并存，管理员验证每次都查库
**优先级**: P0
**工时**: 6小时
**依赖**: P0-002

**核心要求**:
1. 删除旧文件：
   - `backend/src/middlewares/auth.middleware.js`
   - `backend/src/middlewares/adminAuth.middleware.js`
2. 使用新middleware：`backend/src/middleware/auth.middleware.ts`
3. TokenPayload统一包含`role`字段
4. `requireAdmin()`直接从JWT读取role，不查数据库
5. 迁移所有路由文件（9个）到新middleware

**交付物**:
- `backend/src/middleware/auth.middleware.ts`（统一middleware）
- 所有路由文件（修改import路径）
- `backend/tests/middleware/auth.middleware.spec.ts`

**验收标准**:
- [ ] 旧middleware文件已删除
- [ ] 所有路由使用新middleware
- [ ] 管理员验证不再查询数据库
- [ ] 单元测试覆盖率≥85%

**参考代码**: `docs/后端架构问题解决回答` 第7节（统一认证）

---

## P1级任务（9个，重要但非致命）

### P1-010: Redis缓存服务（6h）
**问题**: Redis仅用于验证码，高频查询未缓存
**核心**: 实现Cache-Aside模式缓存用户信息和配置数据
**参考**: `docs/后端架构问题解决回答` 第12节

### P1-011: WebSocket任务推送（8h）
**问题**: 前端轮询任务状态，性能差
**核心**: 使用Socket.IO推送任务状态更新
**参考**: `docs/后端架构问题解决回答` 第13节

### P1-012: 错误码枚举 + 全局异常处理（4h）
**问题**: 错误码使用字符串，不统一
**核心**: 实现ErrorCode枚举和AppError类
**参考**: `docs/后端架构问题解决回答` 第14节

### P1-013: Swagger API文档（6h）
**问题**: 缺少API文档，前后端协作效率低
**核心**: 为所有API添加OpenAPI 3.0注释
**参考**: `docs/后端架构问题解决回答` 第15节

### P1-014: Prometheus监控（8h）
**问题**: 缺少监控和告警，生产问题难排查
**核心**: 集成Prometheus指标采集和Grafana仪表盘
**参考**: `docs/后端架构问题解决回答` 第16节

### P1-015: 邀请码优化（4h）
**问题**: 邀请码生成有死循环风险
**核心**: 使用nanoid替换Math.random()，实现预生成池
**参考**: `docs/后端架构问题解决回答` 第17节

### P1-016: 用户资料字段扩展（4h）
**问题**: 用户表缺少昵称、头像、性别字段
**核心**: users表新增nickname、avatar、gender字段
**参考**: `docs/后端架构问题解决回答` 第18节

### P1-017: 推荐人验证（4h）
**问题**: 注册时不验证referrer_id有效性
**核心**: 注册时检查推荐人ID是否存在且有效
**参考**: `docs/后端架构问题解决回答` 第19节

### P1-018: KMS加密服务（6h）
**问题**: 敏感数据明文存储，安全风险高
**核心**: 集成腾讯云KMS加密支付密钥等敏感数据
**参考**: `docs/后端架构问题解决回答` 第20节

---

## 实施计划建议

### Week 1（6个任务，34小时）
1. P0-003 连接池优化（4h）- 最简单，先做
2. P0-002 双Token JWT（8h）- 基础设施
3. P0-009 统一认证（6h）- 依赖P0-002
4. P0-001 Saga配额（10h）- 核心逻辑
5. P0-005 COS成本（6h）- 成本控制

### Week 2（3个任务，32小时）
6. P0-004 并发控制（6h）- 依赖P0-001
7. P0-006 微信登录（8h）- 小程序必备
8. P0-007 密码登录（6h）- 统一登录
9. P0-008 支付SDK（12h）- 收入相关

### Week 3（6个任务，30小时）
10-15. P1任务（Redis缓存、WebSocket、错误码、邀请码、用户资料、推荐人验证）

### Week 4（3个任务，22小时）
16-18. P1任务（Swagger文档、Prometheus监控、KMS加密）

---

## 环境变量配置（所有任务完成后需要）

```bash
# JWT配置
JWT_SECRET=your-super-secret-key-change-in-production

# 微信小程序
WECHAT_APPID=wx1234567890abcdef
WECHAT_SECRET=your_wechat_secret

# 微信支付
WECHAT_PAY_APPID=wx1234567890abcdef
WECHAT_PAY_MCHID=1234567890
WECHAT_PAY_SERIAL_NO=your_serial_no
WECHAT_PAY_PRIVATE_KEY_PATH=/path/to/apiclient_key.pem

# 支付宝
ALIPAY_APPID=2021001234567890
ALIPAY_PRIVATE_KEY_PATH=/path/to/alipay_private_key.pem
ALIPAY_PUBLIC_KEY_PATH=/path/to/alipay_public_key.pem

# 腾讯云KMS
KMS_REGION=ap-guangzhou
KMS_SECRET_ID=your_kms_secret_id
KMS_SECRET_KEY=your_kms_secret_key
KMS_KEY_ID=your_kms_key_id

# Pipeline并发
MAX_PIPELINE_CONCURRENCY=5
```

---

**生成人**: 老王
**生成时间**: 2025-11-02
**备注**: 所有技术方案详见`docs/后端架构问题解决回答`文件，强烈建议开发前先阅读！
