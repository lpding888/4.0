# 后端重构任务卡清单（18个任务）

> **生成时间**: 2025-11-02
> **任务来源**: GPT-5后端架构重构解决方案
> **任务总数**: 18个（9个P0 + 9个P1）
> **预估总工时**: 约140-160小时

---

## 任务卡文件列表

### P0级任务（9个,优先级最高）

| 任务ID | 文件名 | 任务标题 | 预估工时 | 状态 |
|--------|--------|----------|----------|------|
| BACKEND-P0-001 | P0-001-saga-quota-management.json | Saga模式配额管理 - Reserve/Confirm/Cancel三阶段事务补偿 | 10h | ✅ 已生成 |
| BACKEND-P0-002 | P0-002-dual-token-jwt.json | 双Token JWT系统 - Access Token + Refresh Token | 8h | ✅ 已生成 |
| BACKEND-P0-003 | P0-003-knex-connection-pool.json | Knex连接池优化 - min/max/idle/health配置 | 4h | ✅ 已生成 |
| BACKEND-P0-004 | P0-004-pipeline-concurrency-control.json | Pipeline Engine并发控制 - p-limit限流 | 6h | 🔄 待生成 |
| BACKEND-P0-005 | P0-005-cos-cost-control.json | COS成本控制 - 生命周期+批量清理 | 6h | 🔄 待生成 |
| BACKEND-P0-006 | P0-006-wechat-login.json | 微信登录集成 - code2Session + 自动注册 | 8h | 🔄 待生成 |
| BACKEND-P0-007 | P0-007-password-login-refactor.json | 密码登录重构 - 统一验证码/密码登录 | 6h | 🔄 待生成 |
| BACKEND-P0-008 | P0-008-payment-sdk-integration.json | 真实支付SDK集成 - 微信支付+支付宝 | 12h | 🔄 待生成 |
| BACKEND-P0-009 | P0-009-unified-auth-middleware.json | 统一认证中间件 - 删除旧middleware迁移至新版 | 6h | 🔄 待生成 |

**P0小计**: 66小时

---

### P1级任务（9个,重要但非致命）

| 任务ID | 文件名 | 任务标题 | 预估工时 | 状态 |
|--------|--------|----------|----------|------|
| BACKEND-P1-010 | P1-010-redis-cache-service.json | Redis缓存服务 - Cache-Aside模式 | 6h | 🔄 待生成 |
| BACKEND-P1-011 | P1-011-websocket-task-push.json | WebSocket任务推送 - Socket.IO集成 | 8h | 🔄 待生成 |
| BACKEND-P1-012 | P1-012-error-code-and-handler.json | 错误码枚举 + 全局异常处理 | 4h | 🔄 待生成 |
| BACKEND-P1-013 | P1-013-swagger-api-doc.json | Swagger API文档 - OpenAPI 3.0注释 | 6h | 🔄 待生成 |
| BACKEND-P1-014 | P1-014-prometheus-monitoring.json | Prometheus监控 - 指标采集+Grafana仪表盘 | 8h | 🔄 待生成 |
| BACKEND-P1-015 | P1-015-invite-code-optimization.json | 邀请码优化 - nanoid+预生成池 | 4h | 🔄 待生成 |
| BACKEND-P1-016 | P1-016-user-profile-fields.json | 用户资料字段扩展 - nickname/avatar/gender | 4h | 🔄 待生成 |
| BACKEND-P1-017 | P1-017-referrer-validation.json | 推荐人验证 - 邀请码有效性检查 | 4h | 🔄 待生成 |
| BACKEND-P1-018 | P1-018-kms-encryption-service.json | 加密服务集成KMS - 腾讯云密钥管理 | 6h | 🔄 待生成 |

**P1小计**: 50小时

---

## 任务依赖关系图

```
P0阶段（Week 1-2）
├─ P0-001 Saga配额管理 (无依赖)
├─ P0-002 双Token JWT (无依赖)
├─ P0-003 Knex连接池 (无依赖)
├─ P0-004 Pipeline并发控制 (依赖P0-001)
├─ P0-005 COS成本控制 (无依赖)
├─ P0-006 微信登录 (依赖P0-002)
├─ P0-007 密码登录重构 (依赖P0-002)
├─ P0-008 支付SDK集成 (无依赖)
└─ P0-009 统一认证中间件 (依赖P0-002)

P1阶段（Week 3-4）
├─ P1-010 Redis缓存 (无依赖)
├─ P1-011 WebSocket推送 (无依赖)
├─ P1-012 错误码枚举 (无依赖)
├─ P1-013 Swagger文档 (依赖所有P0完成)
├─ P1-014 Prometheus监控 (无依赖)
├─ P1-015 邀请码优化 (无依赖)
├─ P1-016 用户资料字段 (无依赖)
├─ P1-017 推荐人验证 (依赖P1-016)
└─ P1-018 KMS加密 (无依赖)
```

---

## 实施路线图

### Week 1: P0核心基础（6个任务,34小时）
**目标**: 完成基础设施重构

1. **P0-003** Knex连接池优化（4h）- 最简单,先做
2. **P0-002** 双Token JWT系统（8h）- 基础设施
3. **P0-009** 统一认证中间件（6h）- 依赖P0-002
4. **P0-001** Saga配额管理（10h）- 核心业务逻辑
5. **P0-005** COS成本控制（6h）- 防止成本失控

**Week 1验收标准**:
- ✅ 数据库连接池稳定,支持100并发
- ✅ 双Token JWT系统上线,支持Token刷新
- ✅ 所有路由使用统一认证中间件
- ✅ Saga模式配额管理上线,配额能正确回滚
- ✅ COS文件有生命周期策略,孤儿文件能自动清理

---

### Week 2: P0核心业务（3个任务,32小时）
**目标**: 完成核心业务功能

6. **P0-004** Pipeline并发控制（6h）- 依赖P0-001
7. **P0-006** 微信登录集成（8h）- 小程序必备
8. **P0-007** 密码登录重构（6h）- 统一登录方式
9. **P0-008** 支付SDK集成（12h）- 收入相关

**Week 2验收标准**:
- ✅ Pipeline执行有并发控制,不会触发AI服务限流
- ✅ 微信小程序能正常登录
- ✅ 验证码登录和密码登录逻辑统一
- ✅ 微信支付和支付宝支付正常工作

---

### Week 3: P1性能优化（5个任务,28小时）
**目标**: 提升性能和用户体验

10. **P1-010** Redis缓存服务（6h）
11. **P1-011** WebSocket推送（8h）
12. **P1-012** 错误码枚举（4h）
13. **P1-015** 邀请码优化（4h）
14. **P1-016** 用户资料字段（4h）
15. **P1-017** 推荐人验证（4h）- 依赖P1-016

**Week 3验收标准**:
- ✅ 高频查询有Redis缓存,响应时间<100ms
- ✅ 任务状态通过WebSocket实时推送
- ✅ 错误码统一管理,前端能准确提示
- ✅ 邀请码生成无碰撞检测死循环风险
- ✅ 用户资料完整,支持昵称/头像/性别

---

### Week 4: P1运维保障（3个任务,22小时）
**目标**: 完善运维监控和安全

16. **P1-013** Swagger API文档（6h）
17. **P1-014** Prometheus监控（8h）
18. **P1-018** KMS加密服务（6h）

**Week 4验收标准**:
- ✅ 所有API有Swagger文档注释
- ✅ Prometheus指标采集正常,Grafana仪表盘可用
- ✅ 敏感数据使用KMS加密,审计日志完整

---

## 质量门禁要求

### 代码质量
- ✅ 所有代码使用TypeScript编写,类型定义完整
- ✅ 遵循SOLID原则,单一职责清晰
- ✅ 统一使用AppError错误处理
- ✅ 所有数据库操作在事务中执行（需要时）
- ✅ 代码符合ESLint规范

### 测试要求
- ✅ P0任务单元测试覆盖率 ≥ 80%
- ✅ P1任务单元测试覆盖率 ≥ 70%
- ✅ 所有核心功能有集成测试
- ✅ 所有API接口有Supertest测试

### 审查要求
- ✅ 所有任务必须经过Reviewer审查
- ✅ 审查重点：安全性、事务完整性、并发安全性、错误处理
- ✅ 发现问题立即退回修复

### QA验收
- ✅ P0任务必须QA验收通过
- ✅ 测试范围：功能测试、性能测试、安全测试
- ✅ 不通过则退回并提出修复建议

---

## 环境变量清单

所有任务完成后需要补充的环境变量：

```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=ai_photo

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置
JWT_SECRET=your-super-secret-key-change-in-production
ACCESS_TOKEN_EXPIRES=15m
REFRESH_TOKEN_EXPIRES=7d

# 腾讯云COS配置
COS_SECRET_ID=your_secret_id
COS_SECRET_KEY=your_secret_key
COS_BUCKET=your-bucket-name
COS_REGION=ap-guangzhou

# 微信小程序配置
WECHAT_APPID=wx1234567890abcdef
WECHAT_SECRET=your_wechat_secret

# 微信支付配置
WECHAT_PAY_APPID=wx1234567890abcdef
WECHAT_PAY_MCHID=1234567890
WECHAT_PAY_SERIAL_NO=your_serial_no
WECHAT_PAY_PRIVATE_KEY_PATH=/path/to/apiclient_key.pem

# 支付宝支付配置
ALIPAY_APPID=2021001234567890
ALIPAY_PRIVATE_KEY_PATH=/path/to/alipay_private_key.pem
ALIPAY_PUBLIC_KEY_PATH=/path/to/alipay_public_key.pem

# 腾讯云KMS配置
KMS_REGION=ap-guangzhou
KMS_SECRET_ID=your_kms_secret_id
KMS_SECRET_KEY=your_kms_secret_key
KMS_KEY_ID=your_kms_key_id

# API配置
API_BASE_URL=https://api.yourdomain.com
FRONTEND_URL=https://yourdomain.com

# Prometheus配置
PROMETHEUS_PORT=9090

# 其他配置
NODE_ENV=production
PORT=3000
```

---

## 使用说明

### 1. 如何使用任务卡

每个任务卡JSON文件包含完整的18个字段：
- `taskId`: 任务唯一标识
- `title`: 任务标题
- `department`: 部门（全部为Backend）
- `priority`: 优先级（P0/P1）
- `estimatedHours`: 预估工时
- `dependencies`: 依赖任务ID列表
- `description`: 任务描述
- `technicalRequirements`: 技术要求
- `acceptanceCriteria`: 验收标准
- `deliverables`: 交付物清单
- `needsCoordination`: 跨部门协作需求
- `aiPromptSuggestion`: AI提示词（system + user）
- `reviewPolicy`: 审查策略
- `qaPolicy`: QA策略
- `status`: 状态

### 2. 如何传递给GPT-5

将任务卡JSON文件内容直接复制粘贴给GPT-5，GPT-5会根据`aiPromptSuggestion`中的提示词完成任务。

### 3. 任务执行顺序

严格按照Week 1 → Week 2 → Week 3 → Week 4的顺序执行，确保依赖关系正确。

---

**生成人**: 老王（AI产品经理）
**生成时间**: 2025-11-02
**下一步**: 继续生成剩余15个任务卡JSON文件
