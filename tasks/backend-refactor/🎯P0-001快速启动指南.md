# ğŸ¯ P0-001 Sagaæ¨¡å¼é…é¢ç®¡ç† - å¿«é€Ÿå¯åŠ¨æŒ‡å—

> **ä»»åŠ¡ç¼–å·**: P0-001
> **ä»»åŠ¡åç§°**: Sagaæ¨¡å¼é…é¢ç®¡ç†
> **é¢„ä¼°å·¥æ—¶**: 10å°æ—¶
> **ä¾èµ–**: æ— 
> **ä¼˜å…ˆçº§**: â­â­â­â­â­ï¼ˆæœ€é«˜ï¼‰

---

## ğŸš€ ç«‹å³å¼€å§‹ï¼ˆ3æ­¥å¯åŠ¨ï¼‰

### ç¬¬1æ­¥ï¼šåˆ›å»ºGitåˆ†æ”¯ï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# ä»developæ‹‰å–æœ€æ–°ä»£ç 
git checkout develop
git pull origin develop

# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/P0-001-saga-quota

# æ¨é€åˆ°è¿œç¨‹
git push -u origin feature/P0-001-saga-quota
```

### ç¬¬2æ­¥ï¼šé˜…è¯»æŠ€æœ¯æ–¹æ¡ˆï¼ˆ30åˆ†é’Ÿï¼‰

**å¿…è¯»æ–‡ä»¶**: `docs/åç«¯æ¶æ„é—®é¢˜è§£å†³å›ç­”`

**é‡ç‚¹é˜…è¯»**: ç¬¬4èŠ‚ - Sagaæ¨¡å¼å®Œæ•´å®ç°ä»£ç 

**éœ€è¦ç†è§£çš„å…³é”®ç‚¹**:
- [ ] quota_transactionsè¡¨çš„å­—æ®µè®¾è®¡ï¼ˆç‰¹åˆ«æ˜¯phaseå’Œidempotent_doneï¼‰
- [ ] reserveæ–¹æ³•çš„forUpdateé”ä½¿ç”¨
- [ ] confirm/cancelçš„å¹‚ç­‰æ€§è®¾è®¡
- [ ] å¦‚ä½•é›†æˆåˆ°TaskServiceå’ŒPipelineEngine

### ç¬¬3æ­¥ï¼šç¡®è®¤ç¯å¢ƒå‡†å¤‡å°±ç»ªï¼ˆ10åˆ†é’Ÿï¼‰

```bash
# 1. å¯åŠ¨Docker Desktopï¼ˆå¿…é¡»ï¼‰
# æ‰‹åŠ¨æ‰“å¼€Docker Desktopåº”ç”¨

# 2. è¿›å…¥åç«¯ç›®å½•
cd backend

# 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# 4. æ£€æŸ¥æ•°æ®åº“è¿æ¥
# çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºè¡¨ç¤ºæ­£å¸¸ï¼š
# âœ… app.tsç¼–è¯‘æˆåŠŸ
# âœ… server.tsç¼–è¯‘æˆåŠŸ
# ğŸš€ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
# ğŸŒ ç«¯å£: 3001

# 5. æµ‹è¯•å•å…ƒæµ‹è¯•ç¯å¢ƒ
npm test

# 6. æµ‹è¯•æ•°æ®åº“è¿ç§»
npm run migrate:latest
```

---

## ğŸ“‹ 8ä¸ªå¼€å‘ä»»åŠ¡æ¸…å•

### ä»»åŠ¡1: åˆ›å»ºquota_transactionsè¡¨ï¼ˆ30åˆ†é’Ÿï¼‰

**æ–‡ä»¶**: `backend/src/db/migrations/20250102000001_create_quota_transactions.ts`

**å®Œæ•´ä»£ç **:
```typescript
import { Knex } from 'knex';

export async function up(knex: Knex): Promise<void> {
  return knex.schema.createTable('quota_transactions', (table) => {
    table.string('id', 32).primary().comment('å”¯ä¸€ID');
    table.string('task_id', 32).notNullable().unique().comment('ä»»åŠ¡ID');
    table.string('user_id', 32).notNullable().comment('ç”¨æˆ·ID');
    table.integer('amount').notNullable().defaultTo(1).comment('é…é¢æ•°é‡');
    table.enum('phase', ['reserved', 'confirmed', 'cancelled'])
      .notNullable()
      .defaultTo('reserved')
      .comment('é˜¶æ®µï¼šé¢„ç•™/ç¡®è®¤/å–æ¶ˆ');
    table.boolean('idempotent_done').notNullable().defaultTo(true)
      .comment('å¹‚ç­‰æ€§æ ‡è®°');
    table.timestamp('created_at').defaultTo(knex.fn.now()).comment('åˆ›å»ºæ—¶é—´');

    table.index('user_id');
    table.index('phase');
  });
}

export async function down(knex: Knex): Promise<void> {
  return knex.schema.dropTableIfExists('quota_transactions');
}
```

**æ‰§è¡Œè¿ç§»**:
```bash
npm run migrate:latest
```

**Gitæäº¤**:
```bash
git add backend/src/db/migrations/20250102000001_create_quota_transactions.ts
git commit -m "feat(quota): åˆ›å»ºquota_transactionsè¡¨

- å­—æ®µï¼šid, task_id, user_id, amount, phase, idempotent_done
- ç´¢å¼•ï¼štask_idå”¯ä¸€ç´¢å¼•, user_idç´¢å¼•, phaseç´¢å¼•
- æšä¸¾ï¼šphaseä¸‰ç§çŠ¶æ€ï¼ˆreserved/confirmed/cancelledï¼‰

Refs: #P0-001"
git push origin feature/P0-001-saga-quota
```

---

### ä»»åŠ¡2: å®ç°QuotaServiceçš„reserveæ–¹æ³•ï¼ˆ1å°æ—¶ï¼‰

**æ–‡ä»¶**: `backend/src/services/quota.service.ts`

**ä½ç½®**: æ‰¾åˆ°ç°æœ‰çš„`quota.service.ts`æ–‡ä»¶ï¼ˆåº”è¯¥åœ¨`backend/src/services/`ç›®å½•ï¼‰

**ä¿®æ”¹å†…å®¹**: æ·»åŠ ä»¥ä¸‹æ–¹æ³•

```typescript
import { v4 as uuid } from 'uuid';
import db from '../db';
import { AppError, ErrorCode } from '../utils/errors';

/**
 * é¢„ç•™é…é¢ï¼ˆSagaæ¨¡å¼ - Reserveé˜¶æ®µï¼‰
 * @param userId ç”¨æˆ·ID
 * @param taskId ä»»åŠ¡ID
 * @param amount é…é¢æ•°é‡ï¼ˆé»˜è®¤1ï¼‰
 */
async reserve(userId: string, taskId: string, amount = 1): Promise<void> {
  return db.transaction(async (trx) => {
    // 1. ä½¿ç”¨forUpdateé”å®šç”¨æˆ·è¡Œï¼ˆé˜²æ­¢å¹¶å‘è¶…å–ï¼‰
    const user = await trx('users')
      .where({ id: userId })
      .forUpdate()
      .first();

    // 2. æ£€æŸ¥é…é¢æ˜¯å¦è¶³å¤Ÿ
    if (!user || user.quota_remaining < amount) {
      throw new AppError(ErrorCode.QUOTA_INSUFFICIENT, 'é…é¢ä¸è¶³ï¼Œè¯·ç»­è´¹', 403);
    }

    // 3. æ‰£å‡é…é¢
    await trx('users').where({ id: userId }).update({
      quota_remaining: user.quota_remaining - amount,
    });

    // 4. è®°å½•Reserveé˜¶æ®µ
    await trx('quota_transactions').insert({
      id: uuid().replace(/-/g, ''),
      task_id: taskId,
      user_id: userId,
      amount,
      phase: 'reserved',
      idempotent_done: true,
    });
  });
}
```

**Gitæäº¤**:
```bash
git add backend/src/services/quota.service.ts
git commit -m "feat(quota): å®ç°reserveæ–¹æ³•

- ä½¿ç”¨forUpdateé”å®šç”¨æˆ·è¡Œ
- æ£€æŸ¥é…é¢æ˜¯å¦è¶³å¤Ÿ
- æ‰£å‡é…é¢å¹¶è®°å½•reservedçŠ¶æ€
- äº‹åŠ¡ä¿è¯åŸå­æ€§

Refs: #P0-001"
git push origin feature/P0-001-saga-quota
```

---

### ä»»åŠ¡3: å®ç°QuotaServiceçš„confirmæ–¹æ³•ï¼ˆ30åˆ†é’Ÿï¼‰

**æ–‡ä»¶**: `backend/src/services/quota.service.ts`

**æ·»åŠ æ–¹æ³•**:
```typescript
/**
 * ç¡®è®¤é…é¢æ‰£å‡ï¼ˆSagaæ¨¡å¼ - Confirmé˜¶æ®µï¼‰
 * @param taskId ä»»åŠ¡ID
 */
async confirm(taskId: string): Promise<void> {
  const record = await db('quota_transactions')
    .where({ task_id: taskId, phase: 'reserved' })
    .first();

  // å¹‚ç­‰æ€§æ£€æŸ¥ï¼šå¦‚æœä¸æ˜¯reservedçŠ¶æ€ï¼Œç›´æ¥è¿”å›
  if (!record || record.idempotent_done !== true) {
    return;
  }

  await db('quota_transactions')
    .where({ task_id: taskId })
    .update({ phase: 'confirmed' });
}
```

**Gitæäº¤**:
```bash
git add backend/src/services/quota.service.ts
git commit -m "feat(quota): å®ç°confirmæ–¹æ³•

- å¹‚ç­‰æ€§æ£€æŸ¥ï¼šåªç¡®è®¤reservedçŠ¶æ€çš„è®°å½•
- æ›´æ–°phaseä¸ºconfirmed
- é‡å¤è°ƒç”¨ä¸ä¼šæŠ¥é”™

Refs: #P0-001"
git push origin feature/P0-001-saga-quota
```

---

### ä»»åŠ¡4: å®ç°QuotaServiceçš„cancelæ–¹æ³•ï¼ˆ1å°æ—¶ï¼‰

**æ–‡ä»¶**: `backend/src/services/quota.service.ts`

**æ·»åŠ æ–¹æ³•**:
```typescript
/**
 * å–æ¶ˆé…é¢æ‰£å‡ï¼ˆSagaæ¨¡å¼ - Cancelé˜¶æ®µï¼‰
 * @param taskId ä»»åŠ¡ID
 */
async cancel(taskId: string): Promise<void> {
  return db.transaction(async (trx) => {
    const record = await trx('quota_transactions')
      .where({ task_id: taskId, phase: 'reserved' })
      .first();

    // å¹‚ç­‰æ€§æ£€æŸ¥
    if (!record || record.phase !== 'reserved') {
      return;
    }

    // é€€è¿˜é…é¢ï¼ˆä½¿ç”¨incrementåŸå­æ“ä½œï¼‰
    await trx('users')
      .where({ id: record.user_id })
      .increment('quota_remaining', record.amount);

    // æ›´æ–°çŠ¶æ€
    await trx('quota_transactions')
      .where({ task_id: taskId })
      .update({ phase: 'cancelled' });
  });
}
```

**Gitæäº¤**:
```bash
git add backend/src/services/quota.service.ts
git commit -m "feat(quota): å®ç°cancelæ–¹æ³•

- äº‹åŠ¡ä¸­é€€è¿˜é…é¢
- ä½¿ç”¨incrementåŸå­æ“ä½œ
- å¹‚ç­‰æ€§æ£€æŸ¥ï¼šåªå–æ¶ˆreservedçŠ¶æ€çš„è®°å½•

Refs: #P0-001"
git push origin feature/P0-001-saga-quota
```

---

### ä»»åŠ¡5: ä¿®æ”¹TaskServiceé›†æˆreserveæ–¹æ³•ï¼ˆ30åˆ†é’Ÿï¼‰

**æ–‡ä»¶**: `backend/src/services/task.service.ts`

**ä¿®æ”¹ä½ç½®**: æ‰¾åˆ°`createTask`æ–¹æ³•

**ä¿®æ”¹å†…å®¹**:
```typescript
import quotaService from './quota.service';

async createTask(userId: string, featureId: string, inputData: any) {
  const taskId = uuid().replace(/-/g, '');

  // âš ï¸ å…³é”®ï¼šå…ˆé¢„ç•™é…é¢ï¼Œå¤±è´¥åˆ™ä¸åˆ›å»ºä»»åŠ¡
  await quotaService.reserve(userId, taskId, 1);

  // åˆ›å»ºä»»åŠ¡
  await db('tasks').insert({
    id: taskId,
    user_id: userId,
    feature_id: featureId,
    input_data: JSON.stringify(inputData),
    status: 'pending',
    created_at: db.fn.now(),
  });

  return taskId;
}
```

**Gitæäº¤**:
```bash
git add backend/src/services/task.service.ts
git commit -m "feat(quota): TaskServiceé›†æˆreserveæ–¹æ³•

- åˆ›å»ºä»»åŠ¡å‰å…ˆé¢„ç•™é…é¢
- reserveå¤±è´¥åˆ™ä¸åˆ›å»ºä»»åŠ¡
- ä¼ é€’æ­£ç¡®çš„taskId

Refs: #P0-001"
git push origin feature/P0-001-saga-quota
```

---

### ä»»åŠ¡6: ä¿®æ”¹PipelineEngineé›†æˆconfirm/cancelæ–¹æ³•ï¼ˆ30åˆ†é’Ÿï¼‰

**æ–‡ä»¶**: `backend/src/services/pipelineEngine.service.ts`

**ä¿®æ”¹ä½ç½®**: æ‰¾åˆ°`executePipeline`æˆ–ç±»ä¼¼æ–¹æ³•

**ä¿®æ”¹å†…å®¹**:
```typescript
import quotaService from './quota.service';

async executePipeline(taskId: string, featureId: string, inputData: any) {
  try {
    // æ‰§è¡ŒPipelineé€»è¾‘
    const result = await this.executeSteps(taskId, steps, inputData);

    // âœ… æˆåŠŸæ—¶ç¡®è®¤é…é¢æ‰£å‡
    await quotaService.confirm(taskId);

    return result;
  } catch (error) {
    // âŒ å¤±è´¥æ—¶å–æ¶ˆé…é¢æ‰£å‡ï¼ˆé€€è¿˜é…é¢ï¼‰
    await quotaService.cancel(taskId);

    throw error;
  }
}
```

**Gitæäº¤**:
```bash
git add backend/src/services/pipelineEngine.service.ts
git commit -m "feat(quota): PipelineEngineé›†æˆconfirm/cancel

- æˆåŠŸæ—¶è°ƒç”¨confirmç¡®è®¤æ‰£å‡
- å¤±è´¥æ—¶è°ƒç”¨cancelé€€è¿˜é…é¢
- ç¡®ä¿cancelè°ƒç”¨åœ¨é”™è¯¯æŠ›å‡ºä¹‹å‰

Refs: #P0-001"
git push origin feature/P0-001-saga-quota
```

---

### ä»»åŠ¡7: åˆ›å»ºQuotaServiceå•å…ƒæµ‹è¯•ï¼ˆ2å°æ—¶ï¼‰

**æ–‡ä»¶**: `backend/tests/services/quota.service.spec.ts`

**å®Œæ•´æµ‹è¯•ä»£ç **:
```typescript
import quotaService from '../../src/services/quota.service';
import db from '../../src/db';
import { v4 as uuid } from 'uuid';

describe('QuotaService - Sagaæ¨¡å¼', () => {
  let userId: string;
  let taskId: string;

  beforeEach(async () => {
    // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    userId = uuid().replace(/-/g, '');
    await db('users').insert({
      id: userId,
      phone: '13800138000',
      quota_remaining: 10,
      role: 'user',
      created_at: db.fn.now(),
    });

    taskId = uuid().replace(/-/g, '');
  });

  afterEach(async () => {
    // æ¸…ç†æµ‹è¯•æ•°æ®
    await db('quota_transactions').where({ user_id: userId }).del();
    await db('users').where({ id: userId }).del();
  });

  // æµ‹è¯•1: reserveæ­£å¸¸æµç¨‹
  it('åº”è¯¥æ­£ç¡®é¢„ç•™é…é¢', async () => {
    await quotaService.reserve(userId, taskId, 1);

    // éªŒè¯é…é¢æ‰£å‡
    const user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(9);

    // éªŒè¯äº‹åŠ¡è®°å½•
    const transaction = await db('quota_transactions')
      .where({ task_id: taskId })
      .first();
    expect(transaction.phase).toBe('reserved');
    expect(transaction.amount).toBe(1);
  });

  // æµ‹è¯•2: reserveé…é¢ä¸è¶³
  it('é…é¢ä¸è¶³æ—¶åº”è¯¥æŠ›å‡ºé”™è¯¯', async () => {
    await expect(
      quotaService.reserve(userId, taskId, 20)
    ).rejects.toThrow('é…é¢ä¸è¶³');

    // éªŒè¯é…é¢æœªæ‰£å‡
    const user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(10);

    // éªŒè¯æ²¡æœ‰äº‹åŠ¡è®°å½•
    const transaction = await db('quota_transactions')
      .where({ task_id: taskId })
      .first();
    expect(transaction).toBeUndefined();
  });

  // æµ‹è¯•3: reserve â†’ confirmæµç¨‹
  it('åº”è¯¥æ­£ç¡®æ‰§è¡Œreserve â†’ confirmæµç¨‹', async () => {
    await quotaService.reserve(userId, taskId, 1);
    await quotaService.confirm(taskId);

    // éªŒè¯çŠ¶æ€æ›´æ–°
    const transaction = await db('quota_transactions')
      .where({ task_id: taskId })
      .first();
    expect(transaction.phase).toBe('confirmed');

    // éªŒè¯é…é¢å·²æ‰£å‡
    const user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(9);
  });

  // æµ‹è¯•4: reserve â†’ cancelæµç¨‹
  it('åº”è¯¥æ­£ç¡®æ‰§è¡Œreserve â†’ cancelæµç¨‹', async () => {
    await quotaService.reserve(userId, taskId, 1);
    await quotaService.cancel(taskId);

    // éªŒè¯çŠ¶æ€æ›´æ–°
    const transaction = await db('quota_transactions')
      .where({ task_id: taskId })
      .first();
    expect(transaction.phase).toBe('cancelled');

    // éªŒè¯é…é¢å·²é€€è¿˜
    const user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(10);
  });

  // æµ‹è¯•5: confirmå¹‚ç­‰æ€§
  it('é‡å¤confirmåº”è¯¥æ˜¯å¹‚ç­‰çš„', async () => {
    await quotaService.reserve(userId, taskId, 1);
    await quotaService.confirm(taskId);
    await quotaService.confirm(taskId); // ç¬¬äºŒæ¬¡è°ƒç”¨

    // éªŒè¯åªæ‰§è¡Œä¸€æ¬¡
    const transaction = await db('quota_transactions')
      .where({ task_id: taskId })
      .first();
    expect(transaction.phase).toBe('confirmed');
  });

  // æµ‹è¯•6: cancelå¹‚ç­‰æ€§
  it('é‡å¤cancelåº”è¯¥æ˜¯å¹‚ç­‰çš„', async () => {
    await quotaService.reserve(userId, taskId, 1);
    await quotaService.cancel(taskId);
    await quotaService.cancel(taskId); // ç¬¬äºŒæ¬¡è°ƒç”¨

    // éªŒè¯é…é¢åªé€€è¿˜ä¸€æ¬¡
    const user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(10);
  });

  // æµ‹è¯•7: å¹¶å‘reserve
  it('å¹¶å‘reserveåº”è¯¥ä¸ä¼šè¶…å–', async () => {
    const taskIds = Array.from({ length: 15 }, () => uuid().replace(/-/g, ''));

    // å¹¶å‘é¢„ç•™15æ¬¡ï¼ˆä½†ç”¨æˆ·åªæœ‰10ä¸ªé…é¢ï¼‰
    const promises = taskIds.map((id) =>
      quotaService.reserve(userId, id, 1).catch(() => null)
    );

    await Promise.all(promises);

    // éªŒè¯åªæœ‰10æ¬¡æˆåŠŸ
    const transactions = await db('quota_transactions')
      .where({ user_id: userId, phase: 'reserved' });
    expect(transactions.length).toBeLessThanOrEqual(10);

    // éªŒè¯é…é¢ä¸º0
    const user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(0);
  });
});
```

**è¿è¡Œæµ‹è¯•**:
```bash
npm test quota.service.spec.ts
```

**Gitæäº¤**:
```bash
git add backend/tests/services/quota.service.spec.ts
git commit -m "test(quota): æ·»åŠ QuotaServiceå•å…ƒæµ‹è¯•

- æµ‹è¯•reserve/confirm/cancelæ­£å¸¸æµç¨‹
- æµ‹è¯•å¹‚ç­‰æ€§
- æµ‹è¯•å¹¶å‘åœºæ™¯
- æµ‹è¯•è¦†ç›–ç‡ï¼š87%

Refs: #P0-001"
git push origin feature/P0-001-saga-quota
```

---

### ä»»åŠ¡8: åˆ›å»ºé…é¢Sagaé›†æˆæµ‹è¯•ï¼ˆ1å°æ—¶ï¼‰

**æ–‡ä»¶**: `backend/tests/integration/quota-saga.spec.ts`

**å®Œæ•´ä»£ç **:
```typescript
import taskService from '../../src/services/task.service';
import pipelineEngine from '../../src/services/pipelineEngine.service';
import db from '../../src/db';
import { v4 as uuid } from 'uuid';

describe('é…é¢Sagaé›†æˆæµ‹è¯•', () => {
  let userId: string;

  beforeEach(async () => {
    userId = uuid().replace(/-/g, '');
    await db('users').insert({
      id: userId,
      phone: '13800138000',
      quota_remaining: 10,
      role: 'user',
      created_at: db.fn.now(),
    });
  });

  afterEach(async () => {
    await db('quota_transactions').where({ user_id: userId }).del();
    await db('tasks').where({ user_id: userId }).del();
    await db('users').where({ id: userId }).del();
  });

  // æµ‹è¯•1: ç«¯åˆ°ç«¯æˆåŠŸæµç¨‹
  it('åˆ›å»ºä»»åŠ¡ â†’ PipelineæˆåŠŸ â†’ é…é¢confirm', async () => {
    // 1. åˆ›å»ºä»»åŠ¡ï¼ˆreserveé…é¢ï¼‰
    const taskId = await taskService.createTask(userId, 'feature-1', {});

    // éªŒè¯é…é¢å·²é¢„ç•™
    let user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(9);

    // 2. æ‰§è¡ŒPipelineï¼ˆæ¨¡æ‹ŸæˆåŠŸï¼‰
    await pipelineEngine.executePipeline(taskId, 'feature-1', {});

    // 3. éªŒè¯é…é¢å·²ç¡®è®¤
    const transaction = await db('quota_transactions')
      .where({ task_id: taskId })
      .first();
    expect(transaction.phase).toBe('confirmed');

    // éªŒè¯é…é¢ä»ä¸º9
    user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(9);
  });

  // æµ‹è¯•2: ç«¯åˆ°ç«¯å¤±è´¥æµç¨‹
  it('åˆ›å»ºä»»åŠ¡ â†’ Pipelineå¤±è´¥ â†’ é…é¢cancel', async () => {
    // 1. åˆ›å»ºä»»åŠ¡ï¼ˆreserveé…é¢ï¼‰
    const taskId = await taskService.createTask(userId, 'feature-1', {});

    // éªŒè¯é…é¢å·²é¢„ç•™
    let user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(9);

    // 2. æ‰§è¡ŒPipelineï¼ˆæ¨¡æ‹Ÿå¤±è´¥ï¼‰
    try {
      await pipelineEngine.executePipeline(taskId, 'invalid-feature', {});
    } catch (error) {
      // é¢„æœŸä¼šå¤±è´¥
    }

    // 3. éªŒè¯é…é¢å·²å–æ¶ˆ
    const transaction = await db('quota_transactions')
      .where({ task_id: taskId })
      .first();
    expect(transaction.phase).toBe('cancelled');

    // éªŒè¯é…é¢å·²é€€è¿˜ä¸º10
    user = await db('users').where({ id: userId }).first();
    expect(user.quota_remaining).toBe(10);
  });
});
```

**Gitæäº¤**:
```bash
git add backend/tests/integration/quota-saga.spec.ts
git commit -m "test(quota): æ·»åŠ é…é¢Sagaé›†æˆæµ‹è¯•

- æµ‹è¯•ç«¯åˆ°ç«¯æˆåŠŸæµç¨‹
- æµ‹è¯•ç«¯åˆ°ç«¯å¤±è´¥æµç¨‹
- éªŒè¯é…é¢æ­£ç¡®å›æ»š

Refs: #P0-001"
git push origin feature/P0-001-saga-quota
```

---

## ğŸ“ æäº¤Pull Request

### PRæ ‡é¢˜
```
[P0-001] Sagaæ¨¡å¼é…é¢ç®¡ç†
```

### PRæè¿°ï¼ˆå¤åˆ¶æ¨¡æ¿ï¼‰
```markdown
## [P0-001] Sagaæ¨¡å¼é…é¢ç®¡ç†

### ä»»åŠ¡æè¿°
å®ç°Sagaæ¨¡å¼é…é¢ç®¡ç†ï¼Œè§£å†³Pipelineæ‰§è¡Œå¤±è´¥æ—¶é…é¢æ— æ³•å›æ»šçš„é—®é¢˜ã€‚

### å®Œæˆçš„å·¥ä½œ
- [x] åˆ›å»º`quota_transactions`è¡¨ï¼ˆè¿ç§»æ–‡ä»¶ï¼‰
- [x] å®ç°`QuotaService.reserve()`æ–¹æ³•ï¼ˆé¢„ç•™é…é¢ï¼‰
- [x] å®ç°`QuotaService.confirm()`æ–¹æ³•ï¼ˆç¡®è®¤æ‰£å‡ï¼‰
- [x] å®ç°`QuotaService.cancel()`æ–¹æ³•ï¼ˆé€€è¿˜é…é¢ï¼‰
- [x] é›†æˆåˆ°`TaskService`ï¼ˆåˆ›å»ºä»»åŠ¡æ—¶è°ƒç”¨reserveï¼‰
- [x] é›†æˆåˆ°`PipelineEngine`ï¼ˆæˆåŠŸ/å¤±è´¥è°ƒç”¨confirm/cancelï¼‰
- [x] å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡87%ï¼‰
- [x] é›†æˆæµ‹è¯•ï¼ˆç«¯åˆ°ç«¯æµ‹è¯•ï¼‰

### å…³é”®æŠ€æœ¯ç‚¹
- ä½¿ç”¨Knexäº‹åŠ¡ç¡®ä¿åŸå­æ€§
- ä½¿ç”¨forUpdate()è¡Œçº§é”é˜²æ­¢å¹¶å‘è¶…å–
- å¹‚ç­‰æ€§è®¾è®¡ï¼šåŒä¸€taskIdçš„confirm/cancelåªæ‰§è¡Œä¸€æ¬¡
- ä¸‰é˜¶æ®µçŠ¶æ€ç®¡ç†ï¼šreserved â†’ confirmed | cancelled

### æ•°æ®åº“å˜æ›´
- æ–°å¢è¡¨ï¼š`quota_transactions`
- è¿ç§»è„šæœ¬ï¼š`backend/src/db/migrations/20250102000001_create_quota_transactions.ts`

### æµ‹è¯•ç»“æœ
- å•å…ƒæµ‹è¯•ï¼šâœ… é€šè¿‡ï¼ˆ7ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- é›†æˆæµ‹è¯•ï¼šâœ… é€šè¿‡ï¼ˆ2ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- æµ‹è¯•è¦†ç›–ç‡ï¼šâœ… 87%

### éªŒæ”¶æ ‡å‡†
- [x] Pipelineæ‰§è¡Œå¤±è´¥æ—¶ï¼Œé…é¢èƒ½æ­£ç¡®é€€è¿˜
- [x] é‡å¤confirm/cancelä¸ä¼šé‡å¤æ“ä½œï¼ˆå¹‚ç­‰æ€§ï¼‰
- [x] å¹¶å‘åœºæ™¯ä¸‹ä¸ä¼šè¶…å–é…é¢
- [x] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥85%

### Revieweræ£€æŸ¥æ¸…å•
- [ ] äº‹åŠ¡ä½¿ç”¨æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] forUpdateé”æ˜¯å¦æ­£ç¡®ä½¿ç”¨ï¼Ÿ
- [ ] å¹‚ç­‰æ€§è®¾è®¡æ˜¯å¦å®Œå–„ï¼Ÿ
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„ï¼Ÿ
- [ ] æµ‹è¯•ç”¨ä¾‹æ˜¯å¦å……åˆ†ï¼Ÿ

### å‚è€ƒæ–‡æ¡£
- ä»»åŠ¡å¡ï¼š`tasks/backend-refactor/P0-001-å¼€å‘æ£€æŸ¥æ¸…å•.md`
- æŠ€æœ¯æ–¹æ¡ˆï¼š`docs/åç«¯æ¶æ„é—®é¢˜è§£å†³å›ç­”` ç¬¬4èŠ‚
```

---

## â±ï¸ é¢„ä¼°å·¥æ—¶åˆ†è§£

| æ­¥éª¤ | é¢„ä¼°æ—¶é—´ | å®é™…æ—¶é—´ |
|------|---------|---------|
| ç¬¬0æ­¥ï¼šåˆ›å»ºåˆ†æ”¯ | 5åˆ†é’Ÿ | |
| ç¬¬1æ­¥ï¼šé˜…è¯»æ–¹æ¡ˆ | 30åˆ†é’Ÿ | |
| ç¬¬2æ­¥ï¼šç¯å¢ƒæ£€æŸ¥ | 10åˆ†é’Ÿ | |
| ä»»åŠ¡1ï¼šæ•°æ®åº“è¿ç§» | 30åˆ†é’Ÿ | |
| ä»»åŠ¡2ï¼šreserveæ–¹æ³• | 1å°æ—¶ | |
| ä»»åŠ¡3ï¼šconfirmæ–¹æ³• | 30åˆ†é’Ÿ | |
| ä»»åŠ¡4ï¼šcancelæ–¹æ³• | 1å°æ—¶ | |
| ä»»åŠ¡5ï¼šTaskServiceé›†æˆ | 30åˆ†é’Ÿ | |
| ä»»åŠ¡6ï¼šPipelineEngineé›†æˆ | 30åˆ†é’Ÿ | |
| ä»»åŠ¡7ï¼šå•å…ƒæµ‹è¯• | 2å°æ—¶ | |
| ä»»åŠ¡8ï¼šé›†æˆæµ‹è¯• | 1å°æ—¶ | |
| æäº¤PR | 30åˆ†é’Ÿ | |
| ä¿®å¤Reviewé—®é¢˜ | 1-2å°æ—¶ | |
| **æ€»è®¡** | **9-10å°æ—¶** | |

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: forUpdateé”æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨ï¼Ÿ

**A**: forUpdateæ˜¯æ•°æ®åº“çš„è¡Œçº§é”ï¼Œç”¨äºé˜²æ­¢å¹¶å‘è¶…å–ã€‚

**ç¤ºä¾‹**:
```typescript
// ä¸ä½¿ç”¨forUpdateï¼ˆé”™è¯¯ï¼‰
const user = await db('users').where({ id: userId }).first();
// æ­¤æ—¶å¦ä¸€ä¸ªè¯·æ±‚ä¹Ÿè¯»åˆ°äº†åŒæ ·çš„é…é¢æ•°é‡

// ä½¿ç”¨forUpdateï¼ˆæ­£ç¡®ï¼‰
const user = await db('users').where({ id: userId }).forUpdate().first();
// æ­¤æ—¶å…¶ä»–è¯·æ±‚å¿…é¡»ç­‰å¾…è¿™ä¸ªäº‹åŠ¡å®Œæˆ
```

### Q2: ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼Ÿ

**A**: å¹‚ç­‰æ€§æ˜¯æŒ‡å¤šæ¬¡æ‰§è¡ŒåŒä¸€æ“ä½œï¼Œç»“æœä¸æ‰§è¡Œä¸€æ¬¡ç›¸åŒã€‚

**ç¤ºä¾‹**:
```typescript
// ç¬¬ä¸€æ¬¡è°ƒç”¨confirm
await quotaService.confirm(taskId); // phase: reserved â†’ confirmed

// ç¬¬äºŒæ¬¡è°ƒç”¨confirmï¼ˆå¹‚ç­‰æ€§ï¼‰
await quotaService.confirm(taskId); // phaseä»ä¸ºconfirmedï¼Œä¸ä¼šé‡å¤æ“ä½œ
```

### Q3: ä¸ºä»€ä¹ˆè¦ç”¨äº‹åŠ¡ï¼Ÿ

**A**: äº‹åŠ¡ç¡®ä¿å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

**ç¤ºä¾‹**:
```typescript
return db.transaction(async (trx) => {
  await trx('users').update(...);        // æ“ä½œ1
  await trx('quota_transactions').insert(...); // æ“ä½œ2
  // å¦‚æœæ“ä½œ2å¤±è´¥ï¼Œæ“ä½œ1ä¼šè‡ªåŠ¨å›æ»š
});
```

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

å®ŒæˆP0-001åï¼Œå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ ‡å‡†ï¼š

- [ ] Pipelineæ‰§è¡Œå¤±è´¥æ—¶ï¼Œé…é¢èƒ½æ­£ç¡®é€€è¿˜
- [ ] é‡å¤confirm/cancelä¸ä¼šé‡å¤æ“ä½œï¼ˆå¹‚ç­‰æ€§ï¼‰
- [ ] å¹¶å‘åœºæ™¯ä¸‹ä¸ä¼šè¶…å–é…é¢
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥85%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] ä»£ç é€šè¿‡ESLintæ£€æŸ¥
- [ ] PRå·²æäº¤å¹¶ç­‰å¾…Code Review

---

**åˆ¶å®šäºº**: è€ç‹
**åˆ¶å®šæ—¥æœŸ**: 2025-11-02
**çŠ¶æ€**: å°±ç»ªï¼Œéšæ—¶å¯ä»¥å¼€å§‹ï¼

**è‰¹ï¼è¿™ä¸ªå¿«é€Ÿå¯åŠ¨æŒ‡å—å¤Ÿè¯¦ç»†äº†å§ï¼Ÿç…§ç€è¿™ä¸ªå¹²ï¼Œ10å°æ—¶å†…è‚¯å®šèƒ½æå®šP0-001ï¼ğŸ’ª**
